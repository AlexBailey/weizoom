{% extends "content_base_v2.html" %}
{% load staticfiles %}
{% load project_filter %}
{% load account_filter %}


{% block content-panel %}
<div class="xui-editProductPage">
	<ul class="breadcrumb" style="margin-bottom:-12px;">
		<li>您当前所在位置</li>
		<li>
			<a href="/mall/onshelf_products/get/">商品管理</a>
		</li>
		<li class="active">{% if product %}更新{% else %}添加新{% endif %}商品</li>
	</ul>

	<form class="form-horizontal xui-mall-addProductForm xa-addProductForm" method="post" id="editForm" data-id="{% if product %}{{ product.id }}{% else %}0{% endif %}">
		<section>
		<header>
			<span class="xui-fontBold">基本信息</span>
			<span class="xui-fontGary">
				( <i class="star_show pl5"></i>
				表示必填)
			</span>
		</header>
		<fieldset >
			<legend>基本内容</legend>
			<div class="form-group ">
				<label class="control-label fl star_show" for="goodsname">商品名称：</label>
				<div class="fl">
					<input type="text" class="form-control w490 mr20 ml5" id="name" name="name" 
                           placeholder="" 
                           value="{% if product %}{{ product.name }}{% endif %}" 
                           data-validate="require-notempty" 
                           maxlength="20"/>
					<div class="errorHint" data-error-hint="请输入商品名称， 不超过20个汉字"></div>
				</div>
				<p>
					还可以输入
					<span style="color:#1F9200;">20</span>
					个字
				</p>
			</div>

			<div class="form-group ">
				<label class="control-label fl" for="promotion_title">促销标题：</label>
				<div class="fl">
					<input type="text" class="form-control w490 mr20 ml5" id="promotion_title" name="promotion_title" placeholder="" value="{% if product %}{{ product.promotion_title }}{% endif %}" maxlength="20"/>
					<div class="errorHint"></div>
				</div>
				<p>
					还可以输入
					<span style="color:#1F9200;">20</span>
					个字
				</p>
			</div>

			<div class="form-group ">
				<label class="control-label fl" for="product_category">店内分组：</label>
				<div class="fl ml5 w700">
					{% for category in categories %}
					<label class="xui-category checkbox-inline">
						<input
							type="checkbox"
							value="{{ category.id }}"
							class="xa-product_category  mr20"
							{% ifequal category.is_selected 1 %}checked="checked"{% endifequal %}
						/>
						{{ category.name }}
					</label>
					{% endfor %}
					<input type="hidden" id="product_category" name="product_category" value="" />
					<div class="errorHint"></div>
				</div>
			</div>
			<div class="form-group nostar ">
				<label class="control-label fl" for="bar_code">商品条码：</label>
				<div class="col-sm-2 fl pl5">
					<input type="text" class="form-control w106" id="bar_code" name="bar_code" placeholder="" value="{% if product %}{{ product.bar_code }}{% endif %}" maxlength="15" data-validate="require-custom-function" data-validate-function="validateBarCode"/>
					<div class="errorHint"></div>
				</div>
			</div>
			{%if not request.manager.is_weizoom_mall%}
			<div class="form-group nostar ">
				<label class="control-label fl" for="bar_code">同步到微众商城：</label>
				<div class="fl w700">
					<label><input name="weshop_sync" value="0" class="ml5 mr5" type="radio"{%if product.weshop_sync == 0%} checked{%endif%}{%if product.weshop_status%} disabled{%endif%}/>不同步</label>
					<label><input name="weshop_sync" value="1" class="ml5 mr5" type="radio"{%if product.weshop_sync == 1 or not product%} checked{%endif%}{%if product.weshop_status%} disabled{%endif%}/>同步</label>
					<label><input name="weshop_sync" value="2" class="ml5 mr5" type="radio"{%if product.weshop_sync == 2%} checked{%endif%}{%if product.weshop_status%} disabled{%endif%}/>加价同步</label>
					<span class="xui-fontGary">（同步后，微众商城将加价10%，有助于从微众商城引流到本店）</span>
					<div class="errorHint"></div>
				</div>
			</div>
			{%endif%}
		</fieldset>

		<fieldset>
			<input type="hidden" name="customModels" value="" />
			<div
				data-ui-role="mall-product-custom-model-editor"
				data-use-custom-model="{% if product.is_use_custom_model %}true{% else %}false{% endif %}"
				data-models='{% if product %}{{product.models|format_json|safe}}{% else %}[]{% endif %}'
				data-title="商品信息"
				data-custom-properties='{% if product %}{{product.system_model_properties|format_json|safe}}{% else %}[]{% endif %}'
				data-validate="require-custom-function"
				data-validate-function="checkProductModel"
				data-product-type="object"
			></div>
			<div class="errorHint pr" style="left:24px;top:-10px;"></div>
		</fieldset>

		<fieldset>
			<legend>图片管理</legend>
			<div class="form-group">
				<label class="control-label col-sm-2 col-sm-offset-1 star_show" for="swipe_images">商品图片：</label>
				<div id="imgSelect" class="col-sm-9">
                    <input id="swipe_images" name="swipe_images" type='hidden'
                    data-force-validate="true"
                    data-validate="require-string::请至少添加一张图片"
                    data-min-length="3"/>
					<ul class="xui-i-images clearfix">
						{% for image in product.swipe_images %}
						<li class="pr xui-i-image xa-image" data-image-id="{{image.id}}" data-width="{{image.width}}" data-height="{{image.height}}">
							<img class="imgexist" src="{{image.url}}" />
							<button class="xui-close xa-deleteImage" type="button">
								<span>&times;</span>
							</button>
						</li>
						{% endfor %}
						<li class="xui-i-image xa-selectImage">
                        <img src="/static_v2/img/editor/addProduct.png"/>
						</li>
					</ul>
                    <div class="errorHint mt5"></div>
				</div>
				<div style="padding-top:0px;padding-left:215px;clear:both; line-height:40px;">建议图片尺寸为640*640像素</div>
			</div>
		</fieldset>

		<fieldset>
			<legend>运费及支付</legend>
			<div class="form-group">
				<label class="control-label col-sm-2 col-sm-offset-1 star_show">运费设置：</label>
				<div id="freight"  class="col-sm-9">
				{% if request.manager.id == product.owner.id or not product %}
					<label id="unified_freight" class="radio" >
	             		<input type='radio'	class="xui-inlineblock xa-freight"	name='postage_type'
	             			   {% if not postage_config_info.is_use_system_postage_config %}checked="checked"{% endif %}
	             			   value="unified_postage_type"
	             		/>
                        <span class="xui-bold">统一运费：￥</span>
                        <input type='text' name="unified_postage_money"
                               value='{% if product %}{{product.unified_postage_money}}{% endif %}' 
                               style="width: 80px;" class="form-control xui-inlineblock xa-unifiedPostageInput"
                               placeholder="0.0"
                        />
                        <span>元</span>
                        <div id="unified_postage_error" class="errorHint" data-error-hint="请输正确的价格"></div>
	         		</label>

					<label id="custom_freight" class="radio xa-customPostageSelectorLabel">
	             		<input type='radio'	class="xui-inlineblock xa-freight"	name='postage_type'
                   			   {% if postage_config_info.is_use_system_postage_config %}checked="checked"{% endif %}
                               value="custom_postage_type"
	             	    />
                        <span class="xui-bold">使用系统运费模板：</span>
                        {{postage_config_info.system_postage_config.name}}
                        <a class="ml5" href="/mall/postage_templates/get/" target="_blank">新建运费模板</a>
	         		</label>
				{%else%}
					<label id="unified_freight" class="radio" >包邮</label>
				{%endif%}
				</div>
			</div>

			<div class="form-group">
				<label class="control-label col-sm-2 col-sm-offset-1 star_show">支付方式：</label>
				<div id="pay-method" class="col-sm-9" data-validate='require-custom-function' data-validate-function='validatePay'>
				{% if request.manager.id == product.owner.id or not product %}
					<label class="checkbox xa-pay-method" >
                    {% if pay_interface_config.online_pay_interfaces %}
	             		<input type='checkbox' id='is_enable_online_pay_interface' 
                               name='is_enable_online_pay_interface' 
                               checked="checked"
                               class="xa-pay-selected"
                               disabled
	             			   value="1" 
                         />
                         <p class="xui-bold">在线支付</p>
                        {% for pay_interface in pay_interface_config.online_pay_interfaces %}
                        <p class="tx-pay-interface-item-p">{{ pay_interface.name }}</p>
                        {% endfor %}
                    {% else %}
	             		<input type='checkbox' id='is_enable_online_pay_interface' 
                               name='is_enable_online_pay_interface' 
                               class="xa-pay-selected"
                               {% if request.manager.id == 216 %}
                               checked="checked"
                               {% endif %}
                               disabled
	             			   value="1" 
                         />
                        <p class="xui-bold">在线支付</p>
                        <p class="tx-pay-interface-item-p">当前没有启用在线支付接口，请前往<a href="/mall/pay_interfaces/get/" target="_blank">启用在线支付接口</a></p>
                    {% endif %}
	         		</label>

					<label class="checkbox inline tx-checkbox-item xa-pay-method" >
	             		<input
	             			type='checkbox'
	             			id='is_enable_cod_pay_interface'
	             			name='is_enable_cod_pay_interface'
                            class="xa-pay-selected"
	             			value="1"
	             			{% if product.is_use_cod_pay_interface %}checked="checked"{% endif %}
	             			{% if not pay_interface_config.is_enable_cod_pay_interface %}disabled{% endif %}/> <p class="xui-bold">
	             			货到付款</p>

	             		{% if pay_interface_config.is_enable_cod_pay_interface %}
	             		<p class="tx-pay-interface-item-p">启用后买家可选择货到付款下单，您需自行通过合作快速安排配送。买家开箱验货无误后，快递公司向买家收款并与您结算费用。</p>
	             		{% else %}
	             		<p class="tx-pay-interface-item-p">当前没有启用货到付款，请前往<a href="/mall/pay_interfaces/get/" target="_blank">启用货到付款</a></p>
	             		{% endif %}
	         		</label>
	         		 <div class="errorHint" date-error-Hint="请至少输入一种支付方式"></div>
	         	{%else%}
	         		<label class="checkbox xa-pay-method">在线支付</label>
	         	{%endif%}
				</div>
               
			</div>
		</fieldset>
	</section>

	<section>
		<header>
			<span  class="xui-fontBold">商品属性</span>
			{% if not property_templates %}
				<span style="padding-left:18px;">您还没有配置属性模板，可以前往<a href="/mall/property_templates/get/" target="_blank">配置属性模板</a></span>
			{% else %}
			<select class="ml20 xa-propertyTemplateSelector">
				<option value="-1">选择属性模板</option>
				{% for property_template in property_templates %}
				<option value="{{property_template.id}}">{{property_template.name}}</option>
				{% endfor %}
			</select>
			{% endif %}
		</header>
		<input type="hidden" name="properties" />
		<div class="xa-properties mt10">
          <div class="xui-i-templateProperties">
              <div class='xa-customProperties'>
                <ul class="xui-clearListStyle clearfix">
                    {% for property in product.properties %}
                    <li class="xui-i-templateProperty xa-property pb10" data-property-id="{{property.id}}">
                        <input class="xui-i-propertyName xui-propertyNameBtn xa-name" readonly=true value='{{property.name}}' maxlength="15">
                        <input class="xui-i-propertyValue xui-propertyValueInput xa-contenteditable xa-value" value='{{property.value}}' maxlength="255">
                        <a class="xa-deleteProperty">删除</a>
                    </li>
                    {% endfor %}
                    <div class="errorHint"></div>
                </ul>
              </div>
              <div class="xa-instantProperties">
                <a href="javascript:void(0);" class="xa-addProperty xui-i-propertyName xui-propertyNameBtn pb15" style="display:block;margin-left:10px;width:55px;">+添加</a>
              </div>
	      </div>
		</div>
	</section>

	<section >
		<header class="xui-fontBold">商品描述</header>
		<div class="form-group">
			<label class="control-label col-sm-1" for="detail"></label>
			<div class="ml100" >
				<textarea class="xui-hide" id="detail" name="detail" data-ui-role="richtext-editor" data-type="full" data-height="300" data-width="650">
					{% if product %}{{ product.detail|format_emotion|safe }}{% endif %}
				</textarea>
			</div>
		</div>
	</section>

	<section style="background:#FEFEFE;border:0; ">
		<div class="form-group" style="height:106px;">
<!-- 			<label class="control-label col-sm-2"></label> -->
			<div class="ml100">
				<div class="xui-fontGary" style="line-height:48px;">创建好的商品会显示在待售列表中，需要您手动上架销售。</div>
				<div>
					{% if request.manager.id == product.owner.id or not product %}
					<input type="submit" class="btn btn-primary mr40" id="submitBtn" value="保存" />
					{% else %}
					{% if request.GET.source == 'onshelf' %}
					<input type="button" onclick="history.go(-1)" class="btn btn-primary mr40 xa-weshop" value="返回" />
					{% else %}
					<input type="button" class="btn btn-primary mr40 xa-check xa-weshop" value="审核上架" />
					{% endif %}
					{% endif %}
					<!--
					<input type="button" class="btn btn-success" value="预览" />
					-->
				</div>
			</div>
		</div>
	</section>
</form>
</div>
{% endblock %}
{% block js %}
<!--    运费验证实现    -->
<script type="text/javascript">
$('.xa-freight').on('click', function(e){
    var $el = $(e.target); 
    var $_parent = $el.parents("#freight"); 
    var $unified = $_parent.find("#unified_freight");
    var $unified_input = $_parent.find('input[name="unified_postage_money"]'); 
    var $unified_error = $_parent.find("#unified_postage_error");

    var $custom = $_parent.find("#custom_freight");
    var $custom_input = $_parent.find('select[name="postage_config_id"]'); 
    var $custom_error = $_parent.find("#custom_postage_error");
    var value = $el.attr('value'); 

    // Initial 
    $custom_input.removeAttr('data-validate');
    $custom_error.hide();
    $unified_input.removeAttr('data-validate');
    $unified_error.hide();
    if(value === 'unified_postage_type'){  // 统一运费验证 
        // 去掉运费模板验证 
        $custom_input.removeAttr('data-validate'); 
        $custom_error.hide();

        // 添加统一运费验证 
        $unified_input.attr('data-validate', 'require-price'); 
        // $unified.append('<label id="unified_postage_error" class="errorHint" data-error-hint="请输入价格， 精确到小数点后两位"></label>');
        $unified_error.show();
    }else if(value === 'custom_postage_type'){  // 运费模板验证 
        // 去掉统一运费验证 
        $unified.removeClass('has-error');
        $unified_input.removeAttr('data-validate'); 
        $unified_error.hide();

        // 添加运费模板验证 
        $custom_input.attr('data-validate', 'require-nonnegative');
        // $custom.append('<label id="custom_postage_error" class="errorHint" data-error-hint="请选择运费模板"></label>');
        $custom_error.show();
    }

});
{% if request.manager.id != product.owner.id and product %}
$('.xa-check').on('click', function(){
	W.getApi().call({
        method: 'post',
        app: 'mall',
        api: 'product_shelve_type/update',
        args: {
            id: {{product.id}},
            shelve_type: 1
        },
        scope: this,
        success: function(data) {
        	W.showHint('success', '审核成功');
        	history.go(-1)
        }
    })
});
setTimeout(function(){$('input').not('.xa-weshop').attr('disabled','1');}, 500)
$('.xa-addProperty').click(function(){return false;})
$('.xa-selectImage').click(function(){return false;})
{% endif %}
</script>
<!--   / 运费验证实现    -->

<script type="text/javascript">
	window.checkProductModel = function($el) {
		if ($('.xa-useCustomModel').is(':checked')) {
			var $trs = $el.find('tbody tr');
			if ($trs.length === 0) {
				return {
					isValidate: false,
					errorHint: '请添加规格值'
				}
			}
		}
		return {
			isValidate: true,
			errorHint: ''
		}
	}
	$(document).ready(function() {
		var view = new W.view.mall.ProductEditor({
			el: '.xui-editProductPage'
		});
		view.render();
		// 隐藏定制规格
		if(location.search.indexOf('no_custom_model=1')>0){
			$('[data-ui-role="mall-product-custom-model-editor"] legend div').hide();
		}
	});
</script>

<script type="text/javascript">
function validatePay($el){
    var is_selected = false;
    $el.find('.xa-pay-selected').each(function(i){
        is_selected = is_selected | $(this).prop('checked');
    });
    console.log("validatePay", is_selected);
    var isValidate = is_selected;
    return {
        isValidate: isValidate,
        errorHint: "请至少选择一种支付方式"
    }
}

</script>

<!--	商品条码验证	-->
<script type="text/javascript">
function validateBarCode($el){
  var hasValue= $.trim($el.val());
  if(!hasValue){
	return{
	  isValidate: true,
	  errorHint: ''
	}
  }else{
	var valueRex = /^\d+$/g;
	return {
	  isValidate: valueRex.test(hasValue),
	  errorHint: "请输入数字"
	}
  }
}
function validateUserCode($el){
  var hasValue= $.trim($el.val());
  if(!hasValue){
	return{
	  isValidate: true,
	  errorHint: ''
	}
  }else{
	var valueRex = /^\w+$/g;
	return {
	  isValidate: valueRex.test(hasValue),
	  errorHint: "请输入数字或字母"
	}
  }
}
</script>
<!--	/商品条码验证	-->
{% endblock %}
