{% extends "content_base_v2.html" %}

{% block content-panel %}
<div class="xui-categoryPage">
	<ul class="breadcrumb">
		<li>您当前所在位置</li>
		<li><a href="/mall2/product_list/?shelve_type=1">商品管理</a></li>
		<li><a href="/mall2/category_list/">分组管理</a></li>
		<li class="active">编辑分组</li>
	</ul>

	<div class="input-group mt20 xui-i-name ">
		<span class="input-group-addon">分组名称:</span>
		<input type="text" class="form-control xa-name">
		<span class="input-group-addon">(20字以内)</span>
	</div>

	<div class="panel panel-default mt20 xb-rightPanel">
		<div class="panel-heading ">
			<label for="topSelectAll" class="xui-selectAll ml15">
				<input type="checkbox" id="topSelectAll" class="xa-selectAll">全选
			</label>
			<a href="javascript:void(0);" class="btn btn-default ml10 xa-batchOffshelf">批量修改</a>
		</div>
		<div id="categories-list-view"
			data-ui-role="advanced-table"
			data-app="mall2"
			data-api="category"
			data-selectable="true"
			 data-args='{"category_id":"{{category_id}}"}'
			data-template-id="#category-view"
			data-enable-paginator="false"></div>
		<div class="xui-btn-group text-center">
			<a class="btn btn-default xui-fontBold xa-editCategory" href="javascript:void(0);"
			   data-id="${}">添加</a>
			<a class="btn btn-primary mr40  xui-fontBold xa-save" href="javascript:void(0);">保存</a>
		</div>
	</div>

</div>
{% endblock %}
{% block js %}
{% verbatim %}
<script id="category-view" type="text/x-jquery-tmpl">
	<table class="table  mt20  table-bordered">
		<thead>
			<tr>
				<th width="315" class="xui-i-product-name">商品名称</th>
				<th width="120">所属分组</th>
				<th width="110">商品价格（元）</th>
				<th width="80">状态</th>
				<th width="75">排序</th>
				<th width="75">销量</th>
				<th width="110">加入分组时间</th>

				<th>操作</th>
			</tr>
		</thead>
		<tbody>
			{{each(i, product) items}}
			<tr data-product-id="${product.id}" {% if product.status == '待售' %}class="xui-color-mark"{% endif %}>
				<td width="315" class="xui-i-product-name">${product.name}</td>
				<td width="120">
				<span class="label label-default cursor-pointer xa-edit-product-category" style="color:#c5c5c5">更多 (6) </span>
					{{if product.categories && product.categories.length > 0}}
						<div>
							${product.categories[0].name}
						</div
						{{ if product.categories.length >1}}
							<div>
							<a class="btn btn-default" data-product-id="${product.id}">更多 ( ${product.categories.length} ) </a>
							</div>
						{{ /if}}
					{{/if}}

				</td>
				<td width="110">${product.display_price}</td>
				<td width="80">${product.status}</td>
				<td width="75" class="xui-i-disaplay-index">
					{{if product.status == '在售'}}
						<input autocomplete="off" width="38" type="text" class="xa-rank" data-id="${product.id}" style="width:100%;"
									 value="${product.display_index}" data-display-index="${product.display_index}">
					{{/if}}
				</td>
				<td width="75">${product.sales}</td>
				<td width="110">${product.join_category_time}</td>
				<td><a class="xa-deleteProductFromCategory" href="javascript:void(0);">删除</a></td>
			</tr>
			{{/each}}
		</tbody>
	</table>
</script>
{% endverbatim %}
<script type="text/javascript">
	$(document).ready(function () {
		var categoryId = "{{category_id}}";
		$(document).ajaxSuccess(function (event, jqXHR,ajaxOptions, data) {
			if(ajaxOptions.type == 'GET' && /api\/category/.test(ajaxOptions.url) && data.success){
				// after load
				$('.xa-name').val(data.data.name);
			}
		});

		$(document).delegate('.xa-editCategory', 'click', function (event) {
			var $table =  $('#categories-list-view table');
			var title = $('.xa-name').val();
			W.dialog.showDialog('W.dialog.mall.AddProductCategoryDialog', {
				canEditTitle: true,
				title: title,
				categoryId: categoryId,
				success: function (data) {
					W.getApi().call({
						method: 'post',
						app: 'mall2',
						resource: 'category',
						args: _.extend(data, {
							id: categoryId
						}),
						success: function (data) {
							this.table = this.$('[data-ui-role="advanced-table"]').data('view');
							this.table.reload();
						},
						error: function (resp) {
							W.showHint('error', resp.data.msg);
						}
					})
				}
			})
		});

		$(document).delegate('.xa-deleteProductFromCategory', 'click', function (event) {
			var $link = $(event.currentTarget);
			var productId = $link.parents('tr').data('productId');

			W.requireConfirm({
				$el: $(this),
				width: 380,
				position: 'top',
				isTitle: false,
				privateContainerClass: 'xui-orderConfirmPop',
				msg: '确定删除？',
				confirm: function () {
					W.getApi().call({
						method: 'delete',
						app: 'mall2',
						resource: 'category',
						args: {
							category_id: categoryId,
							product_id: productId
						},
						success: function (data) {
							this.table = this.$('[data-ui-role="advanced-table"]').data('view');
							this.table.reload();
						},
						error: function (resp) {
							W.showHint('error', '删除分组失败');
						}
					});
				}
			})
		});

		var onConfirmRankInput = function (event) {
			var $link = $(event.currentTarget);
			var product_id = $(event.currentTarget).parents('tr').data('product-id');
			var rankText = $.trim($(event.currentTarget).val());
			/*文本框的值*/
			var oldPos = $.trim($(event.currentTarget).data('display-index'));
			var updateAction = function () {
				try {
					has_index.val('0').data('display-index', 0);
				}
				catch (e) {
				}
				finally {
					W.getApi().call({
						method: 'post',
						app: 'mall2',
						resource: 'category_list',
						args: {
							category_id: categoryId,
							product_id: product_id,
							position: rankText,
						},
						success: function (data) {
							$(event.currentTarget).data('display-index', rankText).val(rankText);
						},
						error: function (response) {
							W.showHint('error', '更新产品位置失效');
						}

					});
				}
			}
			var has_index = false
			var rankTextList = $(event.currentTarget).parents('tr').siblings().find('.xa-rank').each(function (i) {
				var a_rank = $.trim($(this).data('display-index'));
				if (rankText == a_rank && rankText != 0) {
					has_index = $(this);
				}
			});
			var cancel = function () {
				$(event.currentTarget).val(oldPos);
			}
			if (has_index) {
				var msg = "位置" + rankText + "已存在商品， 是否替换"
				W.requireConfirm({
					$el: $link,
					width: 480,
					height: 55,
					position: 'top',
					isTitle: false,
					msg: msg,
					confirm: updateAction,
					cancel: cancel,
					minClickTime: 1
				});
			} else {
				updateAction();
			}
		}

		$(document).delegate('.xa-rank', 'keypress', function (event) {
			var keyCode = event.keyCode;
			if (keyCode === 13) {
				onConfirmRankInput(event);

			}
		});

		$(document).delegate('.xa-rank', 'blur', function (event) {
			var oldConfirmView = W.registry['common-popup-confirm-view'];
			var oldPos = $.trim($(event.currentTarget).data('display-index'));
			var rankText = $.trim($(event.currentTarget).val());
			if (rankText == oldPos) {
				return;
			}
			if (!oldConfirmView || oldConfirmView.$el.css('display') == 'none') {
				onConfirmRankInput(event);
			}
		});
	});
</script>
{% endblock %}
