{% extends "content_base_v2.html" %} {% load common_tag %} {% load account_filter %} {% block content-panel %}

<div class="xui-expiredTime-page">
	<ul class="breadcrumb">
		<li>您当前所在位置</li>
		<li>
			<a href="mall/editor/edit_expired_time.html">订单管理</a>
		</li>
		<li class="active">所有订单</li>
	</ul>
	<div class="xui-new-adress w975 pr" style="background: #EAEEF6;">
		<div class="pt20 pl20">添加新地址</div>
		<div class="xui-i-content mt20 pl50 ">
			
				<form  id="senderForm" data-id={{sender_info.id}}>

				<div class="mb10">
					<label for="" class="star_show">发件人：</label>
					<input type="text" class="ml10 xa-senderName" name="sender_name"  maxlength="100" value="{{sender_info.sender_name}}" data-validate="require-notempty"/>
					<span class="errorHint"></span>				
				</div>
				
			<div class="mb10">
			<label class="star_show">所在地区：</label>
			<select class="xa-province" required>
             	<option value="请选择">请选择省/直辖市</option>            	
             </select>
			 <select class="xa-city" required>
             	<option value="请选择">请选择市</option>            	
             </select>
			 <select class="xa-district">
             	<option value="请选择">请选择区/县</option>            	
             </select>
             <span class="errorHint"></span>
             <br />
             <input type="hidden" name="area" value="{{sender_info.area}}" />      
			</div>

				<div>
					<div class="mb10">
						<label for="" class="star_show fl">详细信息：</label>
						<textarea rows="5" cols="50" placeholder="不需要重复填写省/市/区" name="sender_address" data-validate="require-notempty">{{sender_info.sender_address}}</textarea>
						<span class="errorHint"></span>
					</div>
				</div><br />
				<div class="mb10 ">
					邮政编码：<input type="text" name="code" class="ml20" value="{{sender_info.code}}"/><br />
				</div>
				
				<div class="mb10"> 
					<label class="star_show fl" >发件人电话：</label>
					<input type="tel" name="sender_tel" data-validate="require-mobile-phone" value="{{sender_info.sender_tel}}" required/>
					<span class="errorHint"></span>
				</div>
				
				<div class="mb10">
					公司名称：<input type="text" class="ml20" name="company_name" value="{{sender_info.company_name}}"/>
				</div>
				
				<div class="mb10">
					<label class="fl">备注：</label><textarea rows="5" cols="50" class="ml30" name="remarks">{{sender_info.remarks}}</textarea>
				</div>
				<div class="mt70 ml200">
					<a href="javascript:void(0);" class="btn btn-default xa-submit">保存</a>
				</div>
				
			</form>
		</div>
	</div>
</div>

{% endblock %}
{% block js %}
<script type="text/javascript">

	$(document).ready(function() {
		$('.xa-submit').click(function(){
			if (!W.validate()) {
				return false;
			}
			var $senderName = $('.xa-senderName');
			var senderNameVal =$senderName.val();

			if (senderNameVal=='') {
				W.showHint('error', '请输入发件人信息'); 
				return false;
			}else{
				W.showHint('success', '保存成功');
				setTimeout(function() {
   							window.location.reload();
   						}, 500);
			}
    	var area = $('.xa-province').val()+'_'+$('.xa-city').val()+'_'+$('.xa-district').val();
    	$('[name="area"]').val(area);
    	var args = $('form').serializeObject();
        var method,resource;
        if(window.location.search.indexOf("id")== -1){
        	method = 'put';

        }else{
        	var id = "{{sender_info.id}}";
        	method = 'post';
        	args = _.extend(args,{id:id})
        	
        }
    	  W.getApi().call({
          method:method,          
          app: 'mall2',
          resource:'sender_info',
          args:args,
	      success: function(data) {
	      	
				window.location.reload();
					},
					error: function(resp) {
						
					}
				});
       });
       
       
		var obj = {
			init: function () {
				this.getPrvince();
			},


			// 获取省份
			getPrvince: function(pid) {
				var _this = this;
				W.getApi().call({
                 method: 'get',
                 app: 'tools',
                 resource: 'regional/provinces',
					success: function(datas) {
						var option = '';
						_.each(datas,function(data,i){
//							console.log(data,i)
							if(pid && pid == i){ }
							option+='<option value="'+i+'" data-id="'+i+'" '+ (pid && pid == i?'selected':'')+'>'+data+'</option>';
						})
						$('.xa-province').html(option);
						_this.selectProvince(pid);
					},
					error: function(resp) {
					}
				});
			},
			// 选择省份
			selectProvince: function() {
				var _this = this;
				$('.xa-province').on('click',function() {
					var $self = $(this);
					if($self.find('option:selected').html() != "请选择省份/直辖市") {
						_this.getCity();
					}else{
						$('.xa-city').html('<option>请选择市</option>');
					}
				});
			},
			
			// 获取城市
			getCity: function(pid,cid) {
				var _this = this;
                var id = pid?pid:$('.xa-province').find('option:selected').data('id')
//              console.log(id);
                   W.getApi().call({
                    method: 'get',
                    app: 'tools',
                    resource: 'regional/cities/'+id,
					success: function(datas) {
						var option = '';
						_.each(datas,function(data,i){
//							console.log(data,i)
							option+='<option value="'+i+'" data-id="'+i+'" '+ (cid && cid == i?'selected':'')+'>'+data+'</option>';
						})
						$('.xa-city').html(option);
						_this.selectDistrict();
					},
					error: function(resp) {
					}
				});
			},
			
			//选择区县
			selectDistrict: function() {
				var _this = this;
				$('.xa-city').on('click',function() {
					var $self = $(this);
					if($self.find('option:selected').html() != "请选择市") {
						_this.getDistrict();
					}else{
						$('.xa-district').html('<option>请选择市</option>');
					}
				});
			},
			
			// 获取区/县
			getDistrict: function(cid,did) {
				var _this = this;
                var id=cid?cid:$('.xa-city').find('option:selected').data('id');
//              console.log(id);
                   W.getApi().call({
                    method: 'get',
                    app: 'tools',
                    resource: 'regional/districts/'+id,
					success: function(datas) {
						var option = '';
						_.each(datas,function(data,i){
//							console.log(data,i)
							option+='<option value="'+i+'" data-id="'+i+'" '+ (did && did == i?'selected':'')+'>'+data+'</option>';
						})
						$('.xa-district').html(option);
					},
					error: function(resp) {
					}
				});
			},
		};
		obj.init();
		//页面为修改时：		
		var isChange = "{{sender_info}}" != "{}"?true:false;		
		if(isChange){
			var area = "{{sender_info.area}}";
			var areaId = area.split('_');
			obj.getPrvince(areaId[0]);
			obj.getCity(areaId[0],areaId[1]);
			obj.getDistrict(areaId[1],areaId[2]);
		}
	});
</script>
{% endblock %}