{% extends "card_base.html" %}
{% load common_tag %}
{% load account_filter %}

{% block content-panel %}

<div class="xui-editProductPage">
    <ul class="breadcrumb">
        <li>您当前所在位置</li>
        <li>
            <a href="/card/cards/get/">微众卡管理</a>
        </li>
        <li>
            <a href="/card/cards/get/">制卡管理</a>
        </li>
        <li>{% if weizoom_card_rule %}{{weizoom_card_rule.name}}{%else%}新建{% endif %}</li>
    </ul>

    <!-- 筛选 -->
    <div class="xa-cardListFilterView xui-filterPanel"></div>

    <div class="panel-heading" style="position: absolute;clear: both;margin-top: 22px;z-index: 10;left: -4px;">
        {% if can_batch_active_card %}
        <a class="btn btn-success xa-batch-active fr mt5 ml10" operate_style="active" href="javascript:void(0)">批量激活</a>
        {% endif %}
        {% if can_batch_stop_card %}
        <a class="btn btn-success xa-batch-inactive fr mt5" operate_style="inactive" href="javascript:void(0)">批量停用</a>
        {% endif %}
    </div>

    <div class=" " style="position: absolute;clear: both;margin-top: 27px;right:0px;z-index: 10;">
        {% if can_add_card %}
        <a id="appendBtn" rule-id="{{weizoom_card_rule.id}}" class="btn btn-primary" href="javascript:void(0)" style="margin:0px">追加</a>
        {% endif %}
        {% if can_export_batch_card %}
        <a id="exportBtn" class="btn btn-primary" href="javascript:void(0)"><i class="icon-plus icon-white"></i>导出表格</a>
        {% endif %}
    </div>

    <form class="form-horizontal xui-mall-addProductForm xa-addProductForm" method="post" id="editForm" style="">

        {% if weizoom_card_rule %}
        <fieldset>
            <div class="panel panel-default mt20 pr" style="background-color:#EAEEF6">
                <div class="panel-heading" style="height:60px">
                </div>

                <div class="xa-listView" 
                    data-ui-role="advanced-table-weizoom-card"  
                    data-args='{"weizoom_card_rule_id":"{{weizoom_card_rule.id}}"}' 
                    data-enable-paginator="true" 
                    data-app="card" 
                    data-api="weizoom_cards/get" 
                    data-template-id="#weizoom_card_record_list_view" 
                    data-init-sort="-created_at"  
                    data-item-count-per-page="15">
                </div>
            </div>
        </fieldset>
        {% endif %}

    </form>
</div>


{% endblock %}
{% block js %}

    {% verbatim %}
    <script id="weizoom_card_record_list_view" type="text/x-jquery-tmpl">
        <table class="table table-bordered xui-productList xb-stripedTable xb-noTdBorder xb-noBottom xb-noBorder xb-theadBg" style="margin-bottom: 10px;">
        <thead>
            <tr>
                <th>
                    <input class="xa-select-all fl " style="cursor: default;margin-top:2px;" type="checkbox" value="1" name="select-all">
                    <span class="tx_searchable">
                        卡号
                    </span>
                </th>
                <th>密码</th>
                <th>
                    状态
                </th>
                <th>面值/余额</th>
                <th>已使用金额</th>
                <th>激活时间</th>
                <th>有效期</th>
                <th>备注</th>
                <th>领用人</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody id="">
            {{each(i, card) items}}
            <tr tr-id='${card.id}'>
                <td style="width:85px;">
                    {{if (card.is_expired && card.status!=2) || card.status==2}}
                        <input class="fl " style="cursor: default;margin-top:2px;" type="checkbox" value="1" name="select-one" disabled>
                    {{else}}
                        <input class="fl " style="cursor: default;margin-top:2px;" type="checkbox" value="1" name="select-one" >
                    {{/if}}
                    <a href="/card/card_num_details/get/?card_id=${card.weizoom_card_id}&IS_CARD_RULE=TRUE">${card.weizoom_card_id}</a>
                </td>
                <td>
                    {{if ((card.active_card_user_id == card.user_id) && card.status==0) || card.is_expired || ((card.active_card_user_id == card.user_id) && card.status==2 )}}
                        ${card.password}
                    {{else card.status==3 }}
                        *******
                    {{/if}}
                </td>
                <td class="card_status" td-status="${card.status}">
                    {{if card.is_expired}}
                    <dl>已过期</dl>
                    {{else}}
                        {{if card.status==0}}
                        <dl style="color: #FF0000;">未使用</dl>
                        {{/if}}
                        {{if card.status==1}}
                        <dl style="color: #00FF00;">使用中</dl>
                        {{/if}}
                        {{if card.status==2 }}
                        <dl>己用完</dl>
                        {{/if}}
                        {{if card.status==3}}
                        <dl>未激活</dl>
                        {{/if}}
                    {{/if}}
                </td>
                <td>
                    ${card.total_money}/${card.money}
                </td>
                <td>
                    ${card.used_money}
                </td>
                <td>
                    ${card.activated_at}
                </td>
                <td>
                    ${card.valid_time_from}</br>
                    ${card.valid_time_to}
                </td>
                <td>
                    ${card.remark}
                </td>
                <td>
                    ${card.activated_to}
                </td>
                <td>
                    {{if !card.is_expired}}
                        {{if card.status==3}}
                            {{if can_active_card }}
                                <a class="btn btn-success xa-active" operate_style="active" href="javascript:void(0)">激活</a> 
                            {{/if}}  
                        {{else}}
                        {{if card.status!=2}}
                        <a class="btn btn-danger xa-active" operate_style="inactive" href="javascript:void(0)">停用</a>
                        {{/if}} 
                        {{/if}}
                    {{/if}}
                </td>
            </tr>
            {{/each}}
        </tbody>
    </table>
</script>
    {% endverbatim %}

<script type="text/javascript">
$(document).ready(function() {
    var filterBox = new W.view.card.cards.cardListFilter({
        el: ".xa-cardListFilterView",
        dataView: $('[data-ui-role="advanced-table-weizoom-card"]').data('view'),
        userWebappId: {{user.get_profile.webapp_id}},
        status:''
    });

     $('#exportBtn').click(function(event) {
        var url = '/card/weizoom_cards/export/?card_id='+{{weizoom_card_rule.id}};
        if (filterBox.filter_value) {
            url = url + '&filter_value='+filterBox.filter_value;
        }

        window.open(url);
    });
    var CardRule = W.view.common.AdvancedTable.extend({
        load: function(from_goto) {
        console.log("11111111111");
        //构造传递给后台api的参数
        var args = {};
        
        // 解决BUG 002900: 微站-订单管理-创建筛选标签可以创建但是创建好的点击没有效果
        // 去掉注释部分 
        //_.extend(args, this.args);
        if (this.options.args) {
            args = $.parseJSON(this.options.args);
        }
        
        if (this.sortAttr) {
            args['sort_attr'] = this.sortAttr;
        }
        if (this.searchQuery) {
            args['query_attr'] = this.searchAttr;
            args['query'] = this.searchQuery;
        }
        if (this.filterAttr) {
            args['filter_attr'] = this.filterAttr;
            args['filter_value'] = this.filterValue;
        }

        if (this.itemCountPerPage) {
            args['count_per_page'] = this.itemCountPerPage;
            args['page'] = this.curPage;
            args['enable_paginate'] = 1
        }

        if (this.enableSort) {
            if (from_goto) {
                //来自翻页的load，保持排序行为
            } else {
                this.enableSort = false;
            }
        }
        var _this = this;
        W.getLoadingView().show();
        W.getApi().call({
            app: this.options.app,
            api: this.options.api,
            args: args,
            scope: this,
            success: function(data) {
                W.getLoadingView().hide();
                console.log('77',this.userWebappId);
                var $node = $.tmpl(this.template, {items: data.items, data: data,can_active_card: can_active_card, categories: data.categories, 'userWebappId': _this.userWebappId});

                //table不存在
                this.$content.html($node);

                //初始化searchable header
                this.$content.find('.tx_searchable').css('cursor', 'pointer').append(' <i class="icon-search"></i>').popover({
                    placement: 'bottom',
                    title: '输入搜索文本',
                    html: true,
                    trigger: 'manual',
                    content: '<input type="text" class="input-medium inline" />&nbsp;<button class="btn btn-success tx_searchable_confirm_btn mb10">确定</button>'
                });

                //初始化sortable header
                this.$content.find('.tx_sortable').css('cursor', 'pointer').append(' <i class="hide icon-arrow-up"></i>');
                //显示当前已排序column的排序指示图标
                var sortedDirection = 'up';
                var sortedAttr = data.sortAttr;
                if (sortedAttr[0] === '-') {
                    sortedDirection = 'down';
                    sortedAttr = sortedAttr.substring(1);
                }

                var selector = '[data-sort-attr="' + sortedAttr + '"]';
                var $th = this.$content.find(selector);
                if ($th.length > 0) {
                    $th.attr('data-sort-direction', sortedDirection);
                    var newIconClass = 'icon-arrow-' + sortedDirection;
                    $th.find('i').removeClass('icon-arrow-up').addClass(newIconClass).removeClass('hide');
                }

                //初始化filterable header
                var $filterables = this.$content.find('.tx_filterable');
                $filterables.css('cursor', 'pointer').find('.dropdown-toggle').append(' <i class="icon-chevron-down"></i>');
                //添加搜索框
                var onInputKeyUpHandler = function(event) {
                    var $input = $(event.target);
                    var $li = $(event.currentTarget)
                    var text = $.trim($input.val());
                    if (text === "") {
                        $li.nextAll('li').show();
                    } else {
                        $li.next('li').nextAll('li').hide().each(function() {
                            var $el = $(this);
                            var linkText = $el.text();
                            if (linkText.indexOf(text) !== -1) {
                                //如果链接文本中存在待搜索的字符串，显示该li
                                $el.show();

                            } 
                        });
                    }
                }
                $filterables.each(function() {
                    var $filterable = $(this);
                    var $li = $('<li><input /><i class="icon-search"></i></li>');
                    $li.on('click.dropdown.data-api', function(event){
                        return false;
                    });
                    var $input = $li.find('input');
                    $li.keyup(onInputKeyUpHandler);
                    $filterable.find('.dropdown-menu').css('margin-top', '8px').find('li:first').before($li);
                });

                $filterables.find('.dropdown-toggle').dropdown();
                 
                //处理排序
                //处理翻页
                if (this.paginationView) {
                    this.paginationView.setPageInfo(data.pageinfo);
                    this.paginationView.show();
                }

                //处理拖动排序
                if (this.enableSort) {
                    this.$el.find('thead tr').append('<th width="100">调整顺序</th>');
                    this.$el.find('tbody tr').append('<td>'
                        + '<a class="btn btn-mini xa-inner-sortTrigger" data-direction="up" href="javascript:void(0);" data-toggle="tooltip" title="向上" data-placement="bottom"><i class="icon-arrow-up"></i></a>'
                        + '<a class="btn btn-mini xa-inner-sortTrigger ml1" data-direction="down" href="javascript:void(0);" data-toggle="tooltip" title="向下" data-placement="bottom"><i class="icon-arrow-down"></i></a>'
                        + '<a class="btn btn-mini xa-inner-sortTrigger ml1" data-direction="top" href="javascript:void(0);" data-toggle="tooltip" title="置顶" data-placement="bottom"><i class="icon-hand-up"></i></a>'
                    );
                    /*
                    $tbody = this.$el.find('tbody');
                    $sortHandler = $tbody.find('td.wui-advanced-table-weizoom-card-sort-handler');
                    $sortHandler.wrapInner('<div class="fl"></div>');
                    $sortHandler.prepend('<div class="fl wui-inner-real-sort-handler" style="cursor: move;"><i class=" icon-resize-vertical"></i></div>');
                    $tbody.sortable({
                        axis: 'y',
                        helper: this.storHelper,
                        placeholder: "ui-state-highlight",
                        cursor: 'move',
                        handle: '.wui-inner-real-sort-handler',
                        stop: _.bind(function(options) {
                            this.submitForSort();
                        }, this)
                    });
                    */
                }
            },
            error: function(resp) {
                W.getLoadingView().show();
                // alert('加载分类失败!');
            }
        });
    },
    });
    W.registerUIRole('div[data-ui-role="advanced-table-weizoom-card"]', function() {
        var $div = $(this);
        var app = $div.attr('data-app');
        var api = $div.attr('data-api');
        var args = $div.attr('data-args');
        var template = $div.attr('data-template-id');
        var initSort = $div.attr('data-init-sort');
        var enablePaginator = !!($div.attr('data-enable-paginator') === 'true');
        var enableSort = !!($div.attr('data-enable-sort') === 'true');
        var sortApi = $div.attr('data-sort-api');
        var itemCountPerPage = $div.attr('data-item-count-per-page');
        var userWebappId = $div.attr('data-user-webapp-id');
        if (itemCountPerPage) {
            itemCountPerPage = parseInt(itemCountPerPage);
        } else {
            itemCountPerPage = 15;
        }

        var advancedTable = new CardRule({
            el: $div[0],
            template: template,
            app: app,
            api: api,
            args: args,
            initSort: initSort,
            itemCountPerPage: itemCountPerPage,
            enablePaginator: enablePaginator,
            enableSort: enableSort,
            sortApi: sortApi,
            userWebappId: userWebappId
        });
        advancedTable.render();

        $div.data('view', advancedTable);
    });
});
</script>

<script>
    var deleteView2 = W.view.common.ConfirmView.extend({
        events:{
            'click .xa-confirm': 'submit',
            'click .xa-cancel2': 'close'
        },
        getTemplate: function() {
            var template ='<dl class="itemDeleteView2 wui-confirmView" style="margin: 10px 16px 5px 6px;">'
                    +'<div class="activated_to" style="margin-left: 4px;">'
                    +'<label for="activated_to" class="star_show">领用人</label>'
                    +'<input type="text" id="activated_to" style="width: 100px;margin-left: 8px;">'
                    +'</div>'
                    +'<div class="card_remark" style="margin-top: 10px;margin-left: 4px;">'
                    +'<label for="card_remark" class="star_show" style="vertical-align: top;">备&nbsp;&nbsp;注</label>'
                    +'<textarea type="text" id="card_remark" style="height: 52px;width:164px;margin-left: 14px;"></textarea>'
                    +'</div>'
                    +'<button type="button" class="xa-confirm btn btn-success" style="background-color:#207CBE;margin: 8px 47px;width:60px;">确定</button> '
                    +'<button type="button" class="xa-cancel2 btn" style="background-color:#207CBE; color:#FFF;margin: 0px -44px;width:60px;">取消</button>'
                    +'</dl>';
            return _.template(template);
        }
    });
    W.requireConfirm2 = function(options) {
    //防止和父级view冲突
        var parent_view = W.registry['common-popup-confirm-view'];
        if(parent_view){
            parent_view.hide();
            W.isRequireConfirmViewDisplayed = false;
        }
    //获得view
        var view = W.registry['common-popup-confirm-view2'];
        if (!view) {
            xlog('create PopupConfirmView2');
            view = new deleteView2(options);
            W.registry['common-popup-confirm-view2'] = view;
        }
        if (options.confirm) {
            view.bind(view.SUBMIT_EVENT, options.confirm);
        }

        view.show({
            $action: options.$el
        });
    };

    W.finishConfirm2 = function() {
        var view = W.registry['common-popup-confirm-view2'];
        if (view) {
            view.hide();
        }
    };
</script>
<script>
    function buildTimeOptions(max, selected) {
        var i, optionHtml = '', value;
        for(i = 0; i < max; i++) {
            value = i < 10 ? '0'+i : i;
            if (selected==value){
                optionHtml += '<option value="'+value+'" selected>'+value+'</option>';
            }else{
                optionHtml += '<option value="'+value+'">'+value+'</option>';
            }
        }
        return optionHtml;
    }
    var selected = $('.xa_hours').attr('data-value') || '00';
    $('.xa_hours').append(buildTimeOptions(24, selected));
    selected = $('.xa_minute').attr('data-value') || '00';
    $('.xa_minute').append(buildTimeOptions(60, selected));

    $('.xa-listView').delegate('.xa-active', 'click', function(event) {
        var id = $(this).parents('tr').attr('tr-id');
        var operate_style = $(this).attr('operate_style');
        var $el = $(event.currentTarget);
        W.getApi().call({
            app: 'card',
            api: 'card_info/get',
            method: 'post',
            args: {
                card_id: id
            },
            success: function(data) {
                var weizoom_card_info = data.weizoom_card_info;
                $("#card_remark").val(weizoom_card_info.card_remark);
                $("#activated_to").val(weizoom_card_info.activated_to);
            },
            error: function(resp) {
                W.showHint('error','失败');
            }
        });
        W.requireConfirm2({
            $el: $el,
            isTitle: false,
            confirm: function(){
                var card_remark = $("#card_remark").val().trim();
                var activated_to =$("#activated_to").val().trim();
                if (activated_to.length<= 0){
                    W.showHint('error','请输入领用人');
                    $('.xa-submit').bottonLoading({status:'hide'});
                    return;
                }
                if (card_remark.length<= 0){
                    W.showHint('error','请输入备注');
                    $('.xa-submit').bottonLoading({status:'hide'});
                    return;
                }
                if (activated_to.length>20 || card_remark.length> 20) {
                    W.showHint('error','该内容最多输入20个字符');
                    $('.xa-submit').bottonLoading({status:'hide'});
                    return;
                }
                W.getApi().call({
                    app: 'card',
                    api: 'status/update',
                    method: 'post',
                    args: {
                        card_id: id,
                        status: '0',
                        card_remark: card_remark,
                        activated_to: activated_to,
                        operate_style: operate_style
                    },
                    success: function(data) {
                        W.finishConfirm2();
                        $('div[data-ui-role="advanced-table-weizoom-card"]').data('view').reload();
                    },
                    error: function(resp) {
                        W.showHint('error','失败');
                    },
                    scope: this
                });
            }
        });
    });
    
    $('.xa-batch-active').click(function(event) {
        var $el = $(event.currentTarget);
        var operate_style= $(this).attr('operate_style');
        var card_ids =[],flag = false;
        $('input[name="select-one"]:checked').parents('tr').each(function(){
            card_status= $(this).children('.card_status').attr('td-status');
            console.log(card_status);
            if(card_status == 3 ){
                card_ids.push($(this).attr('tr-id'));
            }else{
                W.showHint('error','操作失败，您所选的卡号含有使用中或未使用的状态！');
                flag = true;
            }
        });
        if(flag) return;
        if(card_ids.length == 0){
            W.showHint('error','请先选择要激活的微众卡！');
            return;
        }
        $("#card_remark").val("");
        $("#activated_to").val("");

        W.requireConfirm2({
            $el: $el,
            isTitle: false,
            confirm: function(){
                var card_remark = $("#card_remark").val().trim();
                var activated_to =$("#activated_to").val().trim();
                if (activated_to.length<= 0){
                    W.showHint('error','请输入领用人');
                    $('.xa-submit').bottonLoading({status:'hide'});
                    return;
                }
                if (card_remark.length<= 0){
                    W.showHint('error','请输入备注');
                    $('.xa-submit').bottonLoading({status:'hide'});
                    return;
                }
                if (activated_to.length>20 || card_remark.length> 20) {
                    W.showHint('error','该内容最多输入20个字符');
                    $('.xa-submit').bottonLoading({status:'hide'});
                    return;
                }
                W.getApi().call({
                    app: 'card',
                    api: 'batch_status/update',
                    method: 'post',
                    args: {
                        card_id: card_ids.toString(),
                        status: '0',
                        card_remark: card_remark,
                        activated_to: activated_to,
                    },
                    success: function(data) {
                        W.finishConfirm2();
                        $('div[data-ui-role="advanced-table-weizoom-card"]').data('view').reload();
                    },
                    error: function(resp) {
                        if(resp.code == 500){
                            W.showHint('error',resp.errMsg);
                        }else{
                            W.showHint('error','批量激活失败');
                        }
                    },
                    scope: this
                });
            }
        });
    });

    $('.xa-batch-inactive').click(function(event) {
        var $el = $(event.currentTarget);
        var card_ids =[],flag = false;

        $('input[name="select-one"]:checked').parents('tr').each(function(){
            card_status= $(this).children('.card_status').attr('td-status');
            if(card_status != 3 ){
                card_ids.push($(this).attr('tr-id'));
            }else{
                W.showHint('error','操作失败，您所选的卡号已包含未激活的状态！');
                flag = true;
            }
        });
        if(flag) return;
        if(card_ids.length == 0){
            W.showHint('error','请先选择要停用的微众卡！');
            return;
        }
        $("#card_remark").val("");
        $("#activated_to").val("");
        W.requireConfirm2({
            $el: $el,
            msg : '确定停用么?',
            isTitle: false,
            confirm: function(){
                var card_remark = $("#card_remark").val().trim();
                var activated_to =$("#activated_to").val().trim();
                if (activated_to.length<= 0){
                    W.showHint('error','请输入领用人');
                    $('.xa-submit').bottonLoading({status:'hide'});
                    return;
                }
                if (card_remark.length<= 0){
                    W.showHint('error','请输入备注');
                    $('.xa-submit').bottonLoading({status:'hide'});
                    return;
                }
                if (activated_to.length>20 || card_remark.length> 20) {
                    W.showHint('error','该内容最多输入20个字符');
                    $('.xa-submit').bottonLoading({status:'hide'});
                    return;
                }
                W.getApi().call({
                    app: 'card',
                    api: 'onbatch_status/update',
                    method: 'post',
                    args: {
                        card_id: card_ids.toString(),
                        card_remark: card_remark,
                        activated_to: activated_to,
                        status: '3'
                    },
                    success: function(data) {
                        W.finishConfirm2();
                        $('div[data-ui-role="advanced-table-weizoom-card"]').data('view').reload();
                    },
                    error: function(resp) {
                        if(resp.code == 500){
                            W.showHint('error',resp.errMsg);
                        }else{
                            W.showHint('error','批量停用失败');
                        }
                    },
                    scope: this
                }); 
            }
        });
    });

    $('.xa-listView').delegate('.xa-inactive', 'click', function(event) {
        var id = $(this).parents('tr').attr('tr-id');
        var $el = $(event.currentTarget);

        W.requireConfirm2({
            $el: $el,
            msg : '确定停用么?',
            isTitle: false,
            confirm: function(){
                W.getApi().call({
                    app: 'card',
                    api: 'status/update',
                    method: 'post',
                    args: {
                        card_id: id,
                        status: '3'
                    },
                    success: function(data) {
                        W.finishConfirm();
                        $('div[data-ui-role="advanced-table-weizoom-card"]').data('view').reload();
                    },
                    error: function(resp) {
                        W.showHint('error','失败');
                    },
                    scope: this
                }); 
            }
        });
    });
    
    
    $('.xa-listView').delegate('.xa-select-all', 'click', function(event) {
        var checkboxes = $('input[name="select-one"]');
        for(var i=0; i < checkboxes.length; i++) {
            if(checkboxes[i].disabled) {
                continue;
            }
            checkboxes[i].checked = !checkboxes[i].checked;
        }
    });
    
    $('#appendBtn').click(function(event) {
        W.dialog.showDialog('W.weapp.dialog.AppendWeizoomCardDialog', {
            success: function(data) {
                W.getLoadingView().show();
                W.getApi().call({
                    app: 'card',
                    api: 'weizoom_cards/append',
                    method: 'post',
                    args: data,
                    success: function(data) {
                        $('[name="number"]').val(data.count);
                        $('div[data-ui-role="advanced-table-weizoom-card"]').data('view').reload();
                    },
                    error: function(resp) {
                        W.showHint('error','追加微众卡失败！');
                    }
                })
            }
        })
    });
    
</script>
{% endblock %}
