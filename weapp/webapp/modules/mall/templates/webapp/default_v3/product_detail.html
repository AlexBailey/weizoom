{% extends "webapp_content_base.html" %}
{% load mall_filter %}

{% block css %}
<link rel="stylesheet" href="/webapp_static/backend_default/css/loading.css">
<style>
a.xui-btn:link,a.xui-btn:hover,.xui-btn:visited{color:#fff!important;}
.xui-pl0{
    padding: 0;
}
</style>
{% endblock %}

{% block content-panel %}
<div id="product-detail" data-user-is-member="{{request.member.grade_id}}" class="xui-productDetailPage xui-page">
    <div data-role="content" data-theme="x" class="xui-content xa-content">
        <div
            data-ui-role="swipeimage"
            data-jsondata='{{product.swipe_images_json|safe}}'
            data-width='320'
            data-height='200'
            style="background:#fff"
        >
        </div>
        <!-- 返回上一页 -->
        <i data-ui-role="goBack"></i>
        <div id="product" data-is-member-product="{{product.is_member_product}}" class="xui-section pt5 pb5" style="padding-right:0;">
            <div class="xui-section-title xui-section-item xui-pl0">
                {% if cur_request_member %}
                <div class="disF">
                    <h2 class="xui-productName xt-productName">{{ product.name }}{% if product.promotion_title %}
                    <span class="xui-text-red">{{ product.promotion_title|safe }}</span>{% endif %}</h2>
                    <a href="javascript:void(0);" class="xui-fav xa-collectProduct" data-is-collect="false">收藏</a>
                </div>
                {% else %}
                <div class="disF">
                    <h2 class="xui-productName xt-productName">{{ product.name }}{% if product.promotion_title %}
                    <span class="xui-text-red">{{ product.promotion_title }}</span>{% endif %}</h2>
                </div>
                {% endif %}
                <p class="xui-section-boldItemText xui-text-red xa-priceSection">
                    {% if product.promotion and product.promotion.type == 1 %}
                    <span class="xui-vipPrice-num em85">￥<span class="xa-price xa-singlePrice fb em95">{{ price_info.min_price }}</span></span>
                    {% else %}
                        <span class="xui-vipPrice-num em85">￥<span class="xa-price xa-singlePrice fb em95">{{ price_info.min_price }}</span></span>
                    {% endif %}
                </p>
            </div>
        </div>
        {% if product.promotion and product.promotion_model.is_active or product.integral_sale %}
        <div class="xui-section xui-section-title clearfix xa-promotionSection xui-promotionSection pr" style="min-height:17px;">
            <div class="xui-upDecorate-left"></div>
            <div class="xui-upDecorate-right"></div>
            {% if product.promotion and product.promotion_model.is_active %}
            <div class="disT w">
                <div class="disTc em85 c6" style="width:3rem;">
                    <span style="margin-top:4px;display:inline-block;">优惠：</span>
                </div>
                <div class="disTc em85" style="width:3.4rem;">
                    <span class="xui-promotionName xa-promotionNormal" data-type="{{ product.promotion.type}}">{{ product.promotion.type_name|safe }}</span>
                </div>
                <div class="disTc c6 em8 pl5">
                {% if product.promotion.type == 2 %}
                <span style="line-height:1.3rem">
                    {% for premium_product in product.promotion.detail.premium_products %}
                        {{premium_product.name}}&nbsp; x&nbsp;{{premium_product.premium_count}}{{premium_product.premium_unit}}<br/>
                    {% endfor %}
                </span>
                {% else %}
                    <span class="ml5 xa-promotionNormal-info">{{ product.promotion.promotion_title }}</span>
                {% endif %}
                </div>
            </div>
            {% endif %}
            {% if product.integral_sale %}
            <div class="disT w">
                <div class="disTc em85 c6" style="width:3rem;">
                {% if not product.promotion or not product.promotion_model.is_active %}
                    优惠：
                {% endif %}</div>
                <div class="disTc em85" style="width:3.1rem;">
                    <span class="xui-promotionName xa-promotion" data-type="5" data-discount="{{product.integral_sale.detail.discount}}" data-per-yuan="{{per_yuan}}">积分抵扣</span>
                </div>
                <div class="disTc c6 em8 pl5">
                    <span class="xa-intergralInfo"></span>
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <div class="xui-section" style="padding-bottom:0;">
            <div class="xui-section-item xui-section-title xui-tag pb10" style="padding-top:1px;">
                <span><i></i>正品保障</span>
                <span><i></i>天天低价 畅选无忧</span>
                <span><i></i>多种支付方式</span>
            </div>
            {% if product.product_model_properties %}
                {% if not product.is_sellout and product.shelve_type == 1%}
                <div class="xui-section-item xui-section-title">
                    <a href="javascript:void(0);" class="pt10 pb10 block xa-slidePanelShow">
                        <label for="" class="pr10">请选择</label>
                        <!-- <span class="xa-selectedModelHint">请选择</span> -->
                        {% for property in product.product_model_properties %}
                        <span class="xa-selectedModelPropertyValueName pr5" data-property-id="{{property.id}}" data-property-name="{{property.name}}">{{property.name}}</span>
                        {% endfor %}
                        <span class="xa-purchaseCount">数量</span>
                        <!-- <span class="">{{product.physical_unit}}</span> -->
                        <span class="xui-icon xui-icon-rightarrow"></span>
                    </a>
                </div>
                {% endif %}
            {% else %}
                <div class="xui-section-item xui-section-title pt10 pb10 xui-standard">
                    <label for="" class="pa" style="top:20px;">请选择</label>
                    <input
                        data-ui-role="counter"
                        data-minlimit="{{product.min_limit}}"
                        {% ifequal product.stock_type 1 %}
                            {% if product.promotion.type == 1 and product.promotion.detail.count_per_purchase < product.stocks %}
                            data-max-count="{{product.promotion.detail.count_per_purchase}}"
                            {% else %}
                            data-max-count="{{product.stocks}}"
                            {% endif %}
                        {% endifequal %}
                        type="hidden"
                        name="total_count"
                        id="total_count"
                        value="1"
                    >
                </div>
                <span class="em7 cRed hidden xui-understock xa-understock" style="margin-top:-34px;">
                    {% if product.promotion.type == 1 and product.promotion.detail.count_per_purchase < product.stocks %}
                        限购{{product.promotion.detail.count_per_purchase}}件
                    {% else %}
                        库存不足
                    {% endif %}
                </span>
            {% endif %}
            {% if product.properties %}
            <div class="xui-section-item xui-section-title xui-property-panel">
                <label for="" class="pr xa-property">详情参数
                    <span class="xui-icon xui-icon-rightarrow"></span>
                </label>
                <ul class="hidden">
                {% for property in product.properties %}
                    <li class="c6 ml10">
                        <span>{{ property.name }}：</span>
                        <span>
                            {{ property.value }}
                        </span>
                    </li>
                {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
        {% if product.product_review %}
        <div class="xui-section pb0 pt0">
            <div class="xui-section-item xui-section-title xui-rate-panel">
                <label for="" class="pr">商品评价</label>
                <ul>
                    {% for review in product.product_review %}
                    <li class="c6">
                        <div class="clearfix pt10 pb10">
                            <div class="fl">
                                <img src="/static/img/user-1.jpg" alt="">
                                <span class="xa-memberName">
                                    {% autoescape off %}
                                        {{review.member_name }}
                                    {% endautoescape %}
                                </span>
                            </div>
                            <span class="fr">{{review.created_at | date:"Y-m-j"}}</span>
                        </div>
                        <p class="xui-ellipsis-2">{{review.review_detail}}
                        </p>
                    </li>
                    {% endfor %}
                    <li class="tc w xui-more" style="border-bottom:none;">
                        <a style="box-shadow:none;" href="./?woid={{request.webapp_owner_id}}&module=mall&model=product_review_list&action=get&product_id={{product.id}}">查看更多评价</a>
                    </li>
                </ul>
            </div>
        </div>
        {% endif %}
        {% if product.detail %}
        <div class="xui-section xui-production-panel pt0 xa-production hidden" style="border:0;">
            <div class="xui-section-title xui-section-item zoom">
                <label>商品介绍</label>
                <div class="xui-productDetail-content rawHtml c3 pt10 xa-productDetail-content" data-detail="{{product.detail}}">
                </div>
            </div>
        </div>
        {% else %}
        <div class="xui-section xui-production-panel pt0" style="border:0;">
            <div class="xui-section-title xui-section-item zoom">
                <label>商品介绍</label>
                <div class="xui-productDetail-content rawHtml c3 pt10" style="text-align: center;">暂无商品介绍</div>
            </div>
        </div>
        {% endif %}
        <div class="ui-refresh-down"></div>
    </div>
    <!-- 购物车、加入购物车、购买按钮组Start -->
    <div class="tc xui-tab-fixed">
        {% if is_weizoom_mall %}
        {% else %}
        <a href="./?woid={{request.webapp_owner_id}}&module=mall&model=shopping_cart&action=show" class="xui-shoppingCartBtn xui-btn">

                <i class="xui-inner-icon pr">
                    <span class="xui-inner-count pa hidden xa-shoppingCartCount"></span>
                </i>
        </a>
        {% endif %}
        <!-- 已售罄 -->
        {% if product.shelve_type == 1 %}
            {% if product.is_sellout %}
                <div class="xui-selloutAlert">商品已售罄，非常抱歉</div>
                <div style="padding:3px 0;">
                    <a href="javascript:void(0);" class="xui-btn xui-addCartBtn xui-addCartBtn-disable" data-type='shoppingCart'>加入购物车</a>
                    <a href="javascript:void(0);" class="xui-btn xui-buyBtn xui-buyBtn-disable" data-type='buy'>立即购买</a>
                </div>
            <!-- 普通商品 -->
            {% else %}
            <div class="xa-disabledBuyLinks xui-inlineblock clearfix" style="padding:3px 0;">
                <a href="javascript:void(0);" class="xui-btn xui-addCartBtn xa-canNotBuyButton" data-type='shoppingCart'>加入购物车</a>
                <a href="javascript:void(0);" class="xui-btn xui-buyBtn xa-canNotBuyButton" data-type='buy'>立即购买</a>
            </div>
            <div class="xa-enabledBuyLinks xui-inlineblock xui-hide clearfix" style="padding:3px 0;">
                <a href="javascript:void(0);" class="xui-btn xui-addCartBtn xa-addShoppingCartBtn" data-type='shoppingCart'>加入购物车</a>
                <a href="./?woid={{request.webapp_owner_id}}&module=mall&model=order&action=edit&product_id={{product.id}}&product_count=1&product_model_name=standard" class="xui-btn xa-buyBtn xui-buyBtn" data-type='buy'>立即购买</a>
            </div>
            {% endif %}
        {% else %}
            <div class="xui-selloutAlert">商品已下架，非常抱歉</div>
            <div style="padding:3px 0;">
                <a href="javascript:void(0);" class="xui-btn xui-addCartBtn xui-addCartBtn-disable" data-type='shoppingCart'>加入购物车</a>
                <a href="javascript:void(0);" class="xui-btn xui-buyBtn xui-buyBtn-disable" data-type='buy'>立即购买</a>
            </div>
        {% endif %}
    </div>
    <!-- 弹层、蒙版Start -->
    {% if product.product_model_properties %}
    <div class="xui-productInfo xa-upSlidePanel xui-upSlidePanel">
        <div class="pr">
            <div class="pa xui-productImg">
                <img src="{{ product.thumbnails_url }}" alt="" width="90" height="90">
            </div>
            <div class="" style="padding-left:103px;min-height: 75px;">
                <p class="pt5 em95 xui-text-red">
                <!-- 积分商品 -->
                {% if product.type == 'integral' %}
                    {% if cur_request_member %}
                        {% if price_info.price == price_info.original_price %}
                        <span class="xt-price xa-price xui-vipPrice-num">{{ price_info.min_price }}</span>
                        {% else %}
                        <span class="xt-price xui-vipPrice-num">{{ price_info.min_price }}</span>
                        {% endif %}
                    {% else %}
                        <span class="xt-originalPrice xui-vipPrice-num xa-price xa-fixed-price">{{ price_info.min_price }}</span><!-- <span class="xui-vipPrice ml20">会员价？</span> -->
                    {% endif %}积分

                <!-- 普通商品 -->
                {% elif product.type == 'object' %}
                    {% if cur_request_member %}
                        <span class="xa-price xui-vipPrice-num em85">￥<span class="xa-price xa-singlePrice fb">{{ price_info.min_price }}</span></span>
                    {% else %}
                        <span class="xui-vipPrice-num xa-price em85">￥<span class="xa-price xa-singlePrice fb">{{ price_info.min_price }}</span></span>
                    {% endif %}
                {% endif %}
                </p>
                <p class="c6 em8 mt5">{{ product.name }}</p>

                <!-- <p class="mt10 xa-stock">(库存<span class="xa-stockCount">{{product.physical_unit}}</span>)</p> -->
            </div>
            <i class="xui-popInfo-close pa xa-closeModelSelection"></i>
        </div>
        <div class="xui-productModel-section" id="xa-wrapper">
            <ul>
                {% for property in product.product_model_properties %}
                    <li class="xui-slidePanel-item">
                        <label class="xui-i-propertyName">{{property.name}}</label>
                        <div class="xui-i-customModel clearfix">
                        {% for value in property.values %}

                            {% if value.is_belong_product %}
                                {% if value.image %}
                                <a
                                    href="javascript:void(0);"
                                    class="xui-inner-imgTag xa-propertyValue"
                                    data-property-value-id="{{property.id}}:{{value.id}}"
                                    data-property-value-name="{{value.name}}"
                                    id="a_{{property.id}}_{{value.id}}"
                                    name="{{property.id}}:{{value.id}}"
                                    style="overflow:hidden"
                                >

                                    <img class="addBorder" src="{{ value.image|safe }}" />
                                </a>
                                {% else %}
                                <a
                                    href="javascript:void(0);"
                                    class="xui-inner-tag xa-propertyValue"
                                    data-property-value-id="{{property.id}}:{{value.id}}"
                                    data-property-value-name="{{value.name}}"
                                    id="a_{{property.id}}_{{value.id}}"
                                    name="{{property.id}}:{{value.id}}"
                                >
                                    {{value.name}}
                                </a>
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                        </div>
                    </li>
                {% endfor %}
                    <li class="xui-slidePanel-item pr">
                        <div class="xui-i-propertyName pa">数量</div>
                        <div class="" style="padding-left:3rem;">
                            <input
                                data-ui-role="counter"
                                data-minlimit="{{product.min_limit}}"
                                {% ifequal product.stock_type 1 %}
                                    {% if product.promotion.type == 1 and product.promotion.detail.count_per_purchase < product.stocks %}
                                    data-max-count="{{product.promotion.detail.count_per_purchase}}"
                                    {% else %}
                                    data-max-count="{{product.stocks}}"
                                    {% endif %}
                                {% endifequal %}
                                type="hidden"
                                name="total_count"
                                id="total_count"
                                value="1"
                            >
                            <span class="em7 cRed hidden xui-understock xa-understock">
                                {% if product.promotion.type == 1 and product.promotion.detail.count_per_purchase < product.stocks %}
                                    限购{{product.promotion.detail.count_per_purchase}}件
                                {% else %}
                                    库存不足
                                {% endif %}
                            </span>
                        </div>
                    </li>
            </ul>
        </div>
        <div class="xui-slidePanel-item">
            <div class="xa-disabledBuyLinks xui-inlineblock clearfix">
                <a href="javascript:void(0);" class="xui-btn xui-addCartBtn xa-canNotBuyButton" data-type='shoppingCart'>加入购物车</a>
                <a href="javascript:void(0);" class="xui-btn xui-buyBtn xa-canNotBuyButton" data-type='buy'>立即购买</a>
            </div>
            <div class="xa-enabledBuyLinks xui-inlineblock hidden clearfix">
                <a href="javascript:void(0);" class="xui-btn xui-addCartBtn xa-addShoppingCartBtn" data-type='shoppingCart'>加入购物车</a>
                <a href="./?woid={{request.webapp_owner_id}}&module=mall&model=order&action=edit&product_id={{product.id}}&product_count=1&product_model_name=standard" class="xui-btn xa-buyBtn xui-buyBtn" data-type='buy'>立即购买</a>
            </div>
        </div>
    </div>
    <div class="xui-coverV2 xa-coverV2 hidden"></div>
    {% endif %}
    <!-- 全局导航 -->
    <div class="wui-globalNav xa-globalNav" data-ui-role="global-nav" data-member="{% if cur_request_member %}true{% else %}false{% endif %}">
    </div>
    <!-- 返回顶部 -->
    <div class="wui-returnTop xa-returnTop hidden" data-ui-role="return-top">
    </div>
</div>
{% endblock %}

{% block js %}
{% if not is_deleted_data %}
<script type="text/javascript">
//运费计算因子
var postageFactor = {};
//可用积分
var usableIntegral = {{usable_integral}};
//是否启用"测试购买"
var enableTestBuy = {% if cur_request_member.is_for_buy_test %}true{% else %}false{% endif %};
//商品id
var productId = '{{product.id}}';
//商品类型
var productType = "{{product.type}}";
//商品规格值
var models = W.loadJSON('models');
//商品价格信息
var priceInfo = W.loadJSON('priceInfo');
//运费配置名称
var postageConfigName = "{{product.postage_config.name}}";
// 限购数量
var countPerPurchase = {% if product.promotion.detail.count_per_purchase %}{{product.promotion.detail.count_per_purchase}}{% else %}-1{% endif %};
// 是否会员商品
var is_member_product = '{{product.is_member_product}}'
// 促销信息
var promotion = W.loadJSON('promotion');

$(document).ready(function() {
    var user_member_grade_id = $("#product-detail").data('user-is-member');
    var is_member_product = $("#product").data('is-member-product');
    var user_has_promotion = function(user_member_grade_id, promotion_member_grade_id){
        if(promotion_member_grade_id == '0'){return true;}
        if(promotion_member_grade_id == user_member_grade_id){
            return true;
        }else{
            return false;
        }

    };
    //检查此商品是否被收藏和显示购物车的数量
    W.getApi().call({
        app: 'webapp',
        api: 'project_api/call',
        method: 'get',
        args: {
            woid: W.webappOwnerId,
            module: 'mall',
            target_api: 'member_product_info/get',
            product_id: productId,
        },
        success: function(data) {
            if(data.is_collect == 'true'){
                $('.xa-collectProduct').addClass('faved').text('已收藏');
                $('.xa-collectProduct').attr('data-is-collect', 'true');
            }
            if(data.count != 0) {
                $('.xa-shoppingCartCount').text(data.count).removeClass("hidden");
            }

            // //促销与会员价格处理
            view.discount = data.discount;
            // 商品原价
            var price = view.priceInfo.min_price;

            // 商品有促销
            var product_promotion = view.promotion;
            var is_user_has_promotion = false;
            if(product_promotion){
                // 促销是否对此用户开发
                is_user_has_promotion = user_has_promotion(user_member_grade_id, product_promotion.member_grade_id);
                if(is_user_has_promotion){
                    try{
                        price = (product_promotion.detail.promotion_price).toFixed(2);
                    }catch(err){
                        price = view.priceInfo.min_price;
                    }
                }
            // 商品无促销
            }
            if(!is_user_has_promotion){
                // 商品是否折扣
                has_discount = is_member_product;
                if(has_discount === "True"){
                    price = ((price * data.discount / 100).toFixed(2));
                }
            }

            // 处理会员价
            var temp = '<span class="xui-memberPriceTag">优惠价</span><span class="xui-vipPrice-num em85">￥<span class="xa-price xa-singlePrice fb em95">'+ price +'</span></span><span class="xui-orPrice">原价￥<span class="xa-orPrice">'+ view.priceInfo.min_price +'</span></span>';
            $('.xa-priceSection').html(temp);
        },
        error: function(data) {

        }
    });
    // setTimeout(function(){
    //     $('.xui-applyBox').removeClass('hidden');
    // },200);
    view = new W.page.BuyProductPage({
        el: '.xui-page',
        postageFactor: postageFactor,
        usableIntegral: usableIntegral,
        enableTestBuy: enableTestBuy,
        productId: productId,
        productType: productType,
        models: models,
        priceInfo: priceInfo,
        postageConfigName: postageConfigName,
        countPerPurchase: countPerPurchase,
        promotion: promotion,
        is_member_product: is_member_product
    });

    if(models.length > 1){
        var myscroll=new iScroll('xa-wrapper',{hScrollbar:false,bounce:false});
    }
    if($('.xa-production').length > 0){
        $('.xa-content').css('height',window.document.body.clientHeight - 42).refresh({
            statechange: function (e, $elem, state, dir) {
                var refreshInfo = this._options.refreshInfo[dir];
                switch (state) {
                    case 'loading':
                        refreshInfo['$label'].html('详情加载中...');
                        break;
                }
            },
            load: function (dir, type) {
                var me = this;
                var data = $('.xa-productDetail-content').data('detail');
                $('.xa-productDetail-content').html(data);
                var img = $(data).find('img');
                if(img.length > 0){
                    var a = setInterval(function(){
                        var flag = true;
                        img.each(function(i,n){
                            if(!n.complete)
                                flag = false;
                        })
                        if(flag){
                            $('.xa-production').removeClass('hidden');
                            me.afterDataLoading(dir);
                            clearInterval(a)
                            me.disable(dir,true);
                        }
                    });
                }else{
                    $('.xa-production').removeClass('hidden');
                    me.afterDataLoading(dir);
                    me.disable(dir,true);
                }

            }
        });
        // $('.ui-refresh-icon').hide();
        isPhone6pinches = (window.screen.height==736);
        if(isPhone6pinches){
            $('.ui-refresh-label').text("点击加载商品详情");
        }else{
            $('.ui-refresh-label').text("↑ 上拉加载商品详情");
        }
    }

    //处理会员名称
    var spanMemberName = $(".xa-memberName");
    for(var i = 0; i < spanMemberName.length; i++) {
        var str = $(spanMemberName[i]).text().trim();
        var str_name = str.substring(0,1)+"**"+str[str.length-1];
        $(spanMemberName[i]).html(str_name)
    }
});
//无刷新页面重置数量信息
if (document.getElementById('total_count')) {
    document.getElementById('total_count').value = 1;
}
</script>
{% endif %}
{% endblock %}
