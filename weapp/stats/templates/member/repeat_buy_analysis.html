{% extends "content_base_v2.html" %}
{% load project_filter %}
{% load account_filter %}

{% block content-panel %}
<div class="xui-wepage-BIPage xui-rePurchaseAnalyzePage">
    <div class="relative">
        <ul class="breadcrumb">
            <li>您当前所在位置</li>
            <li><a href="/stats/order_summary/">会员分析</a></li>
            <li class="active">复购分析</li>
        </ul>
    </div>
    
    <div class="xb-rightPanel pl10 pr10 pb30">
        <div class="xui-filter xui-filterPanel pl40" style="padding-top:22px;">
            会员状态：
            <select name="" id="" class="xa-memberStateSelect">
                <option value="all">全部</option>
                <option value="1">已关注</option>
                <option value="0">取消关注</option>
            </select>
        </div>
        <div class="xui-charWrap fl" style="height:400px;">
            <div class="xui-i-title"> <div class="xui-i-block"></div><span class="ml5">会员购买占比</span></div>
            <div id="memberPurchaseScale" class="pr" style="height:400px;top:-60px;"></div>
        </div>
        <div class="xui-charWrap fr" style="height:400px;">
            <div class="xui-i-title"> 
                <div class="xui-i-block"></div>
                <span class="ml5">
                    复购会员分析
                    <img class="xui-i-img xui-consumptionHelp pr" id="consumption_help" src="/static_v2/img/editor/help.png"/>
                </span>
                <span class="fr f12 xui-setConsumption pr">
                    <span class="xui-setConsumptionBtn xa-setConsumptionBtn mr10 pr">设置消费总额</span>
                    <div class="pa xui-consumptionBox xa-consumptionBox">
                        <div class="">
                            <span>消费额区间1（元）：</span>
                            <input type="text" placeholder="请输入整数" class="xui-comsumptionNum xui-comsumptionNum0">&nbsp;-&nbsp;
                            <input type="text" placeholder="请输入整数" class="xui-comsumptionNum xui-comsumptionNum1">
                            <div class="errorHint"></div>
                        </div>
                        <div class="">
                            <span>消费额区间2（元）：</span>
                            <input type="text" placeholder="请输入整数" class="xui-comsumptionNum xui-comsumptionNum2">&nbsp;-&nbsp;
                            <input type="text" placeholder="请输入整数" class="xui-comsumptionNum xui-comsumptionNum3">
                            <div class="errorHint"></div>
                        </div>
                        <div class="">
                            <span>消费额区间3（元）：</span>
                            <input type="text" placeholder="请输入整数" class="xui-comsumptionNum xui-comsumptionNum4">&nbsp;-&nbsp;
                            <input type="text" placeholder="请输入整数" class="xui-comsumptionNum xui-comsumptionNum5">
                            <div class="errorHint"></div>
                        </div>
                        <div class="fr btn btn-primary m0 xui-confirm xa-confirmBtn">确认</div>
                        <div class="cRed fr mr5 xui-hide xa-crossHint">格式不正确，请输入整数</div>
                        <!-- <div class="cRed fr mr5 xui-hide xa-crossHint">消费额区间需逐渐递增，不能交叉</div> -->
                    </div>
                </span>
            </div>
            <div id="rePurchaseAnalysis" class="pr" style="height:400px;top:-60px;"></div>
        </div>
    </div>
     <div class="cb"></div>
</div>
{% endblock %}

{% block js %}
<script type="text/javascript">
    $(document).ready(function(){
        // title提示框
        $('#consumption_help').popover({
            content : "<div class='xui-i-alert'>若区间设为（A，B），则取值包含A,但不包含B</div><div>例如：消费额区间1（元）：<span>10</span>-<span>100</span>则取值包含10，但不包含100</div>",
            trigger : "hover",
            html : true,
            placement : "bottom"
        });

        var is_subscribed = 'all';
        var search_pay_list = [];
        //  本地存储
        var local_search_pay_list = localStorage.getItem('k');
        if(local_search_pay_list){
            search_pay_list = local_search_pay_list.split(',');
            console.log('search_pay_list111111111',search_pay_list)
            search_pay_list.map(function(val,i){
                console.log("^^^^^^^^^",i,val)
                $('.xui-comsumptionNum'+i).val(val);
            });
            rePurchaseAnalysis();
        }

        // 改变会员状态
        $('.xa-memberStateSelect').change(function(){
            var memberState = $(this).children('option:selected').val();
            // alert(memberState)
            is_subscribed = memberState;
            memberBuyPercent();
            rePurchaseAnalysis();
        });

        // 会员购买占比
        function memberBuyPercent(){
            W.getApi().call({
                app: 'stats',
                resource: 'buy_percent',
                method: 'get',
                args: {
                    is_subscribed: is_subscribed
                },
                scope: this,
                success: function(data) {
                    option = {
                        // tooltip : {
                        //     trigger: 'item',
                        //     formatter: "{a} <br/>{b} : {c} ({d}%)"
                        // },
                        calculable : true,
                        series : [
                            {
                                type:'pie',
                                radius : '40%',
                                center: ['50%', '60%'],
                                data: data.series[0].data
                            }
                        ]
                    };
                    var theChart = echarts.init(document.getElementById('memberPurchaseScale'));  
                    theChart.setOption(option); 
                },
                error: function(resp) {
                    alert('获取统计数据失败!');
                }
            });
        }
        memberBuyPercent();

        //复购会员 
        function rePurchaseAnalysis(){
            W.getApi().call({
                app: 'stats',
                resource: 'repeat_buy_analysis',
                method: 'get',
                args: {
                    is_subscribed: is_subscribed,
                    search_pay_list:search_pay_list
                },
                scope: this,
                success: function(data) {
                    option = {
                        // tooltip : {
                        //     trigger: 'item',
                        //     formatter: "{a} <br/>{b} : {c} ({d}%)"
                        // },
                        calculable : true,
                        series : [
                            {
                                type:'pie',
                                radius : '40%',
                                center: ['50%', '60%'],
                                data: data.series[0].data
                            }
                        ]
                    };
                    var theChart = echarts.init(document.getElementById('rePurchaseAnalysis'));  
                    theChart.setOption(option); 
                },
                error: function(resp) {
                    alert('获取统计数据失败!');
                }
            });
        }
        rePurchaseAnalysis();

        var $setConsumptionBtn = $('.xui-setConsumptionBtn');
        var $confirmBtn = $('.xa-confirmBtn');
        var $consumptionBox = $('.xa-consumptionBox');
        var $comsumptionNum = $('.xui-comsumptionNum');
        var $crossHint = $('.xa-crossHint');
        $setConsumptionBtn.click(function() {
            $consumptionBox.show();
            $consumptionBox.toggleClass('xui-hide');
        });
    
        console.log('$comsumptionNum',$comsumptionNum);
        $confirmBtn.click(function(){
            var is_checked = true;
            search_pay_list = [];
            $comsumptionNum.map(function(i,val){
                console.log(i,val.value)
                $('.xui-comsumptionNum'+i).css('border','1px solid #ccc');
                var value = Number(val.value);
                // console.log('value',value);
                var re =  /^[1-9]+[0-9]*]*$/;
                console.log('re.test(value)',re.test(value))
                if(re.test(value) === false){
                    console.log("false~~~~~~~~~~~")
                    $crossHint.text('格式不正确，请输入整数').show();
                    $('.xui-comsumptionNum'+i).css('border','1px solid #DB4343');
                    is_checked = false;
                }
                search_pay_list.push(value);
            });
            console.log('search_pay_list>>>>',search_pay_list)
    
            var minusArr = [];
            for(var i=5; i>=0; i--){
                console.log('>>>>>>>>>>',i,search_pay_list[i]);
                if(i > 0){
                    var minus = search_pay_list[i] - search_pay_list[i-1];
                    console.log('minus',minus);
                    minusArr[i-1] = minus;
                }
            }
            var is_error = false;
            minusArr.map(function(item, idx){
                if (idx % 2 == 0) {
                  if (item <= 0) {
                      is_error = true;
                      is_checked = false;
                      $crossHint.text('消费额区间需逐渐递增，不能交叉').show();
                  }
                } else {
                  if (item < 0) {
                      is_error = true;
                      is_checked = false;
                      $crossHint.text('消费额区间需逐渐递增，不能交叉').show();
                  }
                }
                var nextIndex = idx + 1;
                if(is_error){
                    console.log('idx')
                    $('.xui-comsumptionNum'+idx).css('border','1px solid #DB4343'); 
                    $('.xui-comsumptionNum'+nextIndex).css('border','1px solid #DB4343'); 
                    is_error = false;
                }else {
                    // $('.xui-comsumptionNum'+idx).css('border','1px solid #ccc'); 
                    // $('.xui-comsumptionNum'+nextIndex).css('border','1px solid #ccc'); 
                }         
            });
            if(is_checked){
                $consumptionBox.hide();
                // console.log('search_pay_list',search_pay_list)
                localStorage.setItem('k',search_pay_list)
                rePurchaseAnalysis();
            }
        });

    });
</script>
{% endblock %}
