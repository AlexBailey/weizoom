{% extends "content_base_v2.html" %}

{% block css %}
<style type="text/css">
	#edui_fixedlayer{
		z-index: 100009!important;
	}
	.modal{
		z-index: 100009!important;
	}
	.edui-editor{
		width: 625px!important;
	}
</style>

{% endblock %}
{% block content-panel %}
<div class="xui-members-page">
	<div class="relative">
		<ul class="breadcrumb">
			<li>您当前所在位置</li>
			<li>
				<a href="/member/members/get/">会员管理</a>
			</li>
			<li class="active">会员等级</li>
		</ul>
	</div>

	<div class="xui-content">
		<p class="xui-rightPanelTitle mb10">等级设置</p>
		<form class="xui-mall-addProductForm pl20 pr20 clearfix pr" method="post" id="editForm" >
            <label for="">自动升级条件：</label>
            <input type="radio" name="auto" id="one" class="vm m0" checked><label for="one" class="xui-selectAll mr30">&nbsp;&nbsp;满足一个条件即可</label>
            <input type="radio" name="auto" id="all" class="vm m0"><label for="all" class="xui-selectAll">&nbsp;&nbsp;必须满足全部条件</label>
            <a class="fr xa-tips" href="javascript:void(0);">操作说明</a>
            <ul class="xui-tips hidden xa-tipInfo">
                <li><span>1.</span>不启用自动升级：该等级下的会员不会自动升级为其他等级的会员，需手动调整,但可享受设置的购物折扣。</li>
                <li><span>2.</span> 自动升级：创建完成后，会员满足升级条件时，自动变为该等级会员，无需手动调整；</li>
                <li><span>3.</span>满足一个条件：会员满足升级条件中的任意一个，即可升级为该等级会员；</li>
                <li><span>4.</span> 满足所有条件：会员必须满足所有升级条件，才可升级为该等级会员；</li>
                <li><span>5.</span> 交易金额：已完成的订单的师傅金额（包括微众卡支付的金额）；</li>
                <li><span>6.</span> 购买次数：已完成的订单数；</li>
                <li><span>7.</span> 经验值：累计获得积分总数，积分消费后经验值不减少。</li>
            </ul>
			<table class="table table-bordered table-condensed xb-stripedTable">
				<thead>
					<tr>
						<th width="150">会员等级</th>
						<th width="170">升级模式</th>
						<th width="335">满足条件</th>
						<th>购物折扣</th>
						<th>操作</th>
					</tr>
				</thead>
				<tbody class = 'tags_tbody'>
					{% for grade in member_grades %}
					<tr data-id="{{ grade.id }}" class="domain_data">
						<td class="td-name" width="150">
							<input data-validate="required-none::不能为空"  type="text" class="form-control  xa-grade-name xui-grade"  placeholder="" value="{{ grade.name }}" maxlength="100"/>
                            <div class="errorHint" ></div>
						</td>

                        <td class="td-auto-upgrade" width="170">
							<div class="checkbox">
                            {% if grade.is_default_grade %}
                                自动升级
                            {% else %}
                                {% if grade.is_auto_upgrade %}
                                    <input type="checkbox" class="xa-auto-upgrade" checked value="1" data-id="{{ grade.id }}" id="{{ grade.id }}"><label for="{{ grade.id }}">自动升级</label>
                                {% else %}
                                    <input type="checkbox" class="xa-auto-upgrade" value="0" data-id="{{ grade.id }}" id="{{ grade.id }}"><label for="{{ grade.id }}">自动升级</label>
                                {% endif %}
                            {% endif %}
							</div>
                            <div class="errorHint" >
                            </div>
						</td>

						<td class="td-requirement" width="335">
							{% if grade.is_default_grade %}
								所有关注过您的公众号的用户
							{% else %}
                                {% if grade.is_auto_upgrade %}
                                <div class="xa-requirement-able" data-id="{{ grade.id }}" >
                                    <div><span class="xui-td-span">交易金额￥：</span><input data-validate="require-price" type="text" class="form-control xui-input xa-money" placeholder="" value="{{ grade.pay_money }}" maxlength="100"/><div class="errorHint" data-error-hint="请输入数字"></div></div>
                                    <div><span class="xui-td-span">购买次数：</span><input data-validate="require-nonnegative" type="text" class="form-control xui-input xa-paytimes"  id="grade_paytimes_term_{{grade.id}}" name="grade_paytimes_term_{{grade.id}}" placeholder="" value="{{ grade.pay_times }}" maxlength="100"/><div class="errorHint" data-error-hint="请输入数字"></div></div>
                                    <div><span class="xui-td-span">活动积分：</span><input data-validate="require-nonnegative" type="text" class="form-control xui-input xa-bound" placeholder="" value="{{ grade.upgrade_lower_bound }}" maxlength="100"/><div class="errorHint" data-error-hint="请输入正整数"></div></div>
							    </div >
                                <div class="xa-requirement-disabled" data-id="{{ grade.id }}" style="display: none">
                                    <div><span class="xui-td-span">交易金额￥：</span><input disabled type="text"  class="form-control xui-input"/></div>
                                    <div><span class="xui-td-span">购买次数：</span><input disabled type="text"  class="form-control xui-input"/></div>
                                    <div><span class="xui-td-span">活动积分：</span><input disabled type="text"  class="form-control xui-input"/></div>
                                </div>
                                {% else %}
                                <div class="xa-requirement-able" data-id="{{ grade.id }}" style="display: none">
                                    <div><span class="xui-td-span">交易金额￥：</span><input data-validate="require-price" type="text" class="form-control xui-input xa-money" placeholder="" value="{{ grade.pay_money }}" maxlength="100"/><div class="errorHint" data-error-hint="请输入数字"></div></div>
                                    <div><span class="xui-td-span">购买次数：</span><input data-validate="require-nonnegative" type="text" class="form-control xui-input xa-paytimes"  id="grade_paytimes_term_{{grade.id}}" name="grade_paytimes_term_{{grade.id}}" placeholder="" value="{{ grade.pay_times }}" maxlength="100"/><div class="errorHint" data-error-hint="请输入数字"></div></div>
                                    <div><span class="xui-td-span">活动积分：</span><input data-validate="require-nonnegative" type="text" class="form-control xui-input xa-bound" placeholder="" value="{{ grade.upgrade_lower_bound }}" maxlength="100"/><div class="errorHint" data-error-hint="请输入正整数"></div></div>
							    </div >
                                <div class="xa-requirement-disabled" data-id="{{ grade.id }}">
                                    <div><span class="xui-td-span">交易金额￥：</span><input disabled type="text"  class="form-control xui-input"/></div>
                                    <div><span class="xui-td-span">购买次数：</span><input disabled type="text"  class="form-control xui-input"/></div>
                                    <div><span class="xui-td-span">活动积分：</span><input disabled type="text"  class="form-control xui-input"/></div>
                                </div>
                                {% endif %}
							{% endif %}
						</td>
						<td class="td-discount tc">
                            <input type="text" class="form-control xui-input xa-discount" placeholder="" value="{{ grade.shop_discount }}" maxlength="100"/>
                            <div class="errorHint" data-error-hint="请输入数字"></div>
						</td>
						<td class="td-fouth">
                        {% if grade.is_default_grade %}
							{% else %}
							<a  href="javascript:void(0);" class="delete_tr">
							删除
							</a>
						{% endif %}
						</td>
					</tr>
					{% endfor %}
					<tr data-id="{{ grade.id }}" class="last_tr">
						<td class="w150">
							<a href="javascript:void(0)" class='add_grades'>+添加会员等级</a>
						</td>
						<td></td>
						<td></td>
                        <td></td>
						<td></td>
					</tr>
				</tbody>
			</table>
                <div class="xa-error-hint red tc" style="display: none">
                    等级升级条件必须逐级递增</br>
                    等级折扣必须主机递减或相同
                </div>
				<div class="xui-btn-group tc">
{#					<input type="submit" class="btn btn-primary xa-submit" id="submitBtn" value="保存" />#}
                    <a href="javascript:void(0);" class="btn btn-primary xa-submit">保存</a>
				</div>
		</form>


	</div>
</div>
{% endblock %}

{% block js %}
<script type="text/javascript">

	$(document).ready(function() {

        var data_id = $(".domain_data").last().attr('data-id');
        if (!data_id) {
            data_id = 0;
        }
        $('.add_grades').click(function (event) {
            console.log($(".domain_data").last().attr('data-id'));
            //var data_id = $(".domain_data").last().attr('data-id');
            data_id = parseInt(data_id) + 1;
            var new_data_id = parseInt(data_id) + 1;
            var templ = '<tr data-id="' + new_data_id + '" class="domain_data">'
                            +'<td class="td-name" width="150">'
                                +'<input data-validate="required-none::不能为空"  type="text" class="form-control  xa-grade-name xui-grade" id="grade_id_' + new_data_id + '" name="grade_id_' + new_data_id + '" value="{{ grade.name }}" maxlength="100"/>'
                                +'<div class="errorHint">'
                            +'</td>'
                            +'<td>'
                                +'<div class="checkbox">'
                                    +'<input type="checkbox" class="xa-auto-upgrade" value="0" data-id="' + new_data_id + '" id="' + new_data_id + '"><label for="' + new_data_id + '">自动升级</label>'
                                +'</div>'
                                +'<div class="errorHint" ></div>'
                            +'</td>'
                            +'<td class="td-requirement" width="335">'
                                +'<div class="xa-requirement-able" data-id="' + new_data_id + '" style="display: none">'
                                    +'<div><span class="xui-td-span">交易金额￥：</span><input data-validate="require-price" type="text" class="form-control xui-input xa-money" placeholder="" value="{{ grade.pay_money }}" maxlength="100"/><div class="errorHint" data-error-hint="请输入数字"></div></div>'
                                    +'<div><span class="xui-td-span">购买次数：</span><input data-validate="require-nonnegative" type="text" class="form-control xui-input xa-paytimes"  id="grade_paytimes_term_' + new_data_id + '" name="grade_paytimes_term_' + new_data_id + '" placeholder="" value="{{ grade.pay_times }}" maxlength="100"/><div class="errorHint" data-error-hint="请输入数字"></div></div>'
                                    +'<div><span class="xui-td-span">活动积分：</span><input data-validate="require-nonnegative" type="text" class="form-control xui-input xa-bound" placeholder="" value="{{ grade.upgrade_lower_bound }}" maxlength="100"/><div class="errorHint" data-error-hint="请输入正整数"></div></div>'
                                +'</div>'
                                +'<div class="xa-requirement-disabled" data-id="' + new_data_id + '">'
                                    +'<div><span class="xui-td-span">交易金额￥：</span><input disabled type="text"  class="form-control xui-input"/></div>'
                                    +'<div><span class="xui-td-span">购买次数：</span><input disabled type="text"  class="form-control xui-input"/></div>'
                                    +'<div><span class="xui-td-span">活动积分：</span><input disabled type="text"  class="form-control xui-input"/></div>'
                                +'</div>'
                            +'</td>'
                            +'<td class="td-discount tc">'
                                +'<input type="text" class="form-control xui-input xa-discount" placeholder="" value="{{ grade.shop_discount }}" maxlength="100"/>'
                                +'<div class="errorHint" data-error-hint="请输入数字"></div>'
                            +'</td>'
                            +'<td class="td-fouth">'
                                +'<a href="javascript:void(0);" class="delete_tr">删除</a>'
                            +'</td>'
                        +'</tr>';
            $(".tags_tbody .last_tr").before(templ);
        });

        $('tbody').delegate('.delete_tr', 'click', function (event) {
            var $el = $(event.currentTarget);
            var msg = "删除后，该等级下的所有会员将划分至其满足升级条件的等级！";
            W.requireConfirm({
                $el: $el,
                width:425,
                height:72,
                position:'top',
                isTitle: false,
                msg: msg,
                show_icon:false,
                confirm: function(){
                    $el.parents('tr').remove();
                    $(this).close();
                }
            });
        });

        // 自动升级
        $('tbody').delegate('.xa-auto-upgrade', 'click', function (event) {
            var $el = $(event.currentTarget);
            var value = $el.attr("value");
            var id = $el.attr("data-id");

            console.log("check_value",value);

            if(value == '1') {
                // 取消自动升级
                value = 0;
                $('div[data-id=' + id + '].xa-requirement-able').hide();
                $('div[data-id=' + id + '].xa-requirement-disabled').show();
            }
            else {
                // 开启自动升级
                value = 1;
                $('div[data-id=' + id + '].xa-requirement-able').show();
                $('div[data-id=' + id + '].xa-requirement-disabled').hide();
{#                $el.find('.xa-requirement-able').show();#}
{#                $el.find('.xa-requirement-disabled').hide();#}
            }
            $el.attr("value",value);
        });
        $('.xa-tips').mouseover(function(event) {
            $('.xa-tipInfo').removeClass('hidden');
        });
        $('.xa-tips').mouseleave(function(event) {
            $('.xa-tipInfo').addClass('hidden');
        });




        $('body').delegate('.xa-submit', 'click', function (event) {
            if (!W.validate()) {
                $(".xa-error-hint").show();
                return false;
            }
            var tr_list = $("tr.domain_data");
            var grades = [];
            tmp_money = 0;
            tmp_paytimes = 0;
            tmp_bound = 0;
            tmp_discount = $(tr_list[0]).find('input.xa-discount').attr("value");




{#            xlog(tmp_discount);#}

            console.log("------------------------_---------------------------");


            var id;
            var name;
            var is_auto_upgrade;
            var money;
            var paytimes;
            var bound;
            var discount;

            for(var i=0;i<tr_list.length;i++)
            {
                is_auto_upgrade = tr_list.eq(i).find('input.xa-auto-upgrade').attr("value");

                id =tr_list.eq(i).attr("data-id");
                name = tr_list.eq(i).find('input.xa-grade-name').attr("value");


                if(i==0) {
                    money = 0;
                    paytimes = 0;
                    bound = 0;
                }
                else{
                    money = tr_list.eq(i).find('input.xa-money').attr("value");
                    paytimes = tr_list.eq(i).find('input.xa-paytimes').attr("value");
                    bound = tr_list.eq(i).find('input.xa-bound').attr("value");
                }


                discount = tr_list.eq(i).find('input.xa-discount').attr("value");


                grades.push({ 'id': id,  'name': name, 'is_auto_upgrade':is_auto_upgrade, 'money':money, 'paytimes':paytimes, 'bound':bound, 'discount':discount});
                console.log(name,is_auto_upgrade)

            }


{#            tr_list.each(function () {#}
{#                var id =$(this).attr("data-id");#}
{#                var name = $(this).find('input.xa-grade-name').attr("value");#}
{#                var is_auto_upgrade = $(this).find('input.xa-auto-upgrade').attr("value");#}
{##}
{#                var money = $(this).find('input.xa-money').attr("value");#}
{#                var paytimes = $(this).find('input.xa-paytimes').attr("value");#}
{#                var bound = $(this).find('input.xa-bound').attr("value");#}
{#                var discount = $(this).find('input.xa-discount').attr("value");#}
{#                console.log(id,name, is_auto_upgrade, money, paytimes, bound, discount);#}
{##}
{#                xlog("######")#}
{#                console.log(money,"uuu",tmp_money);#}
{#                console.log(money);#}
{#                if(money<tmp_money){#}
{#                    console.log("<<<<<<<<");#}
{#                    $(".xa-error-hint").show();#}
{#                    return false;#}
{#                }#}
{#                else{#}
{#                    tmp_money=money;#}
{#                }#}
{##}
{#                grades.push({ 'id': id,  'name': name, 'is_auto_upgrade':is_auto_upgrade, 'money':money, 'paytimes':paytimes, 'bound':bound, 'discount':discount});#}
{#            });#}


            xlog(JSON.stringify(grades))

            W.getApi().call({
                    method: 'post',
                    app: 'mall2',
                    resource: 'member_grade_list',
                    args: {'json': JSON.stringify(grades)},
                    success: function(data) {
                        //window.location.reload();
                        W.showHint('success', '保存成功');
                    },
                    error: function() {
                        }
                })



        });

            {#        #}
{#            		$('#editForm').submit(function() {#}
{#            			if (!W.validate()) {#}
{#            				return false;#}
{#            			}#}
{#            			var $tagName = $('input.xa-grade-name');#}
{#            			var flag = true;#}
{#            			$tagName.each(function(i, value) {#}
{#            				console.log(value)#}
            {#				var tag_name = value.value;#}
            {#				console.log(tag_name)#}
            {#				if (!$.trim(tag_name)) {#}
            {#					flag = false;#}
            {#					return false;#}
            {#				}#}
            {#			});#}
            {#			if (!flag) {#}
            {#				W.showHint('error', '请输入会员等级名称');#}
            {#				return false;#}
            {#			}#}
            {#			W.showHint('success', '保存成功');#}
            {#		});#}





            {#        for(var i=0;i<tr_list.length;i++)#}
            {#        {#}
            {#            console.log("zzzzzz")#}
            {#            console.log(i.attr("data-id"));#}
            {#            console.log(tr_list.eq(i).attr("data-id"))#}
            {#            console.log(tr_list.eq(i))#}
            {#        }#}



    });
</script>
{% endblock %}