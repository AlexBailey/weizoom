# -*- coding: utf-8 -*-

EMOTIONNAME2TITLE = {
	'1.gif': u'微笑',
	'2.gif': u'撇嘴',
	'3.gif': u'色',
	'4.gif': u'发呆',
	'5.gif': u'得意',
	'6.gif': u'流泪',
	'7.gif': u'害羞',
	'8.gif': u'闭嘴',
	'9.gif': u'睡',
	'10.gif': u'大哭',
	'11.gif': u'尴尬',
	'12.gif': u'发怒',
	'13.gif': u'调皮',
	'14.gif': u'呲牙',
	'15.gif': u'惊讶',
	'16.gif': u'难过',
	'17.gif': u'酷',
	'18.gif': u'冷汗',
	'19.gif': u'抓狂',
	'20.gif': u'吐',
	'21.gif': u'偷笑',
	'22.gif': u'可爱',
	'23.gif': u'白眼',
	'24.gif': u'傲慢',
	'25.gif': u'饥饿',
	'26.gif': u'困',
	'27.gif': u'惊恐',
	'28.gif': u'流汗',
	'29.gif': u'憨笑',
	'30.gif': u'大兵',
	'31.gif': u'奋斗',
	'32.gif': u'咒骂',
	'33.gif': u'疑问',
	'34.gif': u'嘘',
	'35.gif': u'晕',
	'36.gif': u'折磨',
	'37.gif': u'衰',
	'38.gif': u'骷髅',
	'39.gif': u'敲打',
	'40.gif': u'再见',
	'41.gif': u'擦汗',
	'42.gif': u'抠鼻',
	'43.gif': u'鼓掌',
	'44.gif': u'糗大了',
	'45.gif': u'坏笑',
	'46.gif': u'左哼哼',
	'47.gif': u'右哼哼',
	'48.gif': u'哈欠',
	'49.gif': u'鄙视',
	'50.gif': u'委屈',
	'51.gif': u'快哭了',
	'52.gif': u'阴险',
	'53.gif': u'亲亲',
	'54.gif': u'吓',
	'55.gif': u'可怜',
	'56.gif': u'菜刀',
	'57.gif': u'西瓜',
	'58.gif': u'啤酒',
	'59.gif': u'篮球',
	'60.gif': u'乒乓',
	'61.gif': u'咖啡',
	'62.gif': u'饭',
	'63.gif': u'猪头',
	'64.gif': u'玫瑰',
	'65.gif': u'凋谢',
	'66.gif': u'示爱',
	'67.gif': u'爱心',
	'68.gif': u'心碎',
	'69.gif': u'蛋糕',
	'70.gif': u'闪电',
	'71.gif': u'炸弹',
	'72.gif': u'刀',
	'73.gif': u'足球',
	'74.gif': u'瓢虫',
	'75.gif': u'便便',
	'76.gif': u'月亮',
	'77.gif': u'太阳',
	'78.gif': u'礼物',
	'79.gif': u'拥抱',
	'80.gif': u'强',
	'81.gif': u'弱',
	'82.gif': u'握手',
	'83.gif': u'胜利',
	'84.gif': u'抱拳',
	'85.gif': u'勾引',
	'86.gif': u'拳头',
	'87.gif': u'差劲',
	'88.gif': u'爱你',
	'89.gif': u'NO',
	'90.gif': u'OK',
	'91.gif': u'爱情',
	'92.gif': u'飞吻',
	'93.gif': u'跳跳',
	'94.gif': u'发抖',
	'95.gif': u'怄火',
	'96.gif': u'转圈',
	'97.gif': u'磕头',
	'98.gif': u'回头',
	'99.gif': u'跳绳',
	'100.gif': u'挥手',
	'101.gif': u'激动',
	'102.gif': u'街舞',
	'103.gif': u'献吻',
	'104.gif': u'左太极',
	'105.gif': u'右太极'
}

TITLE2EMOTION = {
	u'微笑': '1.gif',
	u'撇嘴': '2.gif',
	u'色': '3.gif',
	u'发呆': '4.gif',
	u'得意': '5.gif',
	u'流泪': '6.gif',
	u'害羞': '7.gif',
	u'闭嘴': '8.gif',
	u'睡': '9.gif',
	u'大哭': '10.gif',
	u'尴尬': '11.gif',
	u'发怒': '12.gif',
	u'调皮': '13.gif',
	u'呲牙': '14.gif',
	u'惊讶': '15.gif',
	u'难过': '16.gif',
	u'酷': '17.gif',
	u'冷汗': '18.gif',
	u'抓狂': '19.gif',
	u'吐': '20.gif',
	u'偷笑': '21.gif',
	u'可爱': '22.gif',
	u'白眼': '23.gif',
	u'傲慢': '24.gif',
	u'饥饿': '25.gif',
	u'困': '26.gif',
	u'惊恐': '27.gif',
	u'流汗': '28.gif',
	u'憨笑': '29.gif',
	u'大兵': '30.gif',
	u'奋斗': '31.gif',
	u'咒骂': '32.gif',
	u'疑问': '33.gif',
	u'嘘': '34.gif',
	u'晕': '35.gif',
	u'折磨': '36.gif',
	u'衰': '37.gif',
	u'骷髅': '38.gif',
	u'敲打': '39.gif',
	u'再见': '40.gif',
	u'擦汗': '41.gif',
	u'抠鼻': '42.gif',
	u'鼓掌': '43.gif',
	u'糗大了': '44.gif',
	u'坏笑': '45.gif',
	u'左哼哼': '46.gif',
	u'右哼哼': '47.gif',
	u'哈欠': '48.gif',
	u'鄙视': '49.gif',
	u'委屈': '50.gif',
	u'快哭了': '51.gif',
	u'阴险': '52.gif',
	u'亲亲': '53.gif',
	u'吓': '54.gif',
	u'可怜': '55.gif',
	u'菜刀': '56.gif',
	u'西瓜': '57.gif',
	u'啤酒': '58.gif',
	u'篮球': '59.gif',
	u'乒乓': '60.gif',
	u'咖啡': '61.gif',
	u'饭': '62.gif',
	u'猪头': '63.gif',
	u'玫瑰': '64.gif',
	u'凋谢': '65.gif',
	u'示爱': '66.gif',
	u'爱心': '67.gif',
	u'心碎': '68.gif',
	u'蛋糕': '69.gif',
	u'闪电': '70.gif',
	u'炸弹': '71.gif',
	u'刀': '72.gif',
	u'足球': '73.gif',
	u'瓢虫': '74.gif',
	u'便便': '75.gif',
	u'月亮': '76.gif',
	u'太阳': '77.gif',
	u'礼物': '78.gif',
	u'拥抱': '79.gif',
	u'强': '80.gif',
	u'弱': '81.gif',
	u'握手': '82.gif',
	u'胜利': '83.gif',
	u'抱拳': '84.gif',
	u'勾引': '85.gif',
	u'拳头': '86.gif',
	u'差劲': '87.gif',
	u'爱你': '88.gif',
	u'NO': '89.gif',
	u'OK': '90.gif',
	u'爱情': '91.gif',
	u'飞吻': '92.gif',
	u'跳跳': '93.gif',
	u'发抖': '94.gif',
	u'怄火': '95.gif',
	u'转圈': '96.gif',
	u'磕头': '97.gif',
	u'回头': '98.gif',
	u'跳绳': '99.gif',
	u'挥手': '100.gif',
	u'激动': '101.gif',
	u'街舞': '102.gif',
	u'献吻': '103.gif',
	u'左太极': '104.gif',
	u'右太极': '105.gif'
}


#############################################################################
# change_emotion_to_img: 将内容中的表情转换为图片
#############################################################################
def change_emotion_to_img(content):
	beg = 0
	items = []
	while True:
		pos = content.find('/', beg)
		if pos == -1:
			break

		found_emotion = False
		for i in range(1, 4):
			emotion_title = content[pos+1:pos+1+i]
			if emotion_title in TITLE2EMOTION:
				emotion_gif = '<img src="/static/ueditor-1.2.6.1/dialogs/emotion/images/weixin/%s" />' % TITLE2EMOTION[emotion_title]
				items.append(content[:pos])
				items.append(emotion_gif)
				content = content[pos+1+i:]
				beg = 0
				found_emotion = True
				break
		if not found_emotion:
			beg = pos + 1

	if content:
		items.append(content)
	return ''.join(items)



from HTMLParser import HTMLParser
class MyHTMLParser(HTMLParser):
	def __init__(self):
		HTMLParser.__init__(self)
		self.links = []

	def handle_starttag(self, tag, attrs):
		#print "Encountered the beginning of a %s tag" % tag
		if tag == "img":
			if len(attrs) == 0:
				pass
			else:
				for (variable, value)  in attrs:
					if variable == "src":
						self.links.append(value)

def get_img_tags(text):
	hp = MyHTMLParser()
	hp.feed(text)
	hp.close()
	return hp.links

#############################################################################
# change_img_to_emotion: 将内容中的图片转换为表情
#############################################################################
def change_img_to_emotion(content):
	if content.find('/static/ueditor-1.2.6.1/dialogs/emotion/images/weixin') > -1:
		src_lists = get_img_tags(content)
		img_name_list = EMOTIONNAME2TITLE.keys()
		for src in src_lists:
			try:
				if src and src.split('/')[-1] in img_name_list:
					try:
						emotion_name = u"/%s" % EMOTIONNAME2TITLE[src.split('/')[-1]].encode('utf-8')
					except Exception, e:
						emotion_name = u"/%s" % EMOTIONNAME2TITLE[src.split('/')[-1]]
					
					image_url = '<img src="%s"/>' % src
					image_url_blank = '<img src="%s" />' % src
					content = content.replace(image_url, emotion_name).replace(image_url_blank, emotion_name)
			except:
				pass
	if content.find('<p>') > -1:
		content = content.replace('<p>', '').replace('</p>', '')
	return content
