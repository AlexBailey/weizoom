{% extends "content_base_v2.html" %}
{% load common_tag %}
{% load account_filter %}

{% block content-panel %}
<div class="xui-weixin-qrcodePage xa-weixin-materialsPage">
	<div class="xui-rightPanel pr" style="border:0;">
<ul class="breadcrumb">
	<li>您当前所在位置</li>
	<li>
		<a href="/new_weixin/materials/">高级管理</a>
	</li>
	<li><a href="/new_weixin/qrcodes/">带参数二维码</a></li>
	<li class="active">{% if qrcode.id %}编辑{% else %}新建{% endif %}二维码</li>
</ul>

<form class="form-horizontal" method="post" id="editForm" action="/new_weixin/api/qrcode/">
	<fieldset>
		<input id="qrcode_id" name="qrcode_id" class="hide" value="{% if qrcode %}{{qrcode.id}}{% else %}0{% endif %}">
		<div class="control-group mt20 mb15 pl10" >
			<label class="control-label fl mr10" for="parents_name">二维码名称</label>
			<div class="controls"> 
				<input type="text" class="input-xlarge mt3" id="name" name="name" placeholder="输入名称" value="{% if qrcode %}{{ qrcode.name }}{% endif %}" data-validate="required-none" data-validate-name="{{ qrcode.id }}" />
				<div class="errorHint"></div>
			</div>
		</div>
		<div class="xui-setting mb100 pb100 ml10 mr10">
				<div class="xui-row pr" style="border-bottom: none;">
					<div class="xui-i-left fl"> 扫码奖励： </div>
					<div class=" fl mt18 ml20">
						<div class="controls" id="prize_selector" data-ui-role="prize-selector" data-init-prizeinfo='{% if qrcode %}{{ qrcode.award_prize_info|safe }}{% else %}{% endif %}'></div>
					<input id="prize_info" name="prize_info" class="hide" value=""><span class="xui-i-remark">只有通过本次扫码新关注的会员获得奖励</span>
					</div>
				</div>
				<div class="xui-row">
					<div class="xui-i-left fl lh1">成为指定等级会员： </div>
					<div class="fl mt20 ml10"> 
						<select class="ml10" name="group_id" id="group_id" data-validate="require-select">
						{% for group in groups %}
							<option value="{{group.id}}"{% if qrcode.grade_id == group.id %}selected="selected"{% endif%}>{{group.name}}</option>
						{% endfor %}
				</select>
					</div>
				</div>
				<div class="xui-row" style="border-bottom: none;border-top:none;">
					<div class="xui-i-left fl lh1"> 已关注会员可参与： </div>
					<div class=" fl mt18 ml20">
					<input type="radio" value="1" {% if qrcode %}{% ifequal qrcode.re_old_member 1 %}checked{% endifequal %}{% else %}checked{% endif %} style="vertical-align: sub;" class="re_old_member" name="re_old_member" id="not_re_old_member">是

					<input type="radio" value="0" {% if qrcode %}{% ifequal qrcode.re_old_member 0 %}checked{% endifequal %}{% else %}checked{% endif %} style="vertical-align: sub;" class="re_old_member ml10" name="re_old_member" id="re_old_member" class="m10 p20" value='0'>&nbsp; 否
					</div>
				</div>
				<div class="xui-row" style="border-bottom: none;">
					<div class="xui-i-left fl lh1"> 备注： </div>
					<div class=" fl mt18 ml20">
						<input style="width:448px;" type="text" id="remark" name="remark" value="{% if qrcode %}{{ qrcode.remark }}{% endif %}">
					</div>
				</div>
			</div>
<!-- 			<div class="xui-setting ml10 mr10 mt80"> -->
			<div class="xui-Sweep1 mt20 disT" style="">
					<div class="xui-i-left lh42 tr xui-Sweep pr10 disTc vt" style="width:133px;">扫码后回复：</div>
					<div class="fl" id="prize_qrcode"> 
						<div id="edit-message-panel"></div>
					</div>
				<!-- </div> -->
			</div>
			<div class="tab-content" style="margin: 20px 0 5px 160px;">
				<div id="weixinMessageEdite r-textMessageZone" style="width: 350px">
					<div class="control-group mr5 mt5">
						<div class="controls ml20">
							<textarea class="input-xlarge hide" id="reply_detail" name="reply_detail" data-ui-role="richtext-editor" data-height="300" data-width="350">{% if qrcode %}{{ qrcode.reply_detail|format_emotion|safe }}{% endif %}</textarea>
						</div>
					</div>
				</div>

				<div id="weixinMessageEditer-newsMessageZone" style="width: 350px">
					<input id="reply_material_id" name="reply_material_id" class="hide" value="">
				</div>
			</div>

		</div>
		<div class="xui-footerBtn xa-footerBtn">
			<input type="buttom" class="btn btn-success w105 h30 mr20 xa-submit" id="submitBtn" value="保&nbsp;&nbsp;存">
			<input type="buttom" class="btn btn-defalte w105 h30 xa-cancel" style="background:#fff;" id="submitBtn" value="取&nbsp;&nbsp;消">
		</div>
		</div>
		
	</fieldset>

	<fieldset>
		<legend></legend>
	</fieldset>
</form>
</div>
</div>
{% endblock %}

{% block dialog %}
{% endblock %}

{% block js %}
<script type="text/javascript">
	$(document).ready(function() {
		$(".xa-footerBtn").delegate('.xa-cancel','click',function() {
			window.location.href="/new_weixin/qrcodes/";
		});
		
		//提交二维码表单
		$(".xa-footerBtn").delegate('.xa-submit','click',function() {
			var name = $.trim($('[name="name"]').val());
			if(name==''){
				W.showHint('error', '二维码名称不能为空');
				return false;
			}
			
			var textContent = $.trim($('[name="text_content"]').val());
			var materialId = 0;
			var chose = $(".xa-choseCoupon").html();
			if(chose == "添加"){
				W.showHint('error', '优惠券内容不能为空');
				return false;
			}

			var materialStr = $('.xa-newsMessageZone a').attr('href');
			if (materialStr && materialStr.length > 0) {
				var strs = materialStr.split("?");
				var str = strs[1];
				paramFields = str.split("=");
				materialId = parseInt(paramFields[1]);
			}

			if (!textContent && materialId == 0) {
				W.showHint('error', '扫码后回复内容不能为空');
				return;
			}
			if(materialId == 0 && textContent.length > 600){
				W.showHint('error', '扫码后回复内容不能超过600字');
				return;
			}

			var replyType = 0;
			if(materialId > 0) {
				replyType = 2;
				textContent = '';
			} else {
				replyType = 1;
			}

			var prize_info = JSON.stringify($('#prize_selector').data('view').getPrizeInfo());
			var args = new Object();
			var qrcode_id = $.trim($('#qrcode_id').val());
			if(qrcode_id=="0") 
			{
				methodstr="put"; 
				args.setting_id=-1;
			} else {
				methodstr="post";
				args.setting_id=qrcode_id;
			};
			
			var remark = $.trim($('[name="remark"]').val());
			var grade_id = $.trim($('[name="group_id"]').val());
			var re_old_member = $('input[name="re_old_member"]:checked').val();
			if (methodstr == 'post'){
				W.resource.new_weixin.Qrcode.post({
					data:{
						name: name,
						setting_id: qrcode_id,
						prize_info: prize_info,
						grade_id: grade_id,
						remark: remark,
						reply_type: replyType,
						reply_detail: textContent,
						reply_material_id: materialId,
						re_old_member: re_old_member
					},
					success: function(data) {
						W.showHint('success', '保存成功');
						window.location.href="/new_weixin/qrcodes/";
					},
					error: function(resp) {
						W.showHint('error', '保存失败！');
					}
				});
			}
			if (methodstr == 'put'){
				W.resource.new_weixin.Qrcode.put({
					data:{
						name: name,
						setting_id: qrcode_id,
						prize_info: prize_info,
						reply_type: replyType,
						grade_id: grade_id,
						remark: remark,
						reply_type: replyType,
						reply_detail: textContent,
						reply_material_id: materialId,
						re_old_member: re_old_member
					},
					success: function(data) {
						W.showHint('success', '保存成功');
						window.location.href="/new_weixin/qrcodes/";

					},
					error: function(resp) {
						W.showHint('error', '保存失败！');
					}
				});
			}
			
		});
		

		var answerContent = W.loadJSON('qrcode_answer');
		var options = {
			el: '#edit-message-panel',
			richTextEditorWidth: 800,
			enableSubmitBtn: 'false',
			enableCanelBtn: 'false'
		}
		if (answerContent) {
			if (answerContent.type === 'text') {
				options.answer = answerContent.content;
			} else if (answerContent.type === 'news') {
				options.materialId = answerContent.content;
				options.material = answerContent;
			}
		}
		var editor = new W.view.weixin.MessageEditor(options);
		$(document).delegate('.xa-choseCoupon', 'click', function(event) {
        W.dialog.showDialog('W.dialog.mall.SelectCouponDialog', {
            success: function(data) {
                var couponType = '';
                if(data[0].limit_product) {
                    couponType = "(单品券)";
                }else{
                    couponType = "(全店通用券)";
                }
                selectCouponMoney = data[0].money;
                couponRuleId = data[0].id;
                remainedCount = data[0].remained_count;
                xlog(data);
                $(".xa-couponName").text(data[0].name+couponType);
                $(".xa-couponName").addClass('w160');
                $(".xa-choseCoupon").text("修改");
                $(".xa-choseCoupon").addClass('xui-firefoxhuk')
                $('.xui-remaining').text('');

                $('.xa-couponName').attr('data-id', data[0].id);
                $('.xa-couponName').attr('data-name', data[0].name);

                $('.xui-i-col').append('<div class="xui-remaining tl" style="margin-right:-142px;color:#979292;">优惠券剩余库存' + remainedCount + '张</div>')
                var count = $("#selectCouponCount  option:selected").text();
                var totalMoney = parseFloat(selectCouponMoney) * parseInt(count);
                $(".xa-totalMoney").text("总价值："+ totalMoney.toFixed(2) +"元");
            },
            error: function(data) {}
        });
        });

	});
</script>
{% endblock %}
