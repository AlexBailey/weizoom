{% extends "content_base_v2.html" %}

{% block content-panel %}
<div class="xui-memberListPage">

	<div class="relative">
		<ul class="breadcrumb">
			<li>您当前所在位置</li>
			<li><a href="/new_weixin/materials/">高级管理</a></li>
			<li><a href="/new_weixin/qrcodes/">带参数二维码</a></li>
			<li class="active">关注粉丝</li>
		</ul>
	</div>
	<div class="panel panel-default xb-rightPanel pr">
		<div class="panel-heading">
			<!-- <a class="xui-tipBox fr">
			如何对数据排序<b class="xui-tip">?</b></a> -->
		</div>
		<div 
			data-ui-role="advanced-table" 
			data-app="new_weixin"
			data-args='{"setting_id": {{ setting_id }} }'
			data-resource="qrcode_member"
			data-template-id="#members-view"
			data-enable-paginator="true" 
			data-enable-sort="false" 
			data-selectable="false" 
			data-item-count-per-page="50" 
			class="panel-body"
		></div>
	</div>
</div>
{% endblock %}


{% block js %}
{% verbatim %}
<script id="members-view" type="text/x-jquery-tmpl">
	<table class="table table-bordered xui-productList xb-stripedTable xb-noTdBorder xb-noBottom xb-noBorder xb-theadBg xui-qrcode-table" >
		<thead>
		<tr>
			<th >粉丝</th>
			<th  class="tx_sortable" style="width:15%" data-sort-attr='integral' >积分</th>
			<th style="width:20%">会员等级</th>
			<th  class="tx_sortable " style="width:20%" data-sort-attr='created_at' data-init-sort="-created_at" >关注时间</th>
		</tr>
		</thead>
		<tbody>
		
		{{each(i, member) items}}
		<tr class='h60' data-id="${member.id}">
			<td style="position:relative;">
				<div class="xui-memberHeader fl pl30">
					{{if member.is_subscribed == 0}}
                        <div class="xui-cancelCover tc pa">
                        	<span>已跑路</span>
                        </div>
					{{/if}}
					<a href="/member/member_detail/edit/?id=${ member.id }" target='_blank'>
						<img src="{{if member.user_icon}}${ member.user_icon }{{else}}/static/img/user-1.jpg{{/if}}" onerror="this.src='/static/img/user-1.jpg'"/>
					</a>
				</div>
				<div class="fl xui-i-fansName">
					<a class='lh26 xui-i-link' href="/member/member_detail/edit/?id=${ member.id }" target='_blank'>
						{{html member.username}}
						{{if member.name !== ''}}
							(${member.name})
						{{/if}}
					</a>
				</div>
			</td>
			<td>
				<div class="centerAlign">${ member.integral }</div>
			</td>
			<td>
				<div class="centerAlign">${ member.grade_name }</div>
			</td>
			<td>
				<div class="centerAlign">${ member.follow_time }</div>
			</td>
		</tr>
		{{/each}}
		</tbody>
	</table>

</script>
{% endverbatim %}

<script type="text/javascript">	
$(document).ready(function() {
	$('#all').attr('checked', false);

	$('.update_dropdown').delegate('#all', 'click', function(event){
		var $checkbox = $(event.currentTarget);
        var isChecked = $checkbox.is(':checked');
        $('tbody .xa-select,.xa-selectAll').prop('checked', isChecked);

	});

	$('.panel-body').delegate('.xa-selectAll', 'click', function(event){
		var $checkbox = $(event.currentTarget);
        var isChecked = $checkbox.is(':checked');
        $('tbody .xa-select,#all').prop('checked', isChecked);
	});

	var view = new W.view.member.memberFilterView ({
		el: '.xui-filterPanel',
		dataView: $('[data-ui-role="advanced-table"]').data('view'),
		userWebappId: {{user.get_profile.webapp_id}},
		status:''
	});
	view.$el.bind('end_click', function(){
		DATA_INTERVAL = '';
	});
	// 修改等级
	$('body').delegate('.xa-update-grade', 'click', function(event){		
		var $el = $(event.currentTarget);
		var member_id = $el.attr('data-id');
		
		var memberTagsUpdateView = W.getMemberTagsUpdateView({
			width: 260,
			title: '修改等级',
			position:'top',
			isTitle: false,
			privateContainerClass:'xui-updateGradeOrTagBox'
		});
		memberTagsUpdateView.show({
			$action: $el,
			isUpdateGrade: true,
			memberId: member_id,
			isPostData: true
		})
        memberTagsUpdateView.render();
	});
	// 修改分组
	$('body').delegate('.xa-update-tag', 'click', function(event){
		var $el = $(event.currentTarget);
		var member_id = $el.attr('data-id');
		
		var memberTagsUpdateView = W.getMemberTagsUpdateView({
			width: 260,
			title: '修改分组',
			position:'top',
			isTitle: false,
			privateContainerClass:'xui-updateGradeOrTagBox'
		});
		memberTagsUpdateView.show({
			$action: $el,
			isUpdateGrade: false,
			memberId: member_id,
			isPostData: true
		})
        memberTagsUpdateView.render();
	});

	// 修改等级
	$('.update_dropdown').delegate('.update-grade', 'click', function(event){
		var post_ids = [];
		var grade_id = $(this).attr('data-id');
	 	$('input.xa-select:checked').each(function(){ 
    		console.log($(this).parent().parent().attr('data-id'))
    		post_ids.push($(this).parent().parent().attr('data-id'))
  			}); 
	 	if (grade_id && post_ids.length > 0) {
	 		W.getApi().call({
	            method: 'post',
	            app: 'member',
	            api: 'grade/batch_update',
	            args:{ids:post_ids.join('-'), grade_id:grade_id},
	            success: function(data) {
	                 window.location.reload();
	            },
	            error: function(response) {
	                W.getErrorHintView().show('加载失败！请刷新页面重试！');
	            },
	            scope: this
	        });
	 	}
	});
	// 修改分组
	$('.update_dropdown').delegate('.update-tag', 'click', function(event){
		var post_ids = [];
		var tag_id = $(this).attr('data-id');
	 	$('input.xa-select:checked').each(function(){ 
    		console.log($(this).parent().parent().attr('data-id'))
    		post_ids.push($(this).parent().parent().attr('data-id'))
  			}); 
	 	if (tag_id && post_ids.length > 0) {
	 		W.getApi().call({
	            method: 'post',
	            app: 'member',
	            api: 'tag/batch_update',
	            args:{ids:post_ids.join('-'), tag_id:tag_id},
	            success: function(data) {
	                 window.location.reload();
	            },
	            error: function(response) {
	                W.getErrorHintView().show('加载失败！请刷新页面重试！');
	            },
	            scope: this
	        });
	 	}
	});

	// 修改积分
	$('.panel-body').delegate('.xa-update-integral', 'click', function(event){

		var $el = $(event.currentTarget);
		var member_id = $el.attr('data-id');
		
		var memberIntegralUpdateView = W.getMemberIntegralUpdateView({
			width: 310,
			title: '调积分',
			position:'top',
			isTitle: false,
			privateContainerClass:'xui-updateGradeOrTagBox'
		});
		memberIntegralUpdateView.show({
			$action: $el,
			memberId: member_id,
		})
        memberIntegralUpdateView.render();
		
	});

	// 导出
	$('.panel-body').delegate('.xa-export', 'click', function(event){	
		var url = '/member/members/export/';
		if (view.filter_value) {
			url = url + '?filter_value='+view.filter_value;
		}
		console.log(url, view.filter_value)
		W.getErrorHintView().show("'玩命导出中...'");
		var $frame=$('<iframe>').hide().attr('src',url);
		$('body').append($frame);
		setTimeout(function(){W.getErrorHintView().hide()}, 5000);
	});

	$('.panel').delegate('.relation-text', 'click', function(event) {
					var _this = this;
					var $el = $(event.currentTarget);
					console.log($el);

					var friend_count = $el.attr('friend_count');
					var fans_count = $el.attr('fans_count');
					var memberId = $el.attr('value');
					if ($el.html() == '0') {
						return false;
					}

					W.dialog.showDialog('W.dialog.member.RelationsDialog', {
						memberId: memberId,
						friendCount: friend_count,
						fansCount: fans_count,
						isReload:true,
		          	});
			});
});
</script>
{% endblock %}