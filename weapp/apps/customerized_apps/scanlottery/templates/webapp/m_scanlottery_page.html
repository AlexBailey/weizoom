{% extends "apps_base.html" %}

{% block css %}
<style type="text/css">
    html,body {
        height: 100%;
        font-family: "黑体";
        background: #fff !important;
    }
    .wui-hidden {
        display: none;
    }
    .wui-scanlottery-page {
        position: relative;
        height: 100%;
        background: url(/termite_static/img/component/scanlottery/m_lottery_bg.jpg) no-repeat;
        background-size: 100% auto;
    }
    .wui-scanlottery-title {
        height: 17rem;
    }
    .wui-scanlottery-container {
        width: 70%;
        margin: 0 auto;
        text-align: center;
        font-size: 0;
    }
    .wui-scanlottery-container > div {
        text-align: center;
        margin-bottom: 20px;
    }
    .wui-scanlottery-container .wui-scanlottery-btn {
        border:none;
        border-radius: .1rem;
        height: 3rem;
        line-height: 3rem;
        color: #fff;
        width: 70%;
        font-size: 1.1rem;
        outline: none;
        background: #df002e;
        font-family: "黑体";
        margin-top: 10px;
    }  
    .wui-scanlottery-container input {
        border: 1px solid #dbdbdb;
        box-sizing: border-box;
        font-size: 1.1rem;
        height: 3rem;
        line-height: 3rem;
        border-radius: .3rem;
        width: 100%;
        outline: none;
        padding: 0 0 0 1rem;
        font-family: "黑体";
    }
    .wui-scanlottery-container .wui-verify-input {
        width: 37%;
        margin-right: 5%;
    }
    .wui-scanlottery-container .wui-verify-container {
        width: 28%;
        height: 3rem;
        display: inline-block;
        vertical-align: top;
    }
    .wui-scanlottery-container .wui-verify-refresh {
        width: 100%;
        height: 2.4rem;
        margin-top: 5px;
        pointer-events: none; 
    }
    .wui-scanlottery-container > p {
        margin-top: 2rem;
        font-size: 1rem;
        text-align: left;
        color: #24326a;
    }
    .wui-verify-btn {
        font-size: 1rem;
        height: 3rem;
        line-height: 3rem;
        color: #24326a;
        display: inline-block;
        width: 30%;
    }
    .wui-guide{
        width: 100%;
        height: 100%;
        background: url(/termite_static/img/component/scanlottery/scanlottery_guide.jpg) no-repeat;
        background-size: 100% 100%;
        position: relative;
        background-color: #ffffff;
    }
    .wui-guide .wui-guide-top {
        height: 54%;
    }
    .wui-guide .wui-guide-scan {
        height: 19%;
        width: 32%;
        margin: 0 auto; 
        background: url(/termite_static/img/component/scanlottery/scan.png) no-repeat;
        background-size: 100% 100%;
    }
    .wui-guide .wui-guide-scan-desc {
        height: 26%;
        width: 85%;
        margin: 0 auto; 
        background: url(/termite_static/img/component/scanlottery/scan_desc.png) no-repeat;
        background-size: 100% 100%;
    }
    @media screen and (max-width: 320px) {
        .wui-guide .wui-guide-top {
            height: 55%;
        }
        .wui-guide .wui-guide-scan-desc {
            width: 90%;
            height: 30%;
        }
        .wui-guide .wui-guide-scan {
            height: 19%;
        }
        .wui-verify-btn {
            font-size: 1rem;
        }        
        .wui-scanlottery-title {
            height: 13rem;
        }  
    }
    @media screen and (max-width: 320px) and (max-height: 480px) {
        body,html {
            background: #fff!important;            
        }
        .wui-guide .wui-guide-top {
            height: 60%;
        }
        .wui-guide .wui-guide-scan-desc {
            width: 90%;
            height: 33%;
        }
        .wui-guide .wui-guide-scan {
            height: 22%;
        }
        .wui-verify-btn {
            font-size: 1rem;
        }        
        .wui-scanlottery-title {
            height: 13rem;
        }         
    }
</style>
{% endblock %}

{% block content-panel %}
<div class="wui-scanlottery-page wui-hidden wa-scanlottery-page">
    <div class="wui-scanlottery-title"></div>
    <div class="wui-scanlottery-container wa-scanlottery-container">
        <div> 
            <input type="text" placeholder="请输入姓名" class="wui-excode-input wa-name">
        </div>
        <div> 
            <input type="text" placeholder="请输入手机号" class="wui-phone-input wa-phone" maxlength="11">
        </div>
        <div>
            <input type="text" placeholder="验证码" class="wui-verify-input wa-verify-input" maxlength="4">
            <div class="wui-verify-container">
                <img class="codeimg wui-verify-refresh" src="/m/apps/scanlottery/api/m_captcha/?webapp_owner_id={{ request.webapp_owner_id}}"/>
            </div>
            <span class="wa-verify-btn wui-verify-btn">点击刷新</span>
        </div>
        <button type="button" class="wui-submit wa-submit wui-scanlottery-btn">立即抽奖</button>
        <p>注：填写真实信息，参与抽奖，否则您的奖品将无法获取哦。</p>
    </div>
</div>
<div class="wui-guide wa-guide">
    <div class="wui-guide-top"></div>
    <div class="wui-guide-scan wa-guide-scan"></div>
    <div class="wui-guide-scan-desc"></div>
</div>
{% endblock %}

{% block js %}
<script type="text/javascript">
    var scanCode = '';

    $(function(){
        //重置验证码
        $('.wa-verify-btn').click(function(){
            $('.codeimg').attr('src','/m/apps/scanlottery/api/m_captcha/?webapp_owner_id={{ request.webapp_owner_id}}&nocache='+Math.random());
        });

        //扫码
        wx.ready(function(){
            $('.wa-guide-scan').on('click' ,scanQrcode);
        });

        //立即抽奖
        $('.wa-submit').on('click', function(){
            var name = $('.wa-name').val();
            var phone = $('.wa-phone').val();
            var verify_code = $.trim($('.wa-verify-input').val());
            if(!name){
                wuiAlert('请输入姓名');
                return;
            }
            if(!phone){
                wuiAlert('请输入手机号');
                return;
            }
            if(!verify_code){
                wuiAlert('请填写验证码');
                return;               
            }
            if(!/^0{0,1}(13[0-9]|15[0-9]|17[0-9]|18[0-9])[0-9]{8}$/g.test(phone)){
                wuiAlert('请填写正确的手机号码');
                return;
            }
            if(scanCode.length != 20 || !/^\d+$/g.test(scanCode)){
                wuiAlert('您的二维码有误');
                return;
            }

            W.getApi().call({
                app: 'm/apps/scanlottery',
                resource: 'm_scanlottery_page',
                method: 'get',
                args: {
                    webapp_owner_id: W.webappOwnerId,
                    id: W.appRecordId,
                    verify_code: verify_code
                },
                success: function(data){
                    var link = '/m/apps/scanlottery/m_scanlottery/?webapp_owner_id=' + W.webappOwnerId + '&name=' + name + '&phone=' + phone + '&scan_code=' + scanCode + '&id=' + W.appRecordId;
                    window.location.href = link;
                },
                error: function(resp){
                    wuiAlert(resp.errMsg);
                }
            });
        });
    });

    function scanQrcode(){
        wx.scanQRCode({
            needResult: 1, // 默认为0，扫描结果由微信处理，1则直接返回扫描结果，
            scanType: ["qrCode"], // 可以指定扫二维码还是一维码，默认二者都有
            success: function (res) {
                var result = res.resultStr; // 当needResult 为 1 时，扫码返回的结果
                scanCode = result.substr(result.length - 20);
                W.getApi().call({
                    app: 'm/apps/scanlottery',
                    resource: 'scan_code_test',
                    method: 'get',
                    args: {
                        scan_code: scanCode
                    },
                    success: function(data){
                        $('.wa-guide').hide();
                        $('.wa-scanlottery-page').show();
                        $('html').css({background: '#a5b8dc!important'});
                        $('body').css({background: '#a5b8dc!important'});
                    },
                    error: function(resp){
                        wuiAlert(resp.errMsg);
                    }
                });
            }
        });
    }
</script>
{% endblock %}