{% extends "apps_base.html" %}

{% block css %}
<style type="text/css">
    html,body{
        height: 100%;
        font-family: "黑体";
    }
    label{
        display: block;
        margin-top: 10px;
        margin-bottom: 10px;
    }
    .wui-hidden{
        display: none;
    }
    .wui-scanlottery-container{
        margin: 60% 30px 30px 30px;
    }
</style>
{% endblock %}

{% block content-panel %}
    <div class="wui-scanlottery-container wui-hidden wa-scanlottery-container">
        <label>姓名：<input type="text" class="wa-name"></label>
        <label>手机号：<input type="number" maxlength="11" class="wa-phone"></label>

        <button type="button" class="wui-submit wa-submit">开始抽奖</button>
        <button type="button" class="wui-again wa-again">重新扫码</button>
    </div>
{% endblock %}

{% block js %}
<script type="text/javascript">
    $(function(){
        $('.wa-submit').on('click', function(){
            var name = $('.wa-name').val();
            var phone = $('.wa-phone').val();
            if(!name || !phone){
                wuiAlert('请填写姓名和手机号~');
                return;
            }
            window.location.href = '/m/apps/scanlottery/m_scanlottery/?webapp_owner_id=' + W.webappOwnerId + '&name=' + name + '&phone=' + phone + '&scan_code=' + scanCode + '&record_id=' + W.recordId;
        });

        $('.wa-again').on('click', scanQrcode);
    });
    var scanCode = '';
    loadingStatus(true);
    wx.ready(scanQrcode);

    function scanQrcode(){
        wx.scanQRCode({
            needResult: 1, // 默认为0，扫描结果由微信处理，1则直接返回扫描结果，
            scanType: ["qrCode"], // 可以指定扫二维码还是一维码，默认二者都有
            success: function (res) {
                loadingStatus(false);
                var result = res.resultStr; // 当needResult 为 1 时，扫码返回的结果
                scanCode = result.substr(result.length - 20);
                console.log(result, scanCode);
                $('.wa-scanlottery-container').show();
            }
        });
    }
</script>
{% endblock %}