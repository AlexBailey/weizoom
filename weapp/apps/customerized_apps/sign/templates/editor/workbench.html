{% extends "content_base_v2.html" %}

{% load workbench_filter %}
{% load apps_filter %}

{% block css %}
    <style>
        .xui-i-tag{
            width: 150px;
        }
        .xui-i-tag-active{
            border-bottom: 3px solid #1F7DBD;
        }
        .xui-tag-group, .xui-setting-tag, .xui-state-tag{
           background-color: #EAEEF7;
        }
        .xui-tag-group{
            border-bottom: 1px solid rgba(51, 51, 51, 0.13);
            height: 40px;
            padding: 5px 10px 5px 0;
        }
        .xui-tag-group .xui-i-tag{
            font-size: 18px;
            padding: 5px 20px 0 20px;
            display: inline-block;
            width: 150px;
            height: 35px;
            text-align: center;
        }
        .xui-status-control{
            background: white;
            margin: 15px 10px;
            padding: 20px 30px;
        }
    </style>
{% endblock %}

{% block content-panel %}
<div id="workbench" class="xui-wepage-workbenchPage clearfix pr xui-appPage-commonStyle">
  <div class="relative">
    <ul class="breadcrumb">
      <li>您当前所在位置</li>
      <li><a href="/apps/lottery/lotteries/">百宝箱</a></li>
      <li class="active">新建</li>
    </ul>
  </div>

    <div class="xui-tag-group xa-tag-group">
        <span class="xui-i-tag xui-i-tag-active" target="xa-setting">规则设置</span>
        <span class="xui-i-tag" target="xa-state">签到统计</span>
        <!--<button type="button" class="xui-link-copy fr">复制链接</button>-->
    </div>

    <div class="clearfix xui-setting-tag xa-setting">
        <div class="xui-status-control xa-status-control">
            <p><b>签到设置</b><br>请设置成功后开启签到功能！</p>
            <span>
                {% if sign and sign.status_text == '进行中' %}
                    <button type="button" class="btn btn-danger fr" style="margin-top: -35px;" onclick="changeStatus('off');">关&nbsp;&nbsp;闭</button>
                {% else %}
                    <button type="button" class="btn btn-primary fr" style="margin-top: -35px;" onclick="changeStatus('on');">开&nbsp;&nbsp;启</button>
                {% endif %}
            </span>

        </div>
    <div id="leftPanel" class="fl xui-workbench-leftPanel xui-hide">
    </div>
    
    <div id="phonePanel" class="xui-workbench-phonePanel xui-section fl">
      <div id="phone" class="xui-phone ">
          <div id="phoneSkin" class="xui-i-skin">
            <div class="xui-i-title">
              <span class="xa-title">微页面标题</span>
            </div>
            <iframe name="phoneFrame" id="phoneIFrame" src="/termite2/webapp_design_page/?project_id={{project_id}}&design_mode=1" height="100%" border="none"></iframe>
          <div id="phoneSkinCover" class="hide xui-i-skinCover"></div>
        </div>
      </div>
    </div>
    <div id="rightPanel" class="fl xui-workbench-rightPanel xui-hide mb30">
    </div>
  </div>
    <div class="xui-state-tag xa-state" style="display: none">
        <div
			class="panel-body panel-table p0 mt10"
			data-ui-role="advanced-table"
			data-app="apps/sign"
			data-resource="sign_participances"
			data-args='{"id": "{{activity_id}}"}'
			data-template-id="#table"
			data-enable-paginator="true"
			data-enable-sort="true"
			data-selectable="false"
			data-disable-header-select="true"
			data-item-count-per-page="10"
		>
		</div>
    </div>
</div>
    {% verbatim %}
        <script id="table" type="text/x-jquery-tmpl">
            {{if items!='' }}
            <table class="table table-bordered xb-stripedTable xb-noTdBorder xb-noBottom xb-noBorder xb-theadBg mb10">
                <thead>
                    <tr>
                        <th>会员</th>
                        <th>投票时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                  {{each(i, item) items}}
                    <tr data-id="${item.id}">
                        <td
                            class="tl pl25"
                            style="width:250px; height:60px;"
                        >
                            <img src="${item.participant_icon}" />
                            {{html item.participant_name}}
                        </td>
                        <td>
                            ${item.created_at}
                        </td>
                        <td>
                            <a href="javascript:void(0);" class="ml5 xa-viewData">查看结果</a>
                        </td>
                    </tr>
                    {{/each}}
                </tbody>
                <div class="cb"></div>
            </table>
            {{else}}
                <div class="xui-emptyBox m10">
                    <img src="/static_v2/img/editor/empty.png">
                    <span class="ml20">您还没有相关数据！</span>
                </div>
            {{/if}}
            <br>
        </script>
    {% endverbatim %}
{% endblock %}

{% block global_elements %}
<div class="xui-bottomActionBar">{{ sign.status_text }}
  {% if not sign %}
    <button class="xa-save btn btn-primary">保存</button>
    <button class="xa-preview btn btn-default ml20">预览</button>
  {% else %}
    {% if sign.status_text == "未开始" %}
    <button class="xa-save btn btn-primary">保存</button>
    <button class="xa-preview btn btn-default ml20">预览</button>
    {% endif %}
    {% if sign.status_text == "进行中" %}
    进行中，不可更改
    {% endif %}
    {% if sign.status_text == "已结束" %}
    已结束，不可更改
    {% endif %}
  {% endif %}
</div>
{% endblock %}

{% block base_js %}
  <!-- *start_prunt_task* -->
    <!-- [prunt_task] 
      {
        "task": "weizoom-load-termite-components"
      }
    --> 
  {{ '["appkit.page", "appkit.componentadder", "appkit.surveydescription", "appkit.qa", "appkit.selection", "appkit.shortcuts", "appkit.submitbutton"]'|load_termite_components|safe }}
  <!-- *end_prunt_task* -->
  
  <script type="text/javascript">
    var signStatus = false;
    W.uid = {{ user.id }};
    W.projectId = "{{project_id}}";
    W.activityId = "{{sign.id}}";
    W.host = "{{request.META.HTTP_HOST}}";
    W.API_VERSION = 1;
    var isCreateNewData = {% if is_create_new_data %}true{% else %}false{% endif %};
    W.isSystemManager = {% if user|is_system_manager %}true{% else %}false{% endif %};
    var bottomDistance = 110;
    /* 自动选中cid，当页面进来的时候 */
    W.autoSelectCid = 2;
    
    var loadPages = function(pageManagerView) {
      W.getApi().call({
        app: 'apps',
        api: 'dynamic_pages/get',
        args: {
          project_id: W.projectId
        },
        showLoading: false,
        success: function(data) {
          var pages = data;
          var firstPage = null;
          for (var i = 0; i < pages.length; ++i) {
            //xlog("pages[i]:");xlog(pages[i]);
            var page = W.component.Component.parseJSON(pages[i]);
            if (isCreateNewData) {
              page.isNewCreated = true;
            }
            pageManagerView.addPage(page.getModel().get('title'), page, {silent: true});
            if (!firstPage) {
                firstPage = page;
            }
          }
          if (firstPage) {
            pageManagerView.activePage(page);
          }
        },
        error: function(resp) {
          alert('Failed to load pages in JSON. Please check it.');
        }
      });
    }
    
    $(document).ready(function() {
      var windowHeight = $(window).height();
      var height = windowHeight - 350;
      
      $('#leftPanel').css('min-height' ,height+ 'px');
      $('#workbench').css('min-height' ,height+ 'px');
      $(window).bind('beforeunload', function() {
        if (isDirtyWorkbenchIndicatorVisible) {
          return '您对页面的编辑还没保存，请先保存页面'
        } else {
        }
      })
      
      var pageManagerView = new W.workbench.PageManagerView({
        el: '#leftPanel',
        isSystemManager: W.isSystemManager
      });
      pageManagerView.render();
      
      var phoneView = new W.workbench.PhoneView({
        el: '#phonePanel'
      });
      phoneView.render();
      
      var propertyViewLeft = phoneView.getRightBorderOffset() - $('#workbench').offset().left;
      var propertyView = new W.workbench.PropertyView({
        el: '#rightPanel',
        left: propertyViewLeft,
        onlyShowUserProperty: true//!W.isSystemManager
      });
      propertyView.render();
      
      var synchronizer = new W.workbench.PageSynchronizer();
      synchronizer.run();
      W.Synchronizer = synchronizer;
      
      loadPages(pageManagerView);
      
      $('.xa-save').click(function() {
        // 保存model
        W.Synchronizer.manualSync(function(page, data) {
          var descriptionModel = page.components[0].model;
          var name = descriptionModel.get('title');
          var startTime = descriptionModel.get('start_time')+":00";
          var endTime = descriptionModel.get('end_time')+":00";
          var relatedPageId = data['project_id'];
          var args = {
            "name": name,
            "start_time": startTime,
            "end_time": endTime
          }
          if (isCreateNewData) {
            var method = 'put';
            args['related_page_id'] = relatedPageId;
          } else {
            var method = 'post';
            args['id'] = W.activityId;
          }
          W.getApi().call({
            app: 'apps/sign',
            resource: 'sign',
            method: method,
            args: args,
            success: function(data) {
              W.showHint('success', '保存成功');
            },
            error: function(resp) {
              W.showHint('error', '保存失败!');
            }
          });
        });
      });
      
      W.isReady = true;
      
      W.Broadcaster.on('designpage:reach_scroll_boundary', function(direction) {
        var $window = $(window);
        var scrollTop = $window.scrollTop();
        if (direction === 'down') {
          var newScrollTop = scrollTop + 20;
        } else {
          var newScrollTop = scrollTop - 20;
        }
        $window.scrollTop(newScrollTop);
      });
      
      $('[data-toggle="tooltip"]').tooltip();
      
      $('.xa-preview').click(function(event){
        var page = pageManagerView.getCurrentActivePage();
        
        // 验证
        if (!W.isSystemManager) {
            if(!page.validate()) {
                return;
            }
        }
        
        // 预览
        var pageJson = JSON.stringify(page.toJSON());
        projectId = W.projectId.split(':')[2];
        W.resource.termite2.TermitePreview.put({
          data: {
            project_id: projectId,
            page_json: pageJson
          },
          success: function(data) {
            var previewUrl = '/m/apps/sign/m_sign/?page_id=preview&woid='+W.uid+'&id='+W.projectId;
            window.open('/termite2/app_preview/?preview_url='+encodeURIComponent(previewUrl), '_tab');
          },
          error: function(resp) {
          }
        });
      });
      
      $(document).click(function() {
        // 点击空白处，触发事件
        W.Broadcaster.trigger('designpage:cancel_delete');
      });

        //绑定标签页切换事件
        $('.xa-tag-group').delegate('.xui-i-tag', 'click', function(){
            var target = $(this).attr('target');
            var $this = $(this);
            if('xa-setting' == target){
                $('.xa-setting').show().siblings('.xa-state').hide();
            }else if('xa-state' == target){
                $('.xa-state').show().siblings('.xa-setting').hide();
            }
            $this.addClass('xui-i-tag-active').siblings().removeClass('xui-i-tag-active');
        });
    });

    function changeStatus(act){
        var innerHtml = act=='on' ? '<button type="button" class="btn btn-danger fr" style="margin-top: -35px;" onclick="changeStatus(\'off\');">关&nbsp;&nbsp;闭</button>':
                '<button type="button" class="btn btn-primary fr" style="margin-top: -35px;" onclick="changeStatus(\'on\');">开&nbsp;&nbsp;启</button>';
        if(isCreateNewData){
            signStatus = act == 'on';
        }else{
            W.getApi().call({
                app: 'apps/sign',
                resource: 'sign',
                method: 'post',
                args: {
                    signId: W.activityId,
                    status: act
                },
                success: function(data) {
                    W.showHint('success', '更新状态成功');
                    $('.xa-status-control').html(innerHtml);
                },
                error: function(resp) {
                  W.showHint('error', '更新状态失败!');
                }
            });
        }
    }
  </script>
{% block js %}{% endblock %}
{% endblock %}

