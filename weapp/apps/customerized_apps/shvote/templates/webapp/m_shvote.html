{% extends "apps_base.html" %}

{% block css %}
<style type="text/css">
	h1 {
		color: #00F;
	}
	div{
		box-sizing: border-box;
	}
	.xui-record {
		margin: 10px 15px;
		padding: 5px;
		box-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
		border-radius: 5px;
	}
	.xui-record .xui-inner-content {
		color: #8F8F8F;
	}
	a.xui-button {
		padding: 10px;
		display: block;
		text-align: center;
		color: #FFF;
		margin: 10px 15px;
		background-color: rgba(0, 125, 255, 0.5);
		border-radius: 10px;
	}
	.wui-group{
		overflow: hidden;
		border-bottom: 1px solid #8E8E8E;
	}
	.wui-group > div{
		float: left;
		font-size: 18px;
		text-align: center;
		width: 33.33%;
		padding: 10px 0;
	}
	.wui-group > div.active{
		color: #FF8000;
	}
	.wui-rank{
		background: #fff;
		font-size: 14px;
	}
	.wui-rankList-wrap{
		padding: 0 10px;
	}
	.wui-rank-list{
		overflow: hidden;
		position: relative;
		margin-top: 10px;
	}
	.wui-search{
		border-bottom: 1px solid #8E8E8E;
		padding: 5px 10px;
		overflow: hidden;
		line-height: 29px;
	}
	.wui-search span{
		font-size: 16px;
	}
	.wui-searchBox{
		float: right;
		width: 70%;
		position: relative;
	}
	.wui-search-input{
		height: 25px;
		width: 90%;
		border: 1px solid #8E8E8E;
		border-radius: 5px;
		outline: none;
		padding-left: 5px;
	}
	.wui-searchBtn{
		height: 29px;
		border-radius: 5px;
		border: 1px solid #8E8E8E;
		background: #fff;
		position: absolute;
		right: 0;
		top: 0;
		padding: 0 10px;
		outline: none;
	}
	.wui-rank-item{
		border:1px solid #8E8E8E;
		width: 49%;
		float: left;
		margin-bottom: 10px;
	}
	.wui-rank-item:nth-child(even){
		float: right;
	}
	.wui-rank-pic{
		height:100px;
		border-bottom: 1px solid #8E8E8E;
	}
	.wui-rank-name{
		border-bottom: 1px solid #8E8E8E;
		text-align: center;
		padding: 2px 0;
	}
	.wui-rank-vote{
		overflow: hidden;
	}
	.wui-rank-vote > div{
		float: left;
		width: 50%;
		text-align: center;
		padding: 3px 0;
	}
	.wui-rank-voteLef{
		border-right: 1px solid #8E8E8E;
	}
	.wui-detail-dialog{
		border:1px solid black;
		width:80%;
		height:80%;
		display:none;
		z-index:99999999;
		margin:0 auto;
		background-color:#FFF;
		border-radius: 6px;
		position: absolute;
		top: 30%;
		left: 10%;
	}
	.wui-detail-top{
		margin: 6% 0 0 6%;
	}
	.wui-detail-user{
		border: 1px solid #000;
		width: 60%;
		display: inline-block;
	}
	.wui-detail-user-pic{
		border-bottom: 1px solid #000;
		padding-top: 36%;
	}
	.wui-detail-user-name{
		padding: 2% 0px;
		text-align: center;
	}
	.wui-detail-btn{
		display: inline-block;
		width: 22%;
		margin-left: 14%;
	}
	.wui-detail-btn button{
		width: 50%;
	}
	.wui-detail-middle{
		width: 57%;
		margin: 5% 0px 5% 6%;
	}
	.wui-detail-middle .wui-detail-vote-count{
		float: right;
	}
	.wui-detail-bottom{
		border: 1px solid #000;
		margin: 0 auto;
		height: 55%;
		width: 90%;
		margin-left: 5%;
	}
</style>
{% endblock %}

{% block content-panel %}
	{{ page_html_content|safe }}
<div class="wa-mobile none">
    <div class="wa-dynamic-info">
        <div>
            <p>
                <span>已报名</span>
                <span class="wa-total-parted"></span>
            </p>
            <p>
                <span>投票数</span>
                <span class="wa-total-counts"></span>
            </p>
            <p>
                <span>访问数</span>
                <span class="wa-total-visits"></span>
            </p>
        </div>
        <div>
            <p>截止日期：<b class="wa-enddate"></b> 可投：<b class="wa-left-chance"></b></p>
            <a>排行>></a>
        </div>
    </div>
	<div class="wui-rank">
		<div class="wui-rankList-wrap">
			<div class="wui-search wa-search-panel">
				<span>选手</span>
				<div class="wui-searchBox">
					<input type="text" class="wui-search-input wa-search-text">
					<button type="button" class="wui-searchBtn wa-search">搜索</button>
				</div>
			</div>
			<div class="wui-group wa-groups">
				<div class="active wa-group-item">初中组</div>
				<div class="wa-group-item">高中组</div>
				<div class="wa-group-item">大学组</div>
			</div>
			<div class="wui-rank-list wa-rank-list">		
			</div>
		</div>
	</div>
</div>
<button class="wa-ivote">我要投票</button>
<script type="text/plain" id="tpl">
	<div class="wui-rank-item">
		<div class="wui-rank-pic wa-rank-pic"></div> 
		<div class="wui-rank-name">
			<span>{ result_list_serial_number }</span> 
			<span>{ result_list_name }</span>
		</div> 
		<div class="wui-rank-vote">
			<div class="wui-rank-voteLef">
				<span>{ result_list_count }</span>票
			</div>
			<div class="wui-rank-voteRig">
				投票
			</div>
		</div> 
	</div>
</script>

<div id="userDetailDialog" class="wui-detail-dialog">
	<div class="wui-detail-top">
		<div class="wui-detail-user">
			<div class="wui-detail-user-pic">img-url</div>
			<div class="wui-detail-user-name wa-detail-user-name">
				<span>vito</span>
			</div>
		</div>
		<div class="wui-detail-btn">
			<button>投票</button>
			<button>拉票</button>
		</div>
	</div>
	<div class="wui-detail-middle">
		<span>编号：300</span>
		<span class="wui-detail-vote-count">3000票</span>
	</div>
	<div class="wui-detail-bottom">
		报名详情：1111111111111111122222222
	</div>
</div>
{% endblock %}

{% block js %}
<script type="text/javascript">
	W.pageId = "{{request.GET.page_id}}";

	$(function(){
        if(W.isPC){
            return false;
        }
        $('.wa-group-item').click(function(){
        	var arg;
        	var group = $(this).html();
        	switch(group)
        	{
        	case '高中组':
        		arg = 'high';
        		break;
        	case '大学组':
        		arg = 'college';
        		break;
        	default:
        		arg = 'small';
        	}
        	$('.wa-rank-list').html('');
        	getRankInfo(arg);
        	$(this).addClass('active').siblings().removeClass('active');
        })

		// 我要报名
		$('.wa-imark').click(function(){
			var link = window.location.origin + '/m/apps/shvote/shvote_participance/?webapp_owner_id='+W.webappOwnerId+'&id='+W.appRecordId;
			window.location.href = link;
		});
        //展示参与统计
//        getDynamicData();

        //参与投票
        var voteLock = false;
        $('.wa-ivote').on('click', function(){
            if(voteLock) return false;
            voteLock = true;
            var vote_to = 6; //需要获取投票对象的member_id
            W.getApi().call({
                app: 'm/apps/shvote',
                resource: 'shvote_participance',
                method: 'post',
                args: {
                    webapp_owner_id: W.webappOwnerId,
                    recordId: W.appRecordId,
                    vote_to: vote_to
                },
                success: function(data){
                    voteLock = false;
                    //TODO 修改被投票用户的票数，和投票用户的可投票次数
                },
                error: function(data){
                    voteLock = false;
                    if(data.errMsg == 'none_member'){
                        //TODO 弹出二维码窗口
                    }else{
                        wuiAlert(data.errMsg);
                    }
                }
            });
        });
		
    });

    $(function(){
        if(W.isPC){
            showDesc();
            return false;
        }
        //展示参与统计
        getDynamicData();
    });

    //获取已报名人数、总投票数、页面总访问数、本次可投票机会、排行、分组信息
    function getDynamicData(){
        W.getApi().call({
            app: 'm/apps/shvote',
            resource: 'm_shvote',
            method: 'get',
            args: {
                webapp_owner_id: W.webappOwnerId,
                recordId: W.appRecordId
            },
            success: function(data) {
                console.log(data);
                //更新活动信息
                var record_info = data.record_info;
                update_record_info(record_info);
                //更新会员信息
                var member_info = data.member_info;
                update_member_info(member_info);
                //更新排名信息
                getRankInfo();
            },
            error: function(data){
                if(data.errMsg == 'is_deleted'){
                    deletedRecord();
                }else{
                    wuiAlert(data.errMsg);
                }
            }
        });
    }

    function showDesc(){
        $('.wa-shvote-desc').removeClass('none');
    }
    function showDynamic(){
        $('.wa-mobile').removeClass('none');
    }
    function update_record_info(record_info){
    	$('.wa-total-parted').html(record_info['total_parted']);
    	$('.wa-total-counts').html(record_info['total_counts']);
    	$('.wa-total-visits').html(record_info['total_visits']);
    	$('.wa-enddate').html(record_info['end_date']);
    }
    function update_member_info(member_info){
    	
    }

    //获取排名信息
    function getRankInfo(arg){
        W.getApi().call({
            app: 'm/apps/shvote',
            resource: 'get_rank_list',
            method: 'get',
            args: {
				webapp_owner_id: W.webappOwnerId,
                recordId: W.appRecordId
            },
            success: function(data) {
                var result = data.result_list;
                var tpl = new Template($('#tpl').html());
                if(!arg) arg='small';
                for(var i=0;i<result.length;i++){
                	if(result[i].group == arg){               	
		                var s = tpl.render({
		                    result_list_serial_number : result[i].serial_number,
		                    result_list_name : result[i].name,
		                    result_list_count : result[i].count
		                });
		                $('.wa-rank-list').append(s);
	            	}
           		}
            },
            error: function(data){
				wuiAlert(data.errMsg);
            }
        });
    }

    /*
    查看选手详情
     */
    function DetailDialog(selector){
    	this.$el = $(selector || '#userDetailDialog');
    	this.$name = this.$el.find('.wa-detail-user-name span');
    }
    DetailDialog.prototype.render = function(data){
    	if (data) {
    		this.$name.text('sun');
    		console.log(data)
    	}
    	mask('show');
        this.$el.show();
    };
	$('body').delegate('.wa-rank-pic', 'click', function(event) {
		resultDialog = new DetailDialog();
		resultDialog.render(123);
	});
</script>
{% endblock %}