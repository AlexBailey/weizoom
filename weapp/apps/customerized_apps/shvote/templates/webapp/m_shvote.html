{% extends "apps_base.html" %}

{% block css %}
<style type="text/css">
	h1 {
		color: #00F;
	}
	div{
		box-sizing: border-box;
	}
	.xui-record {
		margin: 10px 15px;
		padding: 5px;
		box-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
		border-radius: 5px;
	}
	.xui-record .xui-inner-content {
		color: #8F8F8F;
	}
	a.xui-button {
		padding: 10px;
		display: block;
		text-align: center;
		color: #FFF;
		margin: 10px 15px;
		background-color: rgba(0, 125, 255, 0.5);
		border-radius: 10px;
	}
	.wui-shvoteDescription{
		background: #f0f0f0;
	}
	.wui-shvoteDescription div img{
		width: 100%;
	}
	.wui-dynamic-info{
		background: #fff;
	}
	.wui-dynamic-top{
		padding: 10px 0;
		border-top: 1px solid #f0f0f0;
	}
	.wui-dynamic-top p{
		display: inline-block;
		width: 32%;
		text-align: center;
		line-height: 25px;
		border-right: 1px solid #e1e1e1;
	}
	.wui-dynamic-top p span{
		display: block;
	}
	.wui-dynamic-bottom{
		border-bottom: 5px solid #f0f0f0;
	}
	.wui-dynamic-bottom p{
		text-align: center;
		font-size: 14px;
		border-bottom: 5px solid #f0f0f0;	
		padding-bottom: 5px;	
	}
	.wui-rank-link{
		border-bottom: 1px solid #e1e1e1;
	}
	.wui-total-info{
		color: #ff4200;
	}
	.wui-event-details,.wui-rank-link{
		padding: 10px 15px;
		background: url(/static_v2/img/vote_arrow.png) no-repeat 96%;
		background-size: 16px 16px;
	}
	.wui-group{
		overflow: hidden;
		height: 43px;
		line-height: 43px;
	}
	.wui-group > div{
		float: left;
		font-size: 16px;
		text-align: center;
	}
	.wui-group > div.active{
		color: #ff4200;
		font-size: 20px;
	}
	.wui-link{
		padding:0 10px;
	}
	.wui-rank{
		background: #fff;
		font-size: 14px;
	}
	.wui-rank-list{
		overflow: hidden;
		position: relative;
		padding: 0 10px;
		background: #ffe145;
	}
	.wui-search{
		border-bottom: 5px solid #f0f0f0;
		padding: 5px 15px;
		overflow: hidden;
		line-height: 29px;
	}
	.wui-search > span{
		font-size: 16px;
	}
	.wui-searchBox{
		float: right;
		width: 80%;
		position: relative;
	}
	.wui-searchBox p{
		line-height: 17px;
		text-indent: 30px;
		padding-top: 7px;
		padding-bottom: 7px;
	}
	.wui-search-input{
		height: 30px;
		width: 80%;
		border: 1px solid #ff4200;
		border-radius: 2px;
		outline: none;
		padding-left: 26px;
		background: url(/static_v2/img/search.png) no-repeat 1% 50%;
		background-size: 20px;
	}
	.wui-searchBtn{
		height: 34px;
		border-radius: 2px;
		color: #fff;
		border: none;
		background: #ff4200;
		position: absolute;
		right: 0;
		top: 0;
		padding: 0 15px;
		outline: none;
	
	}
	.wui-rank-item{
		width: 48%;
		float: left;
		margin-top: 10px;
	}
	.wui-item-content{
		padding: 7px;
		padding-bottom: 0;
		background: #fff7e7;
	}
	.wui-rank-item:nth-child(even){
		float: right;
	}
	.wui-rank-pic{
		height:130px;
		overflow: hidden;
		position: relative;
	}
	.wui-rank-name{
		background: rgba(0,0,0,0.5);
		width: 100%;
		color: #fff;
		text-align: center;
		padding: 4px 0;
		position: absolute;
		left: 0;
		bottom: 0;
	}
	.wui-rank-vote{
		overflow: hidden;
		text-align: center;
		padding: 3px 0 6px;
	}
	.wui-rank-voteLef{
		float: left;
		line-height: 2rem;
		color: #ff4200;
		font-size: 1.1rem;
		padding-left: 5px;
	}
	.wui-rank-voteRig button{
		float: right;
		outline: none;
	}
	.wui-detail-dialog{
		width:80%;
		height:90%;
		display:none;
		z-index:99999999;
		margin:0 auto;
		background-color:#f0f0f0;
		border-radius: 4px;
		position: absolute;
		top: 5%;
		left: 10%;
		overflow-x: hidden;
   		overflow-y: auto;
	}
	.wui-detail-top{
		margin: 5% 0 3% 0;
		padding: 5% 0 1% 6%;
		background-color: #FFF;
	}
	.wui-detail-user{
		border: 7px solid #fff7e7;
		width: 10rem;
		height: 8rem;
		display: inline-block;
	    overflow: hidden;
	    position: relative;
	}
	.wui-detail-user .wui-detail-user-name{
		text-align: center;
		position: absolute;
        left: 0;
   	 	bottom: 0;
	    display: inline-block;
	    width: 100%;
        background: rgba(0,0,0,0.5);
        color: #FFF;
	}
	.wui-detail-btn{
		float: right;
		width: 40%;
	}
	.wui-detail-btn button{
		width: 5rem;
		height: 2.5rem;
		background-color: #ff4200;
		color: #FFF;
		border: none;
	    margin-top: 1rem;
        border-radius: 4px;
        box-shadow: 0 3px 0px #b62f00;
        font-family: SimHei;
        font-size: 1rem;
	}
	.wui-detail-middle{
		width: 45%;
	    margin: 5% 0 1% 3%;
	}
	.wui-detail-middle .wui-detail-vote-count{
		float: right;
	}
	.wui-detail-middle .wui-detail-vote-count span{
		color: #ff4200;
	}
	.wui-detail-bottom{
		margin: 0 auto;
		background-color: #FFF;
		padding: 5% 4% 5% 5%;
		text-indent: 2rem;
		font-family: SimHei;
        font-size: 1rem;
        line-height: 1.5rem;
	}
	.wui-detail-close{
		display: none;
		position: absolute;
		top: 3%;
		right: 6%;
		cursor: pointer;
	    z-index: 999999999;
	    width: 10%;
	}
	p.wui-noborder{
		border: none;
	}
	.wui-vote-btn{
		width: 3rem;
		height: 2rem;
		background-color: #ff4200;
		color: #FFF;
		border: none;
        border-radius: 4px;
        box-shadow: 0 3px 0px #b62f00;
        font-family: SimHei;
        font-size: 0.9rem;	
    }	
	.wui-share-mask{
		z-index: 9999999999 !important;
		display: none;
	}
	.wui-share-mask .wui-share-arrow{
		width: 33%;
		position: absolute;
		top: 0;
	    right: 4%;
	}
	.wui-share-mask .wui-share-invite{
		color: #FFF;
		font-family: SimHei;
	    font-size: 1.5rem;
	    position: absolute;
	    top: 33%;
        left: 17%;
	}
	.wui-share-mask .wui-share-close{
		width: 10%;
	    position: absolute;
	    top: 60%;
        left: 45%;
	}
	.wui-share-mask .wui-share-known{
		color: #FFF;
		font-family: SimHei;
	    font-size: 1.5rem;
	    position: absolute;
	    top: 68%;
        left: 42%;
	}
</style>
{% endblock %}

{% block content-panel %}
	{{ page_html_content|safe }}
<div class="wa-mobile">
    <div class="wa-dynamic-info wui-dynamic-info">
        <div class="wui-dynamic-top">
            <p>
                <span>已报名</span>
                <span class="wa-total-parted wui-total-info"></span>
            </p>
            <p>
                <span>投票数</span>
                <span class="wa-total-counts wui-total-info"></span>
            </p>
            <p class="wui-noborder">
                <span>访问数</span>
                <span class="wa-total-visits wui-total-info"></span>
            </p>
        </div>
        <div class="wui-dynamic-bottom">
            <p>
            	截止日期：<span class="wa-enddate"></span> &nbsp;&nbsp;
            	可投：<span class="wa-left-chance"></span>票
            </p>
            <div class="wui-link">
           		<div class="wa-rank-link wui-rank-link">排行榜</div>
            	<div class="wa-event-details wui-event-details">活动介绍</div>
            </div>
        </div>
    </div>
	<div class="wui-rank">
		<div class="wui-rankList-wrap">
			<div class="wui-search wa-search-panel">
				<span>选手</span>
				<div class="wui-searchBox">
					<input type="text" class="wui-search-input wa-search-text" placeholder="请输入关键字" maxlength="20">
					<button type="button" class="wui-searchBtn wa-search">搜索</button>
					<p>选手列表是根据选手票数由多到少排列，显示前100名。如果需要查找100名以外的选手请在搜索栏输入选手编号或选手名称即可。</p>							
				</div>												
			</div>

			<div class="wui-group wa-groups">
			</div>
			<div class="wui-rank-list wa-rank-list">		
			</div>
		</div>
	</div>
</div>

<script type="text/plain" id="tpl">
	<div class="wui-rank-item wa-rank-item" data-id={ result_list_member_id }>
		<div class="wui-item-content">
			<div class="wui-rank-pic wa-rank-pic">
				<img src={ result_list_icon }>
				<div class="wui-rank-name">
					<span class="wui-rank-serial-number">{ result_list_serial_number }</span> 
					<span>{ result_list_name }</span>
				</div> 			
			</div> 
			<div class="wui-rank-vote">
				<div class="wui-rank-voteLef wa-vote-left">
					<span>{ result_list_count }</span>票
				</div>
				<div class="wui-rank-voteRig wa-ivote" data-member="{ member_id }">
					<button type="button" class="wui-vote-btn">投票</button>
				</div>
			</div> 
		</div>
	</div>
</script>
<div>	
	<img class="wui-detail-close wa-detail-close" src="/static_v2/img/shvote_close.png">
	<div id="userDetailDialog" class="wui-detail-dialog">
		<div class="wui-detail-top">
			<div class="wui-detail-user wa-detail-user">
				<img src="" class="wui-detail-user-pic">
				<span class="wui-detail-user-name"></span>
			</div>
			<div class="wui-detail-btn">
				<button>投票</button>
				<button class="wa-detail-share">拉票</button>
			</div>
			<div class="wui-detail-middle">
				<span class="wa-detail-serial-number"></span>
				<span class="wui-detail-vote-count wa-detail-vote-count"><span></span>&nbsp;票</span>
			</div>
		</div>
		<div class="wui-detail-bottom wa-detail-bottom"></div>
	</div>
</div>
<div class="wui-share-mask">
	<img class="wui-share-arrow" src="/static_v2/img/shvote_arrow.png">
	<span class="wui-share-invite">邀请你的小伙伴,帮你投票</span>
	<img class="wui-share-close wa-share-close" src="/static_v2/img/shvote_share_close.png">
	<span class="wui-share-known">知道了</span>
</div>
{% endblock %}

{% block js %}
<script type="text/javascript">
	W.pageId = "{{request.GET.page_id}}";

	//当前分组，切换时候需要改变值，用于查找
	var current_group = '';

	$(function(){
        if(W.isPC){
            return false;
        }
        $('.wa-shvote-desc').hide();
		// 我要报名
		$('.wa-imark').click(function(){
			var link = window.location.origin + '/m/apps/shvote/shvote_participance/?webapp_owner_id='+W.webappOwnerId+'&id='+W.appRecordId;
			window.location.href = link;
		});

		$('.wa-getback').click(function(){
			$('.wa-shvote-desc').hide();
			$('.wa-mobile').show();
		});

		$('.wa-rank-link').click(function(){
			var link = window.location.origin + '/m/apps/shvote/m_shvote_rank/?webapp_owner_id='+W.webappOwnerId+'&id='+W.appRecordId;
			window.location.href = link;
		})

		// 搜索
		$('.wa-search').click(function(){
			var search_name = $('.wa-search-text').val();
			if(search_name != ''){
				getRankInfo(current_group,search_name);
			}else{
				getRankInfo(current_group,'');
			}
		});
		//切换分组
		$('.wa-groups').on('click','div',function(){
			$(this).addClass('active').siblings().removeClass('active');
			current_group = $(this).html();
			$('.wa-left-chance').html(can_play_info[current_group]);
			getRankInfo(current_group,'');
		});

		$('.wa-event-details').click(function(){
			$('.wa-shvote-desc').show();
			$('.wa-mobile').hide();
		});
        //展示参与统计
//        getDynamicData();

        //参与投票
        var voteLock = false;
        $('.wa-rank-list').on('click','.wa-ivote', function(){
        	var left_chance = parseInt($('.wa-left-chance').html());
        	if( !left_chance > 0) {
        		wuiAlert('每天每组只可投票一次');
        		return
        	}
        	var that = $(this);
            if(voteLock) return false;
            voteLock = true;
            var vote_to = $(this).attr('data-member'); 
            W.getApi().call({
                app: 'm/apps/shvote',
                resource: 'shvote_participance',
                method: 'post',
                args: {
                    webapp_owner_id: W.webappOwnerId,
                    recordId: W.appRecordId,
                    vote_to: vote_to,
                    voted_group: current_group
                },
                success: function(data){
                	wuiAlert('投票成功');
                	var cur_vote = parseInt(that.siblings().find('span').html()) + 1;
                	var cur_count = parseInt($('.wa-total-counts').html()) + 1;
                	$('.wa-total-counts').html(cur_count);
                	that.siblings().find('span').html(cur_vote);
                    voteLock = false;
                    can_play_info[current_group] -= 1;
                    $('.wa-left-chance').html(can_play_info[current_group]);
                },
                error: function(data){
                    voteLock = false;
                    if(data.errMsg == 'none_member'){
                        //TODO 弹出二维码窗口
                    }else{
                        wuiAlert(data.errMsg);
                    }
                }
            });
        });
		
    });

    $(function(){	
        if(W.isPC){
            showDesc();
            return false;
        }
        //展示参与统计
        getDynamicData();
    });

    //获取已报名人数、总投票数、页面总访问数、本次可投票机会、排行、分组信息
    function getDynamicData(){
        W.getApi().call({
            app: 'm/apps/shvote',
            resource: 'm_shvote',
            method: 'get',
            args: {
                webapp_owner_id: W.webappOwnerId,
                recordId: W.appRecordId
            },
            success: function(data) {
                console.log(data);
                //更新活动信息
                var record_info = data.record_info;
                update_record_info(record_info);
                //更新会员信息
                var member_info = data.member_info;
                current_group = $('.active').html();
                can_play_info = member_info.can_play_info;
                update_member_info(member_info,current_group);
                //更新排名信息				
                getRankInfo(current_group,'');
            },
            error: function(data){
                if(data.errMsg == 'is_deleted'){
                    deletedRecord();
                }else{
                    wuiAlert(data.errMsg);
                }
            }
        });
    }

    function showDesc(){
        $('.wa-shvote-desc').removeClass('none');
    }
    function showDynamic(){
        $('.wa-mobile').removeClass('none');
    }
    function update_record_info(record_info){
    	$('.wa-total-parted').html(record_info['total_parted']);
    	$('.wa-total-counts').html(record_info['total_counts']);
    	$('.wa-total-visits').html(record_info['total_visits']);
    	$('.wa-enddate').html(record_info['end_date']);
    	for(var i=0;i < record_info.groups.length;i++){
    		var group = $('<div>'+record_info.groups[i]+'</div>');
    		$('.wa-groups').append(group);
    		$('.wa-groups div').eq(0).addClass('active');
    	}
    	var wid = 100/record_info.groups.length;

    	$('.wa-groups div').css("width",wid+'%');    	
    };
    function update_member_info(member_info){
    	$('.wa-left-chance').html(member_info.can_play_info[current_group]);
    };

    //获取排名信息
    function getRankInfo(current_group,search_name){
        W.getApi().call({
            app: 'm/apps/shvote',
            resource: 'get_rank_list',
            method: 'get',
            args: {
				webapp_owner_id: W.webappOwnerId,
                recordId: W.appRecordId,
				current_group: current_group,
				search_name: search_name
            },
            success: function(data) {
				$('.wa-rank-list').html('');
                var result = data.result_list;
                user_detail = result;
                var tpl = new Template($('#tpl').html());
                for(var i=0;i<result.length;i++){
        		    var s = tpl.render({
		                result_list_serial_number : result[i].serial_number,
		                result_list_name : result[i].name,
		                result_list_count : result[i].count,
		                result_list_icon : result[i].icon,
		                member_id : result[i].member_id,
		                result_list_member_id : result[i].member_id
		            });
		        $('.wa-rank-list').append(s);
	        	}
            },
            error: function(data){
				wuiAlert(data.errMsg);
            }
        });
    }

    /*
    查看选手详情
     */
	$('body').delegate('.wa-rank-pic', 'click', function(event) {
		var member_id = $(event.target).parents('.wa-rank-item').data('id');
		for(var i=0;i<user_detail.length;i++){
			if(user_detail[i].member_id == member_id){
				var icon = user_detail[i].icon;
				var name = user_detail[i].name;
				var count = user_detail[i].count;
				var details = user_detail[i].details;
				var pics = user_detail[i].pics;
				var serial_number = user_detail[i].serial_number;
				$('.wui-detail-user-pic').attr('src',icon);
				$('.wui-detail-user-name').text(name);
				$('.wa-detail-serial-number').text('编号: ' + serial_number);
				$('.wa-detail-vote-count span').text(count);
				$('.wa-detail-bottom').text(details);
				for (var i=0;i<pics.length;i++){
					$('.wa-detail-bottom').append('<img src='+pics[i]+'>');
				}
			}
		}
		mask('show');
		$('#userDetailDialog').show();
		$('.wa-detail-close').show();
	});
	$('body').delegate('.wa-detail-close', 'click', function(event) {
		mask('hide');
		$('#userDetailDialog').hide();
		$('.wa-detail-close').hide();
	});
	$('body').delegate('.wa-detail-share', 'click', function(event) {
		shareMask('show');
	});
	$('body').delegate('.wa-share-close', 'click', function(event) {
		shareMask('hide');
	});
	//拉票遮罩
    function shareMask(action){
        if('show' == action){
            $('.wui-share-mask').swipeMask('show');
        }else if('hide' == action){
            $('.wui-share-mask').swipeMask('hide');
        }
    }
</script>
{% endblock %}