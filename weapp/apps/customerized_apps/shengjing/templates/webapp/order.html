{% extends "new_jqm_content_base.html" %}
{% load common_tag %}

{% block css %}
<link rel="stylesheet" href="/webapp_static/backend_default/css/default.css">
<link rel="stylesheet" href="/markettools_static/coupon/css/idangerous.swiper.css">
<link rel="stylesheet" href="/webapp_static/backend_default/css/loading.css">
<style>
	body,html{
		background-color: #e1e1e6;
	}
	.td{
		text-decoration: underline;
	}
	a.td{
		text-decoration: underline;
	}
	.ui-page,.ui-content{
		background: #e1e1e6!important;
	}
	.ui-select .ui-btn{
		background: transparent;
		border:none;
		padding-left:0;
		margin:0;
	}
	.ui-select .ui-btn-inner{
		border: none;
		color:#fff!important;
		text-shadow:none;
		padding-left: 0;
		height:25px;
	}
	.ui-select .ui-shadow{ 
		box-shadow: none;
	}
	.ui-select .ui-btn select{
		width: 90%;
	}
	.ui-select .ui-btn .ui-icon-arrow-d{
		background: url("/webapp_static/backend_default/imgs/down.png") no-repeat;
    	border-radius: 0;
    	border-style:none;
    	-webkit-background-size: cover;
    	background-size: cover;
    	height: 25px;
    	left: auto;
    	right: 5px;
    	width: 30px;
    	top:9px;
	}
	.ui-select .ui-icon-shadow{
		box-shadow: none;
	}
	.xui-topNav{
		top:0px;
	}
	.xui-userCenter-header{
		background: #2d3e4f;
		color:#fff;
		width: 100%;
		padding-top: 20px;
		padding-bottom: 10px;
	}
	.ui-select{
    	margin-bottom:0px!important;
	}
	.wui-tabs{
		background: #273644;	
		width: 100%;
	}
	.wui-tabs a{
		width: 32%;	
		display: inline-block;
		color: #fff!important;
		padding: 10px 0px;
		text-align: center;
		text-shadow:none;
		font-weight:normal!important;
	}
	.wui-tabs a.active{
		border-bottom: 3px solid #f19b2c;
	}
	.ui-title {
		color: #7680A5;
		font-size: 20px;
		padding: 5px 0;
		border-bottom: 1px solid #e1e1e6;
	}
	.ui-info {
		color: #666;
		border-bottom: 1px solid #e1e1e6;
	}
	.ui-course-info {
		background: #f1f1f1;
		display: none;
	}
	.xui-course-inner{
		margin-left:20px;
		padding:10px 0;
		border-bottom:1px solid #e1e1e6;
		color:#646975;
	}
	.wui-swiper-container {
		height: auto;
		border:none;
	}
	.wui-swiper-slide {
	  overflow: auto;
	  width: 100%;
	  background: none;
	  color:#000;
	}
	.xui-section{
		padding:0;
		box-shadow: none;
	}
	.xui-section div.ui-info,.xui-section div.ui-title{
		padding:10px 20px;
	}
	.xui-pageTitle{
		font-size: 2.5em;
		margin-top:10px;

	}
	.xui-arrow{
		border-top: 1px solid #949494;
		border-right: 1px solid #949494;
		display: inline-block;
		height: 10px;
		width: 10px; 
		float: right;
	}
	.xui-arrow-down{
		margin-top: 3px;
		-webkit-transform: rotate(135deg);
		transform: rotate(135deg);
	}
	.xui-arrow-up{
		margin-top: 8px;
		-webkit-transform: rotate(-45deg);
		transform: rotate(-45deg);
	}
	.pl20{
		padding-left: 20px!important;
	}
	/*发票状态样式*/
	.xui-invoice-state{
		color:#fff;
		text-shadow:none;
		padding:0 4px;
		display: inline-block;
		-webkit-border-radius:3px;
		border-radius:3px;
	}
	.xui-state1{
		background: #48bd63;
	}
	.xui-state1 a{
		color:#fff;
	}
	.xui-state0{
		background: #e65151;
	}
	.xui-inClass{
		color:#f19b2c;
		text-decoration: underline;
	}
	.cover{
		width: 100%;
		height: 100%;
		position: absolute;
		background: rgba(0, 0, 0, 0.4);
		z-index: 10000;
	}
	.ui-billBox{
		text-align: center;
		padding-top: 50px;
		height: 100px;
		background: #fff;
		margin: 0 auto;	
		border-radius: 5px;
		font-size: 18px;
		margin-left: 10px;
		margin-right: 10px;
	}
	.ui-billBox span{
		display: block;
		margin-bottom: 5px;
	}
	.ui-bottom-line{
		border-bottom: 1px solid #bbb;
	}
	.ui-notLeaderBox{
		background: #fff;
		border-radius: 5px;
		margin-top: 20px;
		text-align: center;
		padding: 20px 30px;
	}
</style>
{% endblock %}

{% block content-panel %}
<div class="cover hidden ua-cover">
	<div class="ui-billBox ua-billBox pl15 pr15"><span>您的发票已开具</span><span>请联系您的客户经理</span></div>
</div>
<div data-role="page" data-theme="x">
			<!-- 控制 loading -->
		<div class="xui-loading" style="display: none">
			<div class="xui-loading-container container1">
				<div class="circle1"></div>
				<div class="circle2"></div>
				<div class="circle3"></div>
				<div class="circle4"></div>
			</div>
			<div class="xui-loading-container container2">
				<div class="circle1"></div>
				<div class="circle2"></div>
				<div class="circle3"></div>
				<div class="circle4"></div>
			</div>
			<div class="xui-loading-container container3">
				<div class="circle1"></div>
				<div class="circle2"></div>
				<div class="circle3"></div>
				<div class="circle4"></div>
			</div>
		</div>
		<div class="xui-topNav">
			<div class="xui-userCenter-header">
				<div class="xui-pageTitle ml20">订单明细</div>
				<select class="ua-company ml20" name="companys" id="companySelect">
					{% for company in companys %}
						<option value="{{company}}">{{company}}</option>
					{% endfor %}
				</select>
				{% if member %} 
					<input type='hidden' id="member_id" value="{{member.id}}" />
				{% endif %}
			</div>
			<div class="wui-tabs">
				<a href="javascript:void(0)" status="0" class="active">正在使用</a>
				<a href="javascript:void(0)" status="1">已使用</a>
				<a href="javascript:void(0)" status="2">全部</a>
			</div>
		</div>
		<div class="wui-swiper-container">    
		    <div class="wui-swiper-wrapper">
		      <div class="wui-swiper-slide">
		        <div class="wui-content-slide">
					<ul data-role="listview" class="xui-list-y ui-listView ua-person-listView0" data-theme="x" data-icon-shadow="false" data-icon="false">
					</ul>
					<!-- <ul data-role="listview" class="xui-list-y ui-listView ua-time-listView0" data-theme="x" data-icon-shadow="false" data-icon="false">
					</ul> -->
				</div>
			</div>
			<div class="wui-swiper-slide">
		        <div class="wui-content-slide">
					<ul data-role="listview" class="xui-list-y ui-listView ua-person-listView1" data-theme="x" data-icon-shadow="false" data-icon="false">
					</ul>
					<!-- <ul data-role="listview" class="xui-list-y ui-listView ua-time-listView1" data-theme="x" data-icon-shadow="false" data-icon="false">
					</ul> -->
				</div>
			</div>
			<div class="wui-swiper-slide">
		        <div class="wui-content-slide">
					<ul data-role="listview" class="xui-list-y ui-listView ua-person-listView2" data-theme="x" data-icon-shadow="false" data-icon="false">
					</ul>
					<!-- <ul data-role="listview" class="xui-list-y ui-listView ua-time-listView2" data-theme="x" data-icon-shadow="false" data-icon="false">
					</ul> -->
				</div>
			</div>
		  </div>
		</div>
	</div>
{% endblock %}
{% block js %}
<script src="/markettools_static/coupon/js/idangerous.swiper.js"></script>
<script>
	//处理留白问题
	var bodyHeight = window.document.body.clientHeight;
	var pageHeight = bodyHeight - 222;	
	$('.wui-swiper-slide').css('height',pageHeight);
	
	$('.ua-cover').css('height', bodyHeight+100);
	$('.ua-billBox').css('margin-top', bodyHeight/2-50);
	
	//处理加载时的样式
	var loadingTop = bodyHeight - (bodyHeight - 222)*0.5;
	$('.xui-loading').css('top',loadingTop);

	var company_name = $.cookie('SHENGJING_STUDY_PLAN_COMPANY_NAME');
	var $options = $('.ua-company').find('option');
	$options.each(function() {
		if ($(this).val()==company_name){
			$(this).attr('selected', 'selected');
		}
	});

	showData();
	function showData() {
		var company = $('[name=companys]').val();
		$.cookie('SHENGJING_STUDY_PLAN_COMPANY_NAME', company, {expires:365*24*60*60, path:'/'});

		$activeTab = $('.wui-tabs').find('.active');
		var status = $($activeTab[0]).attr('status');
		var args = {'status': status, 'company': company};

		var $memberInput = $('#member_id');
		if ($memberInput) {
			args.member_id = $memberInput.val();
		}

		getData(args);
	}

	//通过状态获取数据（正在使用，已使用，全部）
    function getData(args) {
    	$('.xui-loading').css('display', 'block');
    	W.getApi().call({
    		app: 'webapp',
        	api: 'project_api/call',
			args: _.extend({
	            woid: W.webappOwnerId,
	            project_id: W.projectId,
	            module: 'apps:shengjing:order',
	            target_api: 'order_list/get'
	        }, args),
			success: function(data) {
				var $personContain = $('.ua-person-listView'+args.status);
				/*var $timeContain = $('.ua-time-listView'+args.status);*/
				$personContain.find('li').remove();
				/*$timeContain.find('li').remove();*/
				var is_return = false;
				if(data.is_leader == false) {
					$personContain.append($('<li class="ui-notLeaderBox xa-notLeaderBox xui-section">' + data.info + '</li>'));
					is_return = true;
				}
				if(data.has_orders == false) {
					/*$personContain.append($('<li>暂无数据</li>'));*/
					$personContain.append($('<li></li>'));
					is_return = true;
				}
				$('.xui-loading').css('display', 'none');
				if (is_return){
					return;
				}
				getTemplate(data, $personContain);
				
			},
			error: function(data) {
				var $personContain = $('.ua-person-listView'+args.status);	
				$personContain.find('li').remove();
				$personContain.append($('<li>获取数据失败</li>'));
				$('.xui-loading').css('display', 'none');
			}
		})
    }
    var bodyWidth = window.document.body.clientWidth;
    $('.wui-swiper-container').css('width', bodyWidth);
    var tabsSwiper = new Swiper('.wui-swiper-container',{
	    speed:500,
	    onSlideChangeStart: function() { 
	    	xlog('tabsSwiper');
			$(".wui-tabs .active").removeClass('active');
	      	$(".wui-tabs a").eq(tabsSwiper.activeIndex).addClass('active');
	      	showData();
	    }
	});

	$(".wui-tabs a").on('touchstart mousedown',function(e){
	    e.preventDefault();
	    $(".wui-tabs .active").removeClass('active');
	    $(this).addClass('active');
	    showData();
	    tabsSwiper.swipeTo($(this).index());
	});

	function getTemplate(data, $personContain) {
		//输出人次卡
    	//person_time_cards = 
    	cards = data.cards;    	
    	for(var i = 0; i < cards.length; i++) {
    		//var person_time_card = cards[i];
    		var card = cards[i]
    		var $personLi = $('<li class="xui-section"></li>');
    		$personLi.append($('<div class="ui-title">'+card.contract_name+'</div>'));
    		var order_time = card.order_time.split('-');
			order_time = order_time[0] + '年' + order_time[1] + '月' + order_time[2] + '日';
			$personLi.append($('<div class="ui-info"><label>订单时间:  </label>'+order_time+'</div>'));

			if (card.is_time_card) {
				var valid_time = card.valid_time.split('-');
				valid_time = valid_time[0] + '年' + valid_time[1] + '月' + valid_time[2] + '日';
				$personLi.append($('<div class="ui-info"><label>有效时间:  </label>'+valid_time+'</div>'));
			} else {
				$personLi.append($('<div class="ui-info"><label>总人次:  </label>'+card.person_times+'</div>'));
			}
			
			if (card.study_times>0){
				$personLi.append($('<div class="ui-info" onClick="javascript:courseUpdown(this);"><label>已上课人次:  </label><label><span class="xui-inClass">'+card.study_times+'</span></label><span class="xui-arrow xui-arrow-down" onClick="javascript:courseUpdown(this);"></span></div>'));
			} else{
				$personLi.append($('<div class="ui-info" onClick="javascript:courseUpdown(this);"><label>已上课人次:  </label><label><span class="xui-inClass">'+card.study_times+'</span></label></div>'));
			}	
			var courseInfos = card.course_info;
			for (var j=0; j<courseInfos.length; j++) {
				var courseInfo = courseInfos[j];
					
				if (courseInfo.name) {
					$personLi.append($('<div class="ui-course-info"><div class="xui-course-inner"><label>' + courseInfo.name + '</label></div></div>'));
				} 
				if (courseInfo.study_time) {
					var study_time = courseInfo.study_time.split('-');
					study_time = study_time[0] + '年' + study_time[1] + '月' + study_time[2] + '日';
					$personLi.append($('<div class="ui-course-info"><div class="xui-course-inner"><label>上课时间:  </label><label>' + study_time + '</label></div></div>'));
				}
				if (courseInfo.students) {
					var students = courseInfo.students.join(',');
					$personLi.append($('<div class="ui-course-info"><div class="xui-course-inner ml0 pl20 ui-bottom-line"><label>参课人:  </label><label>' + students + '</label></div></div>'));
				}
			}
			if (!(card.study_times && courseInfos.length)) {
				$personLi.append($('<div class="ui-course-info"><div class="xui-course-inner ml0 pl20"><label>系统尚未录入信息 </label></div></div>'));
			}
			if (!card.is_time_card) {
				$personLi.append($('<div class="ui-info"><label>剩余人次:  </label>'+card.surplus_times+'</div>'));
			}
			appendBillInfo($personLi, card.bill_status, card.bill_info, card.bill_company);

			$personContain.append($personLi);
    	}
    }

    /**
     * 根据发票的不同状态, 显示不同信息	
     * bill_status=2: 已开票, 已发货
    */
    function appendBillInfo(element, bill_status, bill_info, bill_company) {
    	if(bill_status == 2) {
			element.append($('<div class="ui-info"><label>发票状态:  </label><span class="xui-invoice-state xui-state1"><a class="xui-inner-expressLink td" href="http://m.kuaidi100.com/index_all.html?type=' + bill_company + '&postid=' + bill_info + '">已开</a></span></div>'));
		} else {
			if (bill_status == 3) {
				element.append($('<div class="ui-info xa-showBillBox" onclick="showBillBox(this);"><label>发票状态:  </label><span class="xui-invoice-state xui-state1 td">已开</span></div>'));
			} else {
				element.append($('<div class="ui-info"><label>发票状态:  </label><span class="xui-invoice-state xui-state0">'+ bill_info+'</span></div>'));
			}
		}
    }
	
	function showBillBox(el) {
		var $el = $(el);
		$('.ua-cover').removeClass('hidden');
	}
	$('.ua-cover').click(function() {
		$(this).addClass('hidden');
	});    

    function courseUpdown(ele) {
    	$ele = $(ele);
    	$clickElement = $ele.find('span.xui-arrow');
		if ($clickElement.hasClass('xui-arrow-down')) {
	        $clickElement.removeClass('xui-arrow-down');
	        $clickElement.addClass('xui-arrow-up');
	        $ele.parent().find('.ui-course-info').slideDown('200');

	    } else if($clickElement.hasClass('xui-arrow-up')) {
	    	$clickElement.removeClass('xui-arrow-up');
	        $clickElement.addClass('xui-arrow-down');
	       $ele.parent().find('.ui-course-info').slideUp('200');
	    }
	}

    $(document).ready(function() {
	    $('#companySelect').change(function(event) {
	    	showData();
	    });
	});
</script>
{% endblock %}

