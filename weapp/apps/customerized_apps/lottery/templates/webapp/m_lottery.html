{% extends "webapp_content_base_v4.html" %}

{% block css %}
<style type="text/css">
	h1 {
		color: #00F;
	}

	.xui-record .xui-inner-content {
		color: #8F8F8F;
	}

    .wui-mask{
        position: fixed;
        top: 0;
        left: 0;
        display: none;
        opacity: 0.8 !important;
        background: black;
        height: 100%;
        width: 100%;
    }

    .wui-resultDialog{
        background: url("/termite_static/img/component/lottery/roulette_mobile_dialog_bg.png") no-repeat;
        background-size: 100% 100%;
        display: none;
        position: fixed;
        top: 20%;
        left: 5%;
        width: 90%;
        height: 235px;
        border-radius: 5px;
        z-index: 1;
    }
    .wui-resultDialog>.wui-i-header>.wui-i-title{
        margin-top: 30px;
        margin-left: 25px;
        font-size: 2em;
        font-weight: 600;
        overflow: visible;
        color: #d81c26;
        visibility: hidden;
    }
    .wui-resultDialog>.wui-i-header>.wui-i-title:before{
        content: "";
        display: inline-block;
        margin-left: -30px;
        width: 30px;
        height: 35px;
        background: url("/termite_static/img/component/lottery/roulette_mobile_dialog_title_icon.png") no-repeat;
        background-size: 70% 70%;
    }
    .wui-resultDialog>.wui-i-close{
        background: red;
        color: white;
        border-radius: 30px;
        height: 30px;
        width: 30px;
        float: right;
        margin-top: 10px;
        margin-right: 10px;
        text-align: center;
        vertical-align: middle;
        line-height: 33px;
        font-size: 1.2rem;
    }
    .wui-resultDialog>.wui-i-header, .wui-resultDialog>.wui-i-body, .wui-resultDialog>.wui-i-bottom{
        width: 100%;
        margin-bottom: 15px;
        text-align: center;
    }
    .wui-resultDialog .wui-i-contentHeader{
        font-size: 1.2rem;
        color: #454545;
        margin: 5px 25px;
    }

    .wui-resultDialog .wui-i-content input{
        line-height: 20px;
        border: 0;
        padding: 5px;
        font-size: 1.1rem;
        width: 45%;
    }
    .wui-resultDialog .wui-i-dialog-btn{
        height: 35px;
        background: #d81c26;
        border: 0;
        font-size: 1rem;
        font-weight: bolder;
        border-radius: 3px;
        width: 150px;
    }
    .wui-resultDialog>.wui-i-bottom button{
        display: block;
    }
    .wui-resultDialog .wui-i-content button{
        width: 70px;
        color: white;
        background: #d81c26;
    }
    .wui-resultDialog>.wui-i-bottom>.wui-i-userCenter{
        color: white;
    }
    .wui-resultDialog>.wui-i-bottom>.wui-i-closeDialog{
        color: #454545;
        background: white;
    }
</style>
{% endblock %}

{% block content-panel %}
    {{ page_html_content|safe }}
    <div id="resultDialog" class="wui-resultDialog">
        <b class="wui-i-close xa-closeDialog">&#10005</b>
        <div class="wui-i-header">
            <h2 class="wui-i-title xa-dialog-title">中奖了耶</h2>
        </div>
        <div class="wui-i-body xa-dialog-content">
            <div class="wui-i-contentHeader xa-dialog-contentHeader"></div>
            <div class="wui-i-content xa-entity-content" style="display: none">
                <label>手机号
                    <input placeholder="请输入手机号码">
                </label>
                <button class="wui-i-dialog-btn">提&nbsp;交</button>
            </div>
        </div>
        <div class="wui-i-bottom xa-dialog-bottom">
            <button class="wui-i-dialog-btn wui-i-userCenter xa-userCenter">个人中心</button>
            <button class="wui-i-dialog-btn wui-i-closeDialog xa-closeDialog xa-closeBtn">关闭</button>
        </div>
    </div>
{% endblock %}

{% block js %}
    <script>
        function ResultDialog(selector){
            var that = this;
            this.$el = $(selector || '#resultDialog');
            this.$title = this.$el.find('.xa-dialog-title');
            this.$contentHeader = this.$el.find('.xa-dialog-contentHeader');
            this.$entityContent = this.$el.find('.xa-entity-content');
            this.$entitySubmitBtn = this.$entityContent.find('button');
            this.$userCenter = this.$el.find('.xa-userCenter');
            this.$closeBtn = this.$el.find('.xa-closeBtn');

            this.$entitySubmitBtn.on('click', function(){
                 W.getApi().call({
                        app: 'm/apps/lottery',
                        resource: 'lottery_prize',
                        method: 'post',
                        args:{
                            id: W.appRecordId,
                            webapp_owner_id: W.webappOwnerId,
                            tel: that.$entityContent.find('input').val().trim()
                        },
                        success: function(data){
                            that.$title.css('visibility','hidden');
                            that.$entityContent.hide();
                            that.$contentHeader.html('工作人员会尽快与您联系，<br>请保持手机开机~');
                            that.$closeBtn.text('再来一次');
                        },
                        error: function(error){
                            alert('请重试~');
                        }
                    });
            });
            //初始化result dialog
            this.$mask = $('<div class="wui-mask"></div>');
            $('body').append(this.$mask);
            this.$el.find('.xa-closeDialog').on('click',function(){
                that.close();
            });
        }
        /**
         *
         * @param options 'prize_type': 'entity','prize_name': 'iphone10'
         */
        ResultDialog.prototype.render = function(options){
            var prize_type = options?options.prize_type||'timesout':'timesout';
            this.$entityContent.hide();
            this.$el.hide();
            if(prize_type == 'entity'){
                this.$title.css('visibility','visible');
                this.$contentHeader.html("恭喜您获得了"+prize_name+'！');
                this.$entityContent.show();
            }else if(prize_type == 'no_prize'){
                this.$title.html('很遗憾').css('visibility','visible');
                this.$contentHeader.html("没有中奖，再接再厉吧~");
                this.$closeBtn.text('再来一次');
            }else if(prize_type == 'coupon' || prize_type == 'integral'){
                var msg = prize_type == 'coupon' ? ('一张优惠券：'+prize_name): prize_name;
                this.$contentHeader.html("恭喜您获得了"+msg+"！快去个人中心查看吧！");
                this.$closeBtn.text('再来一次');
            }else if(prize_type == 'gameover'){
                this.$title.css('visibility','hidden');
                this.$contentHeader.html("活动已经结束啦，<br>下次早点来哦~");
                this.$closeBtn.text('关闭');
            }else if(prize_type == 'timesout'){
                this.$title.css('visibility','hidden');
                this.$contentHeader.html("您今天的抽奖机会已经用完了，<br>明天再来吧~");
            }
            this.$mask.show();
            this.$el.show();
        };
        ResultDialog.prototype.close = function(){
            this.$mask.hide();
            this.$el.hide();
        };

        function Roulette($lottery){
            var that = this;
            this.index = -1;
            this.count = 0;
            this.timer = 0;
            this.speed = 100;
            this.times = 0;
            this.cycle = 50;
            this.prize = -1;
            this.isRolling = false;
            this.light_index = -1;
            this.light_count = 0;
            this.light_speed = 100;
            this.lights_timer = 0;
            this.$lottery = $lottery;
            this.PRIZE = {
                '谢谢参与': getRandomStopPosition(['1', '5', '8', '10']), //谢谢参与位置
                '一等奖': getRandomStopPosition(['0', '7']), //一等奖位置
                '二等奖': getRandomStopPosition(['2', '4', '9']), //二等奖位置
                '三等奖': getRandomStopPosition(['3', '6', '11']) //三等奖位置
            };
            function getRandomStopPosition(arr){
                var len = arr.length - 1;
                return arr[parseInt(Math.random()*len+0.5)];
            }

            //初始化
            var len = $lottery.find(".xa-lottery-unit").length;
            if(len>0){
                this.count = len;
                $lottery.find(".xa-lottery-unit-"+this.index).addClass("active");
                //lights
                this.light_count = $lottery.find(".xui-circle").length;
            }else{
                alert('没有找到容器');
                return void(0);
            }
        }
        Roulette.prototype.move = function(){
            //lottery
            var $lottery = this.$lottery;
            $lottery.find(".xa-lottery-unit-"+this.index).removeClass("active");
            this.index++;
            if(this.index>=this.count){
                this.index = 0;
                this.times ++;
            }
            $lottery.find(".xa-lottery-unit-"+this.index).addClass("active");
            //lights
            var light_index = this.light_index;
            $lottery.find(".xa-circle-unit-"+light_index).removeClass("active");
            light_index += 1;
            if(light_index>this.light_count){
                light_index = 0;
            }
            $lottery.find(".xa-circle-unit-"+light_index).addClass("active");
            this.light_index = light_index;
        };
        Roulette.prototype.stop = function(data){
            this.prize_type = data.prize_type;
            this.prize_name = data.result;
            var index = this.PRIZE[data.result];
            this.prize = parseInt(index);
        };
        Roulette.prototype.roll = function(){
            this.isRolling = true;
            this.move();
            if(this.prize == -1 || this.times<3){
                if(this.speed > 50) this.speed -= 10;
            }else{
                console.log('prize:'+this.prize+' index:'+this.index);
                if(this.speed >= 250 && ((this.prize == 0 && this.index == 7) || this.prize == this.index)){
                    clearTimeout(this.timer);
                    this.times = 0;
                    this.prize = -1;
                    this.speed = 100;
                    this.isRolling = false;
                    resultDialog = resultDialog || new ResultDialog();
                    resultDialog.render({
                        'prize_type': this.prize_type,
                        'prize_name': this.prize_name
                    });
                    return;
                }
                this.speed += 20;
            }
            var that = this;
            this.timer = setTimeout(function(){
                that.roll();
            },this.speed);
        };
    </script>
    <script type="text/javascript">
        var lottery_status, can_play_count, resultDialog;
        window.lottery = {};//测试用

        $(function(){
            //隐藏参与活动按钮
            $('.xa-submitButtonContainer').hide();
            resultDialog = new ResultDialog();
            //获取中奖历史和剩余积分
            getHistory();
            lottery_status = '{{ lottery_status }}' == 'True' ? true : false;
            var $container = $('.wui-lotterydescription').find('.wui-i-body');
            window.lottery = new Roulette($container);
            $(".xa-lottery-go").click(function(){
                if(lottery.isRolling || !lottery_status){
                    !lottery_status && resultDialog.render();
                    return false;
                }else{
                    W.getApi().call({
                        app: 'm/apps/lottery',
                        resource: 'lottery_prize',
                        method: 'put',
                        args:{
                            id: W.appRecordId,
                            webapp_owner_id: W.webappOwnerId
                        },
                        success: function(data){
                            can_play_count = data.can_play_count;
                            var last_times = parseInt($('.wui-lotterydescription .xa-header p>b').html());
                            $('.wui-lotterydescription .xa-header p>b').html(--last_times);
                            lottery.roll();
                            lottery.stop(data);
                            console.log('抽奖结束');
                        },
                        error: function(error){
                            alert(error);
                        }
                    });
                }
            });
        });
        function getHistory(){
            can_play_count = parseInt('{{ can_play_count }}');
            $('.wui-lotterydescription .xa-header p>b').html(can_play_count);
            W.getApi().call({
                app: 'm/apps/lottery',
                resource: 'lottery_prize',
                method: 'get',
                args:{
                    id: W.appRecordId,
                    webapp_owner_id: W.webappOwnerId
                },
                success: function(data){
                    $('.wui-i-record').html('中奖历史');
                },
                error: function(error){
                    alert(error);
                }
            });
        }
    </script>
{% endblock %}

