{% extends "apps_base.html" %}

{% block css %}
<style type="text/css">
	h1 {
		color: #00F;
	}
    .xui-share {
        background: url("/termite_static/img/component/powerme/share.png") no-repeat scroll 82% 10px / 53% auto rgba(0, 0, 0, 0);
        position: fixed;
        text-align: center;
        top: 5%;
        width: 100%;
        z-index: 10001;
    }
    .xui-share.xa-share > div p {
        color: #fff;
        text-align: center;
        width: 100%;
    }
    /* 分享的closeButton */
    .xui-colseButton {
        margin-top: 18%;
        color: #fff;
    }

    .xui-attention{
        position: fixed;
        top: 12%;
        width: 100%;
        text-align: center;
        z-index: 10001;
    }
    .xui-attention .xui-twoDimensionBox {
        background: #fff;
        border-radius: 8px;
        padding: 5px 20px 20px 20px;
        width: 260px;
        display: inline-block;
    }
    .xui-attention .xui-twoDimension{
        display: block;
        height: 180px;
        position: relative;
        width: 180px;
        margin-left: 40px;
        margin-top: 20px;
        margin-bottom: 15px;
    }
    .xui-successHint {
        background: #fff;
        border-radius: 5px;
        position: fixed;
        top: 30%;
        height: 15%;
        z-index: 10001;
        text-align: center;
        width: 80%;
        margin-left: 11%;
        padding-top: 25px;
        padding-bottom: 20px;
    }
    .xui-successHint .xui-i-msg{
        color:#868686;
        margin-left: auto;
        margin-right: auto;
        padding-left: 10px;
        padding-right: 10px;
    }
    .xui-successHint p.xui-i-msg-title.xa-i-msg-title {
        font-size: 1.2rem;
        color: #4C4C4C;
    }
    button.wui-i-btn-groupMsg-yes,button.wui-i-btn-groupMsg-no{
        width: 40%;
        text-align: center;
        font-size: 1rem;
        height: 1.5rem;
        border-radius: 2px;
        font-family: "黑体";
        margin-top: 4%;
    }
    button.wui-i-btn-groupMsg-yes{
        background: #ff2742;
        color: #fff;
        border: 0;
    }
    button.wui-i-btn-groupMsg-no{
        background: #fff;
        color: #414141;
        border: 1px solid #EEEEEE;
    }
</style>
{% endblock %}

{% block content-panel %}
    {{ page_html_content|safe }}
    <div class="xui-share xa-share none">
        <div style="margin-top: 49%">
            <p>邀请你的小伙伴，帮你一起拼团</p>
        </div>
        <div class="xui-colseButton xui-spritebg xa-colseButton">知道了</div>
    </div>
    <!-- 支付未完成弹窗页面 -->
    <div class="xui-groupMsg xa-groupMsg none">
        <div class="f15 xui-successHint">
           <p class="xui-i-msg xa-i-msg"></p>
            <div class="wui-i-btngroup">
                <button class="wui-i-btn-groupMsg-yes wa-i-btn-groupMsg-yes">是</button>
                <button class="wui-i-btn-groupMsg-no wa-i-btn-groupMsg-no">否</button>
           </div>
        </div>
    </div>
    <!-- 成功、失败弹窗页面 -->
    <div class="xui-groupMsg-Hint xa-groupMsg-Hint none">
        <div class="f15 xui-successHint">
            <p class="xui-i-msg-title xa-i-msg-title"></p>
            <p class="xui-i-msg xa-i-msg"></p>
            <div class="wui-i-btngroup">
                <button class="wui-i-btn-groupMsg-yes wa-i-btn-groupMsg-yes">确定</button>
           </div>
        </div>
    </div>
    <!-- 非会员引导 -->
    <div class="xui-attention xa-attention-guest none">
        <div class="xui-twoDimensionBox">
            <div class="xa-attention-tip-one" style="margin-top: 32px;">
                <p style="font-size: 1.1rem;">长按二维码，关注后即可开团</p>
            </div>
            <p style="color:#9E9E9E;">方便您查看团购情况</p>
            <img src="{{ request.webapp_owner_info.qrcode_img }}" alt="" class="xui-twoDimension">
        </div>
    </div>
{% endblock %}

{% block js %}
<script type="text/javascript">
	var is_helped = true;
    var is_self_page = true;
    var is_group_leader = false;
    var only_remain_one_day = false;
    var page_owner_member_id = '';
    var page_owner_icon = '';//用户头像
    var group_type = '';
    var group_relation_id = {% if group_relation_id %}'{{group_relation_id}}'{% else %}''{% endif %};
    var product_id = {% if product_id %}'{{product_id}}'{% else %}''{% endif %};
    var settings_domain = '{{settings_domain}}';
	$(function(){
        //隐藏参与活动按钮
        $('.xa-submitButtonContainer').hide();
        //选择团购按钮点击
        $('.wui-i-choose_group_box').delegate('li', 'click', function(){
            var $this = $(this).find('span').first();
            var type = $this.attr('data-type');
            var className = 'radio' === type ? 'radio-select' : 'checkbox-select';
            if('radio' === type){
                $(this).siblings().find('span').removeClass(className);
                if($this.hasClass(className)) return;
            }
            $this.toggleClass(className);
        });
        if(W.isPC){
            return false;
        }
        $('.wui-appParticipantResult-Cover').hide();
        //展示参与统计
        getDynamicData();
    });
	function GetQueryString(name){
        var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
        var r = window.location.search.substr(1).match(reg);
        if(r!=null) return unescape(r[2]);
        return null;
    }
    //发送请求，单独获取排名数据，优化首页时间
    function getDynamicData(){
        loadingStatus(true);
        var fid = GetQueryString("fid");
        W.getApi().call({
            app: 'm/apps/group',
            resource: 'm_group',
            method: 'get',
            args: {
                webapp_owner_id: W.webappOwnerId,
                id: W.appRecordId,
                group_relation_id: group_relation_id,
                fid: fid
            },
            success: function(data) {
                console.log(data);
                //隐藏loading动画元素
                loadingStatus(false);
                //渲染按钮状态
                updateActivityStatus(data);

                //已开团
                if(group_relation_id != ''){
                    //渲染团员名单
                    showHelperInfo(data);
                    if(W.group_status == '团购进行中'){
                        //启动倒计时
                        $('.wa-timing').removeClass('none');
                        renderTime(data.member_info.timing);
                    }else{
                        $('.wa-timing').addClass('none');
                    }
                    //进度bar动画
                    runProcessBar(data.member_info.grouped_number,data.member_info.group_type);
                }
            },
            error: function(data) {
                if(data.errMsg == 'is_deleted'){
                    deletedRecord();
                }else{
                    wuiAlert(data.errMsg)
                }
            }
        });
    }

	function updateActivityStatus(data){
        //检查活动状态,更新参与按钮并绑定事件
        member_info = data.member_info;
        W.activityStatus = member_info.activity_status;
        W.isMember = member_info.isMember;
        W.member_id = member_info.member_id;
        is_self_page = member_info.self_page;
        is_group_leader = member_info.is_group_leader;
        only_remain_one_day = member_info.only_remain_one_day;
        is_helped = member_info.is_helped;
        page_owner_member_id = member_info.page_owner_member_id;
        W.group_status = member_info.group_status;
        group_type = member_info.group_type;
        product_original_price = member_info.product_original_price;
        product_group_price = member_info.product_group_price;

        //更新页面小团的数据
        page_owner_icon = member_info.page_owner_icon;
        if(page_owner_icon != ""){
            $('.wui-i-shop_circle').find('img').attr('src', page_owner_icon);
        }
        if(group_type != ""){
            $('.wui-i-product-price-group').show();
            $('.wui-i-title-pic').addClass('wui-i-title-pic-'+group_type);
            $('.wui-i-product-price-group-original-price').html(product_original_price+'元');
            $('.wui-i-product-price-group-group-price').html(product_group_price+'元');
        }
        updateBtnStatus();
    }

    function updateBtnStatus(){
        if('进行中' != W.activityStatus){
            if('未开始' == W.activityStatus){
                $('.wa-notready').show();
            }else{
                $('.wa-closed').show();
            }
            return false;
        }
        //团购成功、团购失败状态
        if (W.group_status == '团购进行中' || W.group_status == '团购未生效' || W.group_status == ''){
            //如果是自己的主页
            if(is_self_page){
                if(W.group_status == '团购未生效'){
                    openUnpaidWin();
                }
                if(is_group_leader){
                    $('.wa-using').text('邀请好友参团').on('click', function(){
                            openGuideMask();
                        }).show();
                }else{
                    if(only_remain_one_day){
                        openRemainOneDayWin();
                    }
                    $('.wa-using-join').text('直接参团').on('click', openJoinGruop).show();
                    if(W.isMember){
                        $('.wa-using').text('我要开团').on('click', openGruop).show();
                    }else{
                        $('.wa-using').text('我要开团').on('click', openGuestMask).show();
                    }

                }
            }else{
                if(group_relation_id){
                    var $powerBtn = $('.wa-power');
                    if(!is_helped){
                        $powerBtn.find('.wa-power-btn-action').html('我要参团');
                        $powerBtn.on('click', function(){
                                JoinGroup();
                            }).show();
                        $('.wa-using-join').text('看看还有什么团').on('click', openJoinGruop).show();
                    }else{
                        $('.wa-using').text('邀请好友参团').on('click', openGuideMask).show();
                        $('.wa-using-join').text('我要开团').on('click', openJoinGruop).show();
                    }
                }else{
                    $('.wa-using-join').text('直接参团').on('click', openJoinGruop).show();
                    if(W.isMember){
                        $('.wa-using').text('我要开团').on('click', openGruop).show();
                    }else{
                        $('.wa-using').text('我要开团').on('click', openGuestMask).show();
                    }
                }
            }
        }else{
            $('.wa-using-join').text('看看还有什么团').on('click', openJoinGruop).show();
            if (W.group_status == '团购成功'){
                showGroupSuccess();
            }
            if(W.group_status == '团购失败'){
                showGroupFailure();
            }
        }

    }
    //我要开团
	function openGruop(){
        var choosen_group_type = $('.wui-i-choose_group_box').find('.radio-select').attr('data-input-group_type');
        var choosen_group_days = $('.wui-i-choose_group_box').find('.radio-select').attr('data-input-group_days');
        var choosen_group_price = $('.wui-i-choose_group_box').find('.radio-select').attr('data-input-group_price');
        var product_id = $('.wui-i-choose_group_box').find('.radio-select').attr('data-input-product_id');
        if (choosen_group_type){
            W.getApi().call({
                app: 'm/apps/group',
                resource: 'group_participance',
                method: 'post',
                args: {
                    webapp_owner_id: W.webappOwnerId,
                    group_record_id: W.appRecordId,
                    fid: W.member_id,
                    group_type: choosen_group_type,
                    group_days: choosen_group_days,
                    group_price: choosen_group_price,
                    product_id: product_id
                },
                success: function(data) {
                    var relation_belong_to = data.relation_belong_to;
                    var data_href = "http://"+settings_domain+"/mall/purchasing/?woid="+W.webappOwnerId+"&product_ids="+product_id+"&product_counts=1&product_model_names=standard&group_id="+relation_belong_to+"&activity_id="+W.appRecordId;
                    window.location.href = data_href;
                },
                error: function(data) {
                    wuiAlert(data.errMsg);
                }
            });
        }else{
            wuiAlert('请选择团购类型！');
        }
    }

    // 直接参团
    function openJoinGruop(){
        var link = window.location.origin + '/m/apps/group/m_group_list/?webapp_owner_id='+W.webappOwnerId;
        window.open(link);
    }

    // 我要参团
    function JoinGroup(){
        is_helped = true;
        W.getApi().call({
            app: 'm/apps/group',
            resource: 'group_participance',
            method: 'put',
            args: {
                webapp_owner_id: W.webappOwnerId,
                group_relation_id: group_relation_id,
                fid: page_owner_member_id
            },
            success: function(data) {
                var data_href = "http://"+settings_domain+"/mall/purchasing/?woid="+W.webappOwnerId+"&product_ids="+product_id+"&product_counts=1&product_model_names=standard&group_id="+group_relation_id+"&activity_id="+W.appRecordId;
                window.location.href = data_href;
            },
            error: function(data) {
                if(data.errMsg){
                    is_helped = false;
                    wuiAlert(data.errMsg);
                }
            }
        });
    }

    //隐藏所有
    $('.mask').click(function(){
        mask('hide');
//        $('.xui-powerSucceed').addClass('none');
        $('.xui-attention').addClass('none');
        $('.xui-groupMsg').addClass('none');
        $('.xui-groupMsg-Hint').addClass('none');
        $('.xa-share').addClass('none');
//        $('.xui-errMsg').addClass('none');
        $('.xa-i-rules-contentbox').addClass('none');
        $('.xa-loadingFrame').addClass('none');
    });
    $('.xa-colseButton').click(function(){
        $('.xa-share').addClass('none');
        mask('hide');
    });

    // 活动规则
    $('.xa-i-rules-title-content p').click(function(){
        $('.xa-i-rules-contentbox').removeClass('none');
        mask('show');
        $('.xa-i-closebtn').click(function(){
            $('.xa-i-rules-contentbox').addClass('none');
            mask('hide');
        });
    });

    // 邀请好友参团
    function openGuideMask(){
        mask('show');
        $('.xa-share').removeClass('none');
    }
    //开团时间不足提示
    function openRemainOneDayWin(){
        mask('show');
        $('.xui-groupMsg').removeClass('none');
        $('.xa-groupMsg').find('.xa-i-msg').html('本次团购剩余时间不足1天，是否继续开团？');
        $('.wa-i-btn-groupMsg-yes,.wa-i-btn-groupMsg-no').click(function(){
            mask('hide');
            $('.xui-groupMsg').addClass('none');
        });
    }
    // 未关注引导
    function openGuestMask(){
        mask('show');
        $('.xa-attention-guest').removeClass('none');
    }
    // 支付未完成
    function openUnpaidWin(){
        mask('show');
        $('.xui-groupMsg').removeClass('none');
        $('.xa-groupMsg').find('.xa-i-msg').html('开团支付未完成，是否继续？');
        $('.wa-i-btn-groupMsg-yes').click(function(){
            mask('hide');
            $('.xui-groupMsg').addClass('none');
            //todo 跳转到订单编辑页面
        });
        $('.wa-i-btn-groupMsg-no').click(function(){
            mask('hide');
            $('.xui-groupMsg').addClass('none');
            //todo cancel_group_buy
        });
    }
    //团购成功
    function showGroupSuccess(){
        mask('show');
        $('.wui-i-group_box_success').removeClass('none');
        $('.xui-groupMsg-Hint').removeClass('none');
        $('.xa-groupMsg-Hint').find('.xa-i-msg').html('商家将在该商品团购结束20天内进行发货');
        $('.xa-groupMsg-Hint').find('.xa-i-msg-title').html('恭喜您 团购成功');
        $('.wa-i-btn-groupMsg-yes').click(function(){
            mask('hide');
            $('.xui-groupMsg-Hint').addClass('none');
        });
    }
    //团购失败
    function showGroupFailure(){
        mask('show');
        $('.wui-i-group_box_fail').removeClass('none');
        $('.wui-i-bar_process').addClass('wui-i-bar_process-fail');
        $('.xui-groupMsg-Hint').removeClass('none');
        $('.xa-groupMsg-Hint').find('.xa-i-msg').html('商家将在5~7个工作日内完成退款');
        $('.xa-groupMsg-Hint').find('.xa-i-msg-title').html('很遗憾 团购失败');
        $('.wa-i-btn-groupMsg-yes').click(function(){
            mask('hide');
            $('.xui-groupMsg-Hint').addClass('none');
        });
    }
    function renderTime(seconds){
        seconds = parseInt(seconds);
        var formatTime = function(data){
            data = parseInt(data);
            if(data<10){
                return '0'+data;
            }
            return data;
        };
        var $s = $('.xa-second');
        var $m = $('.xa-minute');
        var $h = $('.xa-hour');
        var $d = $('.xa-day');
        var timer = window.setInterval(function(){
            if(seconds <= 0){
                window.clearInterval(timer);
                return false;
            }
            var left_seconds = formatTime(seconds%60);
            var left_minites = formatTime(seconds/60%60);
            var left_hours = formatTime(seconds/60/60%24);
            var left_days = formatTime(seconds/60/60/24);
            $s.text(left_seconds);
            $m.text(left_minites);
            $h.text(left_hours);
            $d.text(left_days);
            seconds--;
        },990);
    }

    // 进度条
    function runProcessBar(current,total){
        $('.wui-i-choose_group_box').addClass('none');
        $('.wui-i-group_box_progress').removeClass('none');
        var current_number = current;
        var total_number = total;
        var process = "0%";
        process = parseFloat(current_number/total_number*100).toFixed(1)+"%";
        if(process=="100.0%"){
            process="100%";
        }else if(process=="0.0%"){
            process="0%";
        }
        $('.wui-i-cur_number').text(current_number+'人');
        $('.wa-i-total_number').text(total_number+'人');
        $(".xa-i-bar_process").width(process);
        percentBox_process_tmp = process;
//        percentBoxTimer();
    }

    //已参团的列表
    function showHelperInfo(data){
        var helpers_info = data.helpers_info;
        console.log(helpers_info);
        if ($.isEmptyObject(helpers_info)){
            $('.wui-i-states').addClass('none');
        }else{
            if(helpers_info || $.isEmptyObject(helpers_info)){
                $('.wui-i-states').removeClass('none');
                var li_content = '';
                for(var i in helpers_info){
                    var p = helpers_info[i];
                    li_content += "<li class='wui-i-member'><img src='"+ p.user_icon+"'></li>";
                }
                for(var i=0; i < (parseInt(group_type)-helpers_info.length);i++){
                    li_content += "<li class='wui-i-member'><img src='/termite_static/img/component/group/user_icon.png'></li>";
                }
                $('.wa-grouped-members').append($(li_content));
            }
        }
    }

</script>
{% endblock %}

