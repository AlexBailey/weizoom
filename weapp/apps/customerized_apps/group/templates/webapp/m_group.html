{% extends "apps_base.html" %}

{% block css %}
<style type="text/css">
	h1 {
		color: #00F;
	}
    .xui-share {
        background: url("/termite_static/img/component/powerme/share.png") no-repeat scroll 82% 10px / 53% auto rgba(0, 0, 0, 0);
        height: 75%;
        position: fixed;
        text-align: center;
        top: 5%;
        width: 100%;
        z-index: 10001;
    }
    .xui-share.xa-share > div p {
        color: #fff;
        text-align: center;
        width: 100%;
    }
</style>
{% endblock %}

{% block content-panel %}
    {{ page_html_content|safe }}
    <div class="xui-share xa-share none">
        <div style="margin-top: 49%">
            <p>请点击右上角</p><p>选择发送给指定好友</p><p>或者分享到朋友圈</p>
            <div style="display: inline">
                <p style="display: inline">来帮<p style="color: yellow;display: inline" class="wa-pageownername"></p><p style="display: inline">点赞</p>
            </div>
        </div>
        <div class="xui-colseButton xui-spritebg xa-colseButton"></div>
    </div>
{% endblock %}

{% block js %}
<script type="text/javascript">
	var is_helped = true;
    var is_self_page = true;
    var page_owner_member_id = '';
    var group_type = '';
    var group_relation_id = {% if group_relation_id %}'{{group_relation_id}}'{% else %}''{% endif %};
	$(function(){
        //隐藏参与活动按钮
        $('.xa-submitButtonContainer').hide();
        //选择团购按钮点击
        $('.wui-i-choose_group_box').delegate('li', 'click', function(){
            var $this = $(this).find('span').first();
            var type = $this.attr('data-type');
            var className = 'radio' === type ? 'radio-select' : 'checkbox-select';
            if('radio' === type){
                $(this).siblings().find('span').removeClass(className);
                if($this.hasClass(className)) return;
            }
            $this.toggleClass(className);
        });
        if(W.isPC){
            return false;
        }
        $('.wui-appParticipantResult-Cover').hide();
        //展示参与统计
        getDynamicData();
    });
	function GetQueryString(name){
        var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
        var r = window.location.search.substr(1).match(reg);
        if(r!=null) return unescape(r[2]);
        return null;
    }
    //发送请求，单独获取排名数据，优化首页时间
    function getDynamicData(){
        loadingStatus(true);
        var fid = GetQueryString("fid");
        W.getApi().call({
            app: 'm/apps/group',
            resource: 'm_group',
            method: 'get',
            args: {
                webapp_owner_id: W.webappOwnerId,
                id: W.appRecordId,
                group_relation_id: group_relation_id,
                fid: fid
            },
            success: function(data) {
                console.log(data);
                //渲染按钮状态
                updateActivityStatus(data);
                //隐藏loading动画元素
                loadingStatus(false);
                if(group_relation_id != ''){
                    //进度bar动画
                    runProcessBar(data.member_info.grouped_number,data.member_info.group_type);
                }
            },
            error: function(data) {
                if(data.errMsg == 'is_deleted'){
                    deletedRecord();
                }else{
                    wuiAlert(data.errMsg)
                }
            }
        });
    }

	function updateActivityStatus(data){
        //检查活动状态,更新参与按钮并绑定事件
        member_info = data.member_info;
        W.activityStatus = member_info.activity_status;
        W.member_id = member_info.member_id;
        W.isMember = member_info.isMember;
        is_self_page = member_info.self_page;
        is_group_leader = member_info.is_group_leader;
        is_helped = member_info.is_helped;
        page_owner_member_id = member_info.page_owner_member_id;
        group_status = member_info.group_status;
        group_type = member_info.group_type;
        updateBtnStatus();
    }

    function updateBtnStatus(){
        if('进行中' != W.activityStatus){
            $('.wa-timing').hide();
            if('未开始' == W.activityStatus){
                $('.wa-notready').show();
            }else{
                $('.wa-closed').show();
            }
            return false;
        }
        //如果是自己的主页
        if(is_self_page){
            if(is_group_leader){
                $('.wa-using').text('邀请好友参团').on('click', function(){
                        openGuideMask();
                    }).show();
            }else{
                $('.wa-using').text('我要开团').on('click', openGruop).show();
			    $('.wa-using-join').text('直接参团').on('click', openJoinGruop).show();
            }
        }else{
            var using_msg;
            var $attention = $('.xa-attention-guest');
            var $powerBtn = $('.wa-power');
            if(W.isMember){
                if(is_helped){
                    $powerBtn.find('.wa-power-btn-action').html('已帮');
                    $powerBtn.on('click', function(){
                        openGuideMask();
                    }).show();
                }else{
                    $powerBtn.find('.wa-power-btn-action').html('帮');
                   $powerBtn.on('click', function(){
                       if(is_helped){
                           openGuideMask();
                       }else{
                           powerYou();
                       }
                   }).show();
                }
            }else{
                if(is_helped){
                    $powerBtn.find('.wa-power-btn-action').html('已帮');
                    $powerBtn.on('click', function(){
                        openGuideMask();
                    }).show();
                }else{
                    $powerBtn.find('.wa-power-btn-action').html('帮');
                    $powerBtn.on('click', function(){
                        powerYou();
                    }).show();
                }
            }
        }
    }
    //我要开团
	function openGruop(){
        group_type = $('.wui-i-choose_group_box').find('.radio-select').attr('data-input-name');
        if (group_type){
            W.getApi().call({
                app: 'm/apps/group',
                resource: 'group_participance',
                method: 'post',
                args: {
                    webapp_owner_id: W.webappOwnerId,
                    group_record_id: W.appRecordId,
                    fid: page_owner_member_id,
                    group_type: group_type
                },
                success: function(data) {
                    console.log('openGruop()');
                    //TODO 传is_group_order,group_record_id过去
                    var data_href = "/workbench/jqm/preview/?woid=6&module=mall&model=order&action=edit&product_id=5&product_count=1&product_model_name=standard";
                    window.open(data_href, '_tab');
                },
                error: function(data) {
                    wuiAlert(data.errMsg);
                }
            });
        }else{
            wuiAlert('请选择团购类型！');
        }
    }

    // 直接参团
    function openJoinGruop(){
        var link = window.location.origin + '/m/apps/group/m_group_list/?webapp_owner_id='+W.webappOwnerId;
        window.open(link, '_tab');
    }

    // 活动规则
    $('.xa-i-closebtn').click(function(){
        $('.xa-i-rules-contentbox').addClass('none');
        mask('hide');
    });
    $('.xa-i-rules-title-content p').click(function(){
        $('.xa-i-rules-contentbox').removeClass('none');
        mask('show');
    });

    // 邀请好友参团
    function openGuideMask(){
        mask('show');
        $('.xa-share').removeClass('none');
    }

    // 进度条
    function runProcessBar(current,total){
        $('.wui-i-choose_group_box').addClass('none');
        $('.wui-i-group_box_progress').removeClass('none');
        var current_number = current;
        var total_number = total;
        var process = "0%";
        process = parseFloat(current_number/total_number*100).toFixed(1)+"%";
        if(process=="100.0%"){
            process="100%";
        }else if(process=="0.0%"){
            process="0%";
        }
        $('.xa-i-percentbox').text(current_number+'人');
        $('.wa-i-total_number').text(total_number+'人');
        $(".xa-i-percentbox").css("left",process);
        $(".xa-i-bar_process").width(process);
        percentBox_process_tmp = process;
//        percentBoxTimer();
    }

</script>
{% endblock %}

