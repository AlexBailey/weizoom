{% extends "apps_base.html" %}

{% block css %}
<style type="text/css">
    .wui-swiper-slide{overflow-y: auto;}

    .xui-listItem{
        background: #fff;
        margin-bottom: 10px;
    }
    .xui-listInner{
        text-align: left;
    }
    .xui-listInner .ui-btn-inner{
        white-space:normal;
    }
    .xui-listInner p{width:100%;}
    .xui-listInner p span:first-child{width:80%;}
    a:link,a:hover,a:visited{
        color:#333;
    }
    .wui-content-slide {
        margin: 5px 10px 5px 10px;
        border-radius: 15px;
    }
    .wui-swiper .wui-swiper-container {
        background: none;
    }
    .xui-i-content-img {
        min-height: 100px;
        display: inline-block;
    }
    button.wui-i-btn-using{
        padding: 10px 10px 10px 10px;
    }
</style>
{% endblock %}

{% block content-panel %}
    {{ page_html_content|safe }}
    <div class="xui-page {% if not user.is_from_weixin %}notweixin{% endif %} xui-myActivityPage wui-swiper">
        <div class="wui-swiper-tabs" style="margin-top:-47px;">
            <a href="javascript:void(0)" class="wui-inner-active xa-all_groups_can_open"><span class="wui-inner-tabTitle mt5 em85 c65">我要开团</span><i></i></a>
            <a href="javascript:void(0)" class="xa-all_groups_can_join"><span class="wui-inner-tabTitle mt5 em85 c65">直接参团</span><i></i></a>
        </div>
        <div class="wui-swiper-container" style="margin-top:47px;">
            <div class="wui-swiper-wrapper">
                <div class="wui-swiper-slide" id="xa-wrapper">
                    <div class="wui-content-slide">
                        {% if all_groups_can_open %}
                            {% for group_item in all_groups_can_open %}
                                <ul class="xui-listItem">
                                <li data-icon="true" class="xui-listInner pl15 pr15">
                                    <div class="xui-i-content">
                                        <img src="" class="xui-i-content-img">
                                        <div class="xui-i-content-group">
                                            <div class="xui-i-content-time">活动截止：{{ group_item.end_time }}</div>
                                            <a href="{{ group_item.url }}"><button class="wui-i-btn-using wa-using">点击开团</button></a>
                                            <div class="xui-i-content-type">
                                                <p>{{ group_item.group_dict }}人团  ￥ </p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="xui-i-title">{{ group_item.name }}</div>
                                </li>
                                </ul>
                                {% endfor %}
                        {% endif %}
                    </div>
                </div>
                <div class="wui-swiper-slide">
                    <div class="wui-content-slide">
                        <div class="xui-all_groups_can_join-slide">
                        {% if all_groups_can_open %}
                            {% for group_item in all_groups_can_open %}
                                <ul class="xui-listItem">
                                <li data-icon="true" class="xui-listInner pl10 pr15">
                                    <div class="xui-i-title">
                                        <span class="disTc pl15 em1">{{ group_item.name }}</span>
                                        <button class="wui-i-btn-using wa-using xa-find_group" data-id="{{group_item.id}}">进入找团</button>
                                    </div>
                                </li>
                                </ul>
                            {% endfor %}
                        {% endif %}
                        </div>
                        <div class="xui-all_groups_can_join-list xa-all_groups_can_join-list none">
                            11111
                        </div>
                    </div>
                </div>
                <script id="tpl" type="text/plain">
                    <p>Today: { date }</p>
                    <a href="/{ user.id|safe }">{ user.company }</a>
                </script>
            </div>
        </div>
    </div>
{% endblock %}

{% block js %}
<script src="/markettools_static/coupon/js/idangerous.swiper.js"></script>
<script type="text/javascript">
$(document).ready(function($) {
    $("body").css('overflow-y', 'hidden');
    var myscroll = new iScroll('xa-wrapper',{hScrollbar:false});
    var tabsSwiper = new Swiper('.wui-swiper-container',{
        speed:500,
        onSlideChangeStart: function() {
            $(".wui-swiper-tabs .wui-inner-active").removeClass('wui-inner-active');
            $(".wui-swiper-tabs a").eq(tabsSwiper.activeIndex).addClass('wui-inner-active');
            myscroll=new iScroll(tabsSwiper.activeSlide(),{hScrollbar:false});
        }
    });
    $(".wui-swiper-tabs a").on('touchstart mousedown',function(e){
        e.preventDefault();
        $(".wui-swiper-tabs .wui-inner-active").removeClass('wui-inner-active');
        $(this).addClass('wui-inner-active');
        tabsSwiper.swipeTo($(this).index());
        myscroll=new iScroll(tabsSwiper.activeSlide(),{hScrollbar:false});
    });

    $('.xa-find_group').on('touchstart', function(e){
        var $el = $(e.target);
		var recordId = $el.data('id');
        getDynamicData(recordId);
    });
    $('.xa-all_groups_can_join').on('touchstart', function(){
        $('.xui-all_groups_can_join-slide').removeClass('none');
        $('.xui-all_groups_can_join-list').addClass('none');
    });
});

function getDynamicData(recordId){
    W.getApi().call({
        app: 'm/apps/group',
        resource: 'm_group',
        method: 'get',
        args: {
            webapp_owner_id: W.webappOwnerId,
            id: recordId
        },
        success: function(data) {
            console.log(data);
            $('.xui-all_groups_can_join-slide').addClass('none');
            $('.xui-all_groups_can_join-list').removeClass('none');
            var tpl = new Template($('#tpl').html());
            var s = tpl.render({
                date: 20150101,
                user: {
                    id: 'A-000&001',
                    company: 'AT&T'
                }
            });
            console.log(s);
            $('.xa-all_groups_can_join-list').html(s);

        },
        error: function(data) {
            if(data.errMsg == 'is_deleted'){
                deletedRecord();
            }else{
                if(data.errMsg == 'is_run_out'){
                    openRunoutWin();
                }else{
                    wuiAlert(data.errMsg)
                }
            }
        }
    });
}

//模板引擎
function Template(tpl) {
    var
        fn,
        match,
        code = ['var r=[];\nvar _html = function (str) { return str.replace(/&/g, \'&amp;\').replace(/"/g, \'&quot;\').replace(/\'/g, \'&#39;\').replace(/</g, \'&lt;\').replace(/>/g, \'&gt;\'); };'],
        re = /\{\s*([a-zA-Z\.\_0-9()]+)(\s*\|\s*safe)?\s*\}/m,
        addLine = function (text) {
            code.push('r.push(\'' + text.replace(/\'/g, '\\\'').replace(/\n/g, '\\n').replace(/\r/g, '\\r') + '\');');
        };
    while (match = re.exec(tpl)) {
        if (match.index > 0) {
            addLine(tpl.slice(0, match.index));
        }
        if (match[2]) {
            code.push('r.push(String(this.' + match[1] + '));');
        }
        else {
            code.push('r.push(_html(String(this.' + match[1] + ')));');
        }
        tpl = tpl.substring(match.index + match[0].length);
    }
    addLine(tpl);
    code.push('return r.join(\'\');');
    fn = new Function(code.join('\n'));
    this.render = function (model) {
        return fn.apply(model);
    };
}

</script>
{% endblock %}
