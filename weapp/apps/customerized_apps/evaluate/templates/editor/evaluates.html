{% extends "content_base_v2.html" %}
{% load apps_filter %}
{% block css %}
<style type="text/css">
.exportProgress_msg,#downloadLink{
    margin-right:0!important;
}
.edui-default{
    z-index: 9999!important;
}
.edui-mask{
    display: none;
}
a{
    cursor: pointer;
}
.modal-body .fl > div{
    margin-bottom: 5px;
}
.xui-modal-content{
    overflow:hidden;
    margin-top:10px;
}
.xui-app_evaluate-Dialog .modal-body{
    padding:0 30px;
}
.xui-evaluate-modalLef{
    width:50%;
    box-sizing:border-box;
    border-right:1px solid #e1e1e1;
    padding-bottom: 20px;
}
.xui-evaluate-comment{
    display:inline-block;width:330px;
}
.xui-evaluate-modalRig{
    width:50%;
    box-sizing:border-box;
    padding-left:10px;
}
.xui-evalute-btnGroups{
    border-bottom:2px solid #e1e1e1;
    padding-bottom:15px;
    text-align:center;
    margin-bottom:20px;
    margin-top:15px;
}
.xui-evalute-btnGroups > a{
    font-weight:bold;
    border-radius:3px;
}
.xui-evalute-modalFooter{
    background:#eaeef7;
    margin-top:10px;
    height:50px;
    line-height:50px;
}
.xui-evaluate-table{
    margin-top: 20px;
    margin-bottom: 0;
}
.xui-evaluate-table > tbody> tr > td{
    text-align: left;
}
.xui-evaluate-table > tbody > tr > td:last-child{
    width: 70%;
}
</style>
{% endblock %}
{% block content-panel %}
<div class="xui-productsPage">
    <div class="relative">
        <ul class="breadcrumb">
            <li>您当前所在位置</li>
            <li><a href="/mall2/product_list/?shelve_type=1">商品管理</a></li>
            <li class="active">评价管理</li>
        </ul>
    </div>
    <div class="xa-productReviewFilterView xui-filterPanel"></div>

    <div class="panel panel-default mt20 xb-rightPanel">
        <div class="panel-header clearfix">
            <a href="javascript: void 0" class="btn btn-default fr ml10 mr10 mt10 xa-export">
				下载导出文件
			</a>
			<a href="/apps/evaluate/evaluate/" class="btn btn-default fr ml10 mt10">
				评价模版
			</a>
            <a href="/apps/evaluate/evaluate_relations/" class="btn btn-default fl ml10 mt10">
				评价关联
			</a>

		</div>
        <div
            data-ui-role="advanced-table"
            data-app="apps/evaluate"
            data-resource="evaluates"
            data-template-id="#products-review"
            data-enable-paginator="true"
            data-enable-sort="false"
            data-selectable="true"
            data-item-count-per-page="18"
            data-outer-selecter=".xa-selectAll"
            data-disable-header-select="true"
            class="panel-body"
        ></div>
        <div style="height:30px;"></div>
        <div class="xui-batchbtn">
            <label for="bottomSelectAll" class="xui-selectAll ml12">
                <input type="checkbox" id="bottomSelectAll" class="xa-selectAll">全选
            </label>
            <a href="javascript:void(0);" class="btn btn-default ml10 xa-batchPass">通过</a>
            <a href="javascript:void(0);" class="btn btn-default ml10 xa-batchShield">屏蔽</a>
        </div>
    </div>
</div>
{% endblock %}


{% block js %}
<!-- *start_prunt_task* -->
    <!-- [prunt_task] 
      {
        "task": "weizoom-load-app-views-dialogs"
      }
    -->
{{ "evaluate"|load_app_views_and_dialogs|safe }}
<!-- *end_prunt_task* -->
{% verbatim %}
<script id="products-review" type="text/x-jquery-tmpl">
    <table id="productReviewListTable" class="table table-bordered table-condensed xb-stripedTable xb-noTdBorder xb-noBottom xb-noBorder xb-theadBg">
        ${data.stickied_count}
        <thead>
          <th width="90">商品编码</th>
          <th width="130" style="text-align:left;">商品名称</th>
          <th width="95" style="text-align:left;">用户名</th>
          <th width="150" >评价时间</th>
          <th width="190" style="text-align:left;">评价内容</th>
          <th width="65">商品评星</th>
          <th width="100">状态</th>
          <th width="80">操作</th>
        </thead>
        <tbody id='product_review_list'>
        {{each(i, review) items}}
        <tr data-id="${review.id}">
            <td width="90">${review.product_user_code}</td>
            <td width="130" style="text-align:left;">${review.product_name}</td>
            <td width="95" style="text-align:left;">{{html review.user_name}}</td>
            <td width="150">${review.created_at}</td>
            <td width="190" style="text-align:left;"><div style="overflow: hidden;text-overflow: ellipsis;white-space: nowrap;width:190px;">${review.content}</div></td>
            <td width="65">${review.product_score}星</td>
            <td width="100">${review.status.name}</td>
            <td width="80">
                {{if review.status.value === '0'}}
                    <a href="javascript:void(0);" data-product-review-id="${review.id}" class="xa-verify">审核</a>
                {{/if}}
                {{if review.status.value === '1'}}
                    <a href="javascript:void(0);" data-product-review-id="${review.id}" class="xa-verify">修改</a>&nbsp;&nbsp;
                    <a href="javascript:void(0);" class="xa-modify" data-product-review-id="${review.id}" data-status="2">置顶</a>
                {{/if}}
                {{if review.status.value === '2'}}
                    <a href="javascript:void(0);" data-product-review-id="${review.id}" class="xa-verify">修改</a><br>
                    <a href="javascript:void(0);" class="xa-modify" data-product-review-id="${review.id}" data-status="1">取消置顶</a>
                {{/if}}
                {{if review.status.value === '-1'}}
                    <a href="javascript:void(0);" data-product-review-id="${review.id}" class="xa-verify">修改</a>
                {{/if}}
            </td>
        </tr>
        {{/each}}

        </tbody>
    </table>
</script>
{% endverbatim %}

<script type="text/javascript">
$(document).ready(function(){
    var view = new W.view.mall.ProductReviewListView({
        el: '.xui-productsPage'
    });
    view.render();


    $('.panel-body').delegate('.xa-export', 'click', function(event){
        W.getApi().call({
            app: 'export_job',
            resource: 'export_is_download',
            method: 'get',
            args: {
                woid: woid,
                type: 2,
            },
            success: function(data) {
                if (data["status"] === 1 && data["is_download"] === 0){
                    W.showHint('error', '导出的文件尚未下载，请刷新页面进行下载！');
                }
                else if(data["status"] === 0 && data["is_download"] === 0){
                    W.showHint('success', '文件正在导出，请刷新页面进行查看！');

                }
                else{
                    var url ='';
                    var filter_value = '';
                    if (view.filterView.filterValue) {
                        filter_value = view.filterView.filterValue;
                    };
                    var options = {
                        el: '.panel-body',
                        topic_id: '',
                        type: 2,
                        url: url,
                        jobId:0,
                        filter_value:filter_value,
                        isAlreadyExport : true,
                        app: 'mall2',
                        resource: 'export_file_param',
                        timelinesOptions: {

                        }
                    }
                    var customersView = new W.CustomersView(options);
                }
            },
            error: function(response) {
                W.showHint('error', '网络超时，导出中断，请重试！');
            }
        });

    });

    var table = $('div[data-ui-role="advanced-table"]').data('view');


    var export2data = {{export2data|safe}};
    var woid = "{{ request.manager.id }}";
    if(export2data["status"] ===1 && export2data["is_download"] ===0 ){
        table.afterload = function(){
            var options = {
                el: '.div_export',
                topic_id: '',
                type: 2,
                url: "",
                jobId:export2data["id"],
                isAlreadyExport : true,
                timelinesOptions: {
                }
            }
            var exportFileView = new W.dialog.ExportFileView(options);
            exportFileView.finish();
        };
    }
    else if(export2data["status"] ===0 && export2data["is_download"] ===0 ){
        table.afterload = function(){

            var jobId = export2data["id"];
            var options = {
                el: '.div_export',
                topic_id: '',
                type: 2,
                url: "",
                jobId:export2data["id"],
                isAlreadyExport : true,
                timelinesOptions: {
                }
            }
            var exportFileView = new W.dialog.ExportFileView(options);
            exportFileView.doExportAfterApi();
        };
    };

    $('.panel-body').delegate('.xa-verify','click',function(){
        var product_review_id = $(this).attr('data-product-review-id');
        W.dialog.showDialog('W.dialog.app.evaluate.ViewParticipanceDataDialog',{
            product_review_id: product_review_id,
            success: function(data) {
                // alert(data);
            }
        });
    });
})
</script>
{% endblock %}
